<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <!-- Prevent caching -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Training Report</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>
  <style>
    body { margin:0; padding:0; font-family:'Segoe UI',sans-serif; background:#fff; color:#333; }
    /* Per‑program banner */
    .program-banner {
      background: #e6f2f3;
      padding: 30px;
      margin-bottom: 40px;
      border-left: 6px solid #007c91;
    }
    .program-banner .title {
      font-size: 28px;
      color: #007c91;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .program-banner .meta {
      font-size: 16px;
      margin: 4px 0;
    }
    /* Report content */
    #reportContent { padding: 30px; }
    .section-title { font-size:32px; color:#337d88; margin:60px 0 20px; border-bottom:2px solid #ccc; padding-bottom:10px; }
    .chart-container { height:400px; margin-bottom:60px; }
    .turma-title { font-size:22px; font-weight:bold; margin:20px 0 10px; color:#007c91; }
    .text-question { border:1px solid #007c91; border-left:6px solid #007c91; padding:16px; margin-bottom:30px; background:#f9f9f9; }
    .text-question-title { font-weight:bold; margin-bottom:8px; font-size:16px; color:#007c91; }
    ul { padding-left:20px; }
  </style>
</head>
<body>
  <div id="reportContent"></div>

  <script>
    async function loadReport() {
      const filters = JSON.parse(localStorage.getItem('reportFilters') || '{}');
      const [data, meta] = await Promise.all([
        fetch('https://fidalgom4t.github.io/reportfinal/data.json').then(r=>r.json()),
        fetch('https://fidalgom4t.github.io/reportfinal/meta.json').then(r=>r.json())
      ]);

      const programs = filters.programs || [];
      const container = document.getElementById('reportContent');
      container.innerHTML = '';

      // Build lookup maps
      const labelMap = createLabelMap(meta.labels);
      const sortMap  = createSortMap(meta.labels);

      // For each selected program
      programs.forEach(prog => {
        const progMeta = meta.titles.find(t=>t.program_id===prog) || {};

        // Filter all rows for this program + client + turmas
        const rowsAll = data.filter(d=>
          d.client===filters.client &&
          d.program===prog &&
          (filters.turmas||[]).includes(d.turma)
        );

        // Compute scope start/end automatically if not overridden
        const start = filters.start
          ? formatMonthYearString(filters.start)
          : formatMonthYear(getExtremeDate(rowsAll,'assessment','min'));
        const end   = filters.end
          ? formatMonthYearString(filters.end)
          : formatMonthYear(getExtremeDate(rowsAll,'evaluation','max'));

        // Count total responses (all rows)
        const totalResponses = rowsAll.length;

        // --- Program banner ---
        const banner = document.createElement('div');
        banner.className = 'program-banner';
        banner.innerHTML = `
          <div class="title">${progMeta["TÍTULO"]||prog}</div>
          <div class="meta"><strong>Formador:</strong> ${filters.trainer||'N/A'}</div>
          <div class="meta"><strong>Scope temporal:</strong> ${start} – ${end}</div>
          <div class="meta"><strong>Total de respostas:</strong> ${totalResponses}</div>
        `;
        container.appendChild(banner);

        // Then render Assessment & Evaluation
        ['assessment','evaluation'].forEach(key => {
          const sectionName = key==='assessment' ? 'Assessment' : 'Avaliação do Programa';
          // section heading
          const h = document.createElement('div');
          h.className = 'section-title';
          h.textContent = sectionName;
          container.appendChild(h);

          // Numeric‐only rows for this section
          const sectionRows = rowsAll.filter(d=>
            String(d.section||'').toLowerCase().includes(key) &&
            /^-?\d+(\.\d+)?$/.test(String(d.value||'').trim())
          );

          // Global chart
          if ((filters.turmas||[]).length>1 && sectionRows.length) {
            createBarChart(`Global (${sectionName})`, computeAverages(sectionRows,labelMap,sortMap), container);
          }

          // Per‑turma charts
          const byTurma = groupBy(sectionRows,'turma');
          Object.entries(byTurma).forEach(([turma,vals])=>{
            const tdiv = document.createElement('div');
            tdiv.className = 'turma-title';
            tdiv.textContent = `Turma: ${turma}`;
            container.appendChild(tdiv);
            createBarChart(turma, computeAverages(vals,labelMap,sortMap), container);
          });

          // Open‑ended
          const textRows = rowsAll.filter(d=>
            String(d.section||'').toLowerCase().includes(key) &&
            !/^-?\d+(\.\d+)?$/.test(String(d.value||'').trim()) &&
            (filters.textQuestions||[]).includes(d.question)
          );
          renderTextQuestions(textRows, container);
        });
      });
    }

    // Helpers (same as before)...

    function getExtremeDate(rows, sectionKey, mode) {
      const ds = rows
        .filter(d=>String(d.section||'').toLowerCase().includes(sectionKey) && (d.date||d.submitted_at))
        .map(d=>new Date(d.date||d.submitted_at));
      if (!ds.length) return null;
      return mode==='min'
        ? new Date(Math.min(...ds))
        : new Date(Math.max(...ds));
    }

    function formatMonthYear(dt) {
      if (!dt) return 'N/A';
      return dt.toLocaleDateString('pt-PT',{month:'long',year:'numeric'});
    }

    function formatMonthYearString(s) {
      const [y,m] = s.split('-').map(Number);
      return new Date(y,m-1,1).toLocaleDateString('pt-PT',{month:'long',year:'numeric'});
    }

    function createLabelMap(labels) {
      const m={};
      labels.forEach(l=>{
        const q=l.questionId||l["QUESTION ID"];
        m[q]=l.label||l["LABEL"];
      });
      return m;
    }

    function createSortMap(labels) {
      const m={};
      labels.forEach(l=>{
        const q=l.questionId||l["QUESTION ID"];
        m[q]=+(l.sortOrder||l["SORT ORDER"]||l.sort_order);
      });
      return m;
    }

    function groupBy(arr,key) {
      return arr.reduce((acc,i)=>(acc[i[key]]||(acc[i[key]]=[])).push(i)&&acc,{});
    }

    function computeAverages(rows,labelMap,orderMap) {
      const g={};
      rows.forEach(({question,value})=> {
        (g[question]||(g[question]=[])).push(+value);
      });
      const out=Object.entries(g).map(([q,vals])=>{
        const avg=vals.reduce((a,b)=>a+b,0)/vals.length;
        return { question:q, label:labelMap[q]||q, avg:+avg.toFixed(1) };
      });
      out.sort((a,b)=>(orderMap[a.question]||0)-(orderMap[b.question]||0));
      return out;
    }

    function createBarChart(title,data,container) {
      const el=document.createElement('div'); el.className='chart-container';
      container.appendChild(el);
      echarts.init(el).setOption({
        title:{text:title,left:'center',textStyle:{fontSize:18}},
        tooltip:{},
        xAxis:{type:'category',data:data.map(d=>d.label),axisLabel:{rotate:30}},
        yAxis:{type:'value',min:0,max:5},
        series:[{type:'bar',data:data.map(d=>d.avg),
          label:{show:true,position:'top',formatter:'{c}'},
          itemStyle:{color(p){const v=p.value;if(v<3)return'#d94e5d';if(v<4)return'#f2c037';return'#61c277'}}
        }]
      });
    }

    function renderTextQuestions(rows,container){
      const byQ=groupBy(rows,'question');
      Object.entries(byQ).forEach(([q,ans])=>{
        const box=document.createElement('div'); box.className='text-question';
        const t=document.createElement('div'); t.className='text-question-title'; t.textContent=q;
        box.appendChild(t);
        const ul=document.createElement('ul');
        ans.forEach(a=>{const li=document.createElement('li');li.textContent=a.value;ul.appendChild(li)});
        box.appendChild(ul);
        container.appendChild(box);
      });
    }

    loadReport();
  </script>
</body>
</html>
