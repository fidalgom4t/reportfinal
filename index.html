<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Generate Report</title>
  <style>
    :root {
      --primary: #007c91;
      --bg: #f5f5f5;
      --card: #fff;
      --border: #ccc;
      --radius: 6px;
      --gap: 12px;
      --text-secondary: #555;
    }
    *, *::before, *::after { box-sizing: border-box; }

    body {
      margin: 40px auto;
      padding: 0 var(--gap);
      max-width: 900px;
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg);
      color: #333;
    }

    h2 {
      text-align: center;
      color: var(--primary);
      margin-bottom: var(--gap);
    }

    form {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--gap);
      margin-bottom: var(--gap);
    }

    .checkbox-list {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: var(--gap);
    }

    .checkbox-list label {
      font-weight: bold;
      color: var(--primary);
      margin-bottom: 8px;
      display: block;
    }

    .styled-checkbox-list {
      list-style: none;
      margin: 0;
      padding: 0;
      max-height: 160px;
      overflow-y: auto;
    }

    .styled-checkbox-list li {
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .styled-checkbox-list span.option-label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      flex: 1;
      font-size: 0.95rem;
    }

    .styled-checkbox-list input[type="checkbox"] {
      margin-right: 4px;
    }

    .select-all-btn {
      background: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
      padding: 4px 8px;
      margin-bottom: 8px;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 0.85rem;
    }

    .select-all-btn:hover {
      background: rgba(0, 124, 145, 0.06);
    }

    .archive-btn {
      border: 1px solid var(--border);
      background: #f7f7f7;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.85rem;
      cursor: pointer;
      color: var(--text-secondary);
      white-space: nowrap;
    }

    .archive-btn:hover {
      background: #ffe9c7;
      border-color: #f0b15c;
      color: #b36a00;
    }

    .actions {
      text-align: center;
      margin-top: var(--gap);
    }

    button#viewReport {
      padding: 10px 24px;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 1rem;
    }

    button#viewReport:disabled {
      background: #999;
      cursor: not-allowed;
    }

    .dynamic-block {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: var(--gap);
      margin-bottom: var(--gap);
    }

    .dynamic-block h3,
    .dynamic-block h4 {
      color: var(--primary);
      margin: 0 0 var(--gap) 0;
      font-weight: bold;
    }

    .dynamic-block label {
      display: block;
      margin-bottom: 6px;
      font-weight: normal;
      color: #333;
    }

    .dynamic-block input[type="text"],
    .dynamic-block input[type="month"] {
      width: calc(100% - 12px);
      padding: 6px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 1rem;
      margin-bottom: var(--gap);
    }

    .dynamic-block .styled-checkbox-list,
    .dynamic-block ol {
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .dynamic-block ol li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 6px;
    }

    .dynamic-block ol li span.option-label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      flex: 1;
    }

    .dynamic-block input[type="checkbox"] {
      margin-right: 4px;
    }

    .info-archived {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .archived-pill {
      display: inline-block;
      background: #ffe9c7;
      color: #b36a00;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.75rem;
      margin-right: 4px;
      margin-top: 2px;
    }
  </style>
</head>

<body>
  <h2>Generate Report</h2>

  <form id="filtersForm" onsubmit="return false;">
    <div class="checkbox-list">
      <label>Cliente</label>
      <ul id="clientList" class="styled-checkbox-list"></ul>
    </div>
    <div class="checkbox-list">
      <label>Programas</label>
      <button id="selectAllPrograms" class="select-all-btn" type="button">Selecionar Todos</button>
      <ul id="programList" class="styled-checkbox-list"></ul>
    </div>
    <div class="checkbox-list">
      <label>Data</label>
      <button id="selectAllInfos" class="select-all-btn" type="button">Selecionar Todos</button>
      <ul id="infoList" class="styled-checkbox-list"></ul>
    </div>
  </form>

  <div id="dynamicBlocks"></div>

  <div class="actions">
    <button id="viewReport" disabled>Ver Relat√≥rio</button>
  </div>

  <script>
    /**********************************************
     * 1) CONFIG GERAL + ARQUIVOS NO GITHUB
     **********************************************/
    const WEBAPP_URL =
      "https://script.google.com/a/macros/mind4time.com/s/AKfycbyOIdN-kMoznVUywAWu1-VWWFT9pnosM4aflDtD4-k_ZAaTtGI2LVShsqqGDEf6DkgJ5Q/exec";

    // >>>>> CONFIGURAR PARA O TEU REPO GITHUB <<<<<
    const GH_OWNER  = "fidalgom4t";          // ex: "mind4time"
    const GH_REPO   = "reportfinal";               // ex: "training-report"
    const GH_PATH   = "archived.json";          // caminho do ficheiro na ra√≠z (ou "data/archived.json")
    const GH_BRANCH = "testing-2.0";             // branch onde gravar (normalmente "main" ou "master")
    const GH_TOKEN  = "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";         // ‚ö† N√ÉO COMITAR EM REPO P√öBLICO

    let data = [];
    let archived = { clients: [], programs: [], turmas: [] };

    /**********************************************
     * 2) LOCALSTORAGE PARA FILTROS (J√Å EXISTENTE)
     **********************************************/
    function loadFilters() {
      return JSON.parse(localStorage.getItem("filters") || "{}");
    }

    function saveFilters(f) {
      localStorage.setItem("filters", JSON.stringify(f));
    }

    function updateFilter(key, val) {
      const f = loadFilters();
      f[key] = val;
      saveFilters(f);
    }

    /**********************************************
     * 3) CARREGAR DATA + ARCHIVED.JSON
     **********************************************/
    async function init() {
      // reset minimal (n√£o queremos restos velhos de clients/programs/clientInfos)
      const f = loadFilters() || {};
      delete f.clients;
      delete f.programs;
      delete f.clientInfos;
      saveFilters(f);

      await fetchDataAndInitUI();
    }

    async function fetchDataAndInitUI() {
      try {
        data = await fetch("data.json").then((r) => r.json());
      } catch (e) {
        console.error(e);
        alert("Erro ao carregar dados (data.json).");
        return;
      }

      // Tentar carregar archived.json (se n√£o existir, usamos vazio)
      try {
        archived = await fetch("archived.json").then((r) => r.json());
      } catch (e) {
        console.warn("N√£o foi poss√≠vel carregar archived.json, a usar vazio.", e);
        archived = { clients: [], programs: [], turmas: [] };
      }

      populateClients();
      initFilters();
      attachSelectAll();
    }

    function isArchived(type, value) {
      if (!archived || !archived[type]) return false;
      return archived[type].includes(value);
    }

    /**********************************************
     * 4) SELECT ALL / UI BASICA
     **********************************************/
    function attachSelectAll() {
      document.getElementById("selectAllPrograms").onclick = () => {
        const cbs = document.querySelectorAll("#programList input[type='checkbox']");
        const vals = [];
        cbs.forEach((cb) => {
          cb.checked = true;
          vals.push(cb.value);
        });
        updateFilter("programs", vals);

        const client = loadFilters().clients?.[0];
        updateInfoList(client);
        refreshDynamic();
      };

      document.getElementById("selectAllInfos").onclick = () => {
        const cbs = document.querySelectorAll("#infoList input[type='checkbox']");
        const vals = [];
        cbs.forEach((cb) => {
          cb.checked = true;
          vals.push(cb.value);
        });
        updateFilter("clientInfos", vals);
        refreshDynamic();
      };
    }

    /**********************************************
     * 5) CLIENTES / PROGRAMAS / INFOS
     **********************************************/
    function populateClients() {
      const clients = [...new Set(data.map((d) => d.client))].sort();
      const list = document.getElementById("clientList");
      list.innerHTML = "";

      clients
        .filter((c) => !isArchived("clients", c))
        .forEach((c) =>
          createListItem(list, c, "clients", initFilters, "clients")
        );
    }

    function populateList(id, items, key, cb, archiveType = null) {
      const list = document.getElementById(id);
      list.innerHTML = "";

      items
        .filter((v) => !archiveType || !isArchived(archiveType, v))
        .forEach((i) => createListItem(list, i, key, cb, archiveType));
    }

    function createListItem(container, text, key, onChange, archiveType) {
      const li = document.createElement("li");

      const labelSpan = document.createElement("span");
      labelSpan.className = "option-label";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.value = text;
      cb.checked = (loadFilters()[key] || []).includes(text);
      cb.onchange = () => {
        const vals = Array.from(
          container.querySelectorAll("input[type='checkbox']:checked")
        ).map((i) => i.value);
        updateFilter(key, vals);
        onChange();
      };

      const txt = document.createTextNode(text);
      labelSpan.append(cb, txt);

      li.appendChild(labelSpan);

      if (archiveType) {
        const archBtn = document.createElement("button");
        archBtn.className = "archive-btn";
        archBtn.type = "button";
        archBtn.textContent = "üóÑ arquivar";
        archBtn.title = "Arquivar este item (deixa de aparecer na lista)";
        archBtn.onclick = () => archiveItem(archiveType, text);
        li.appendChild(archBtn);
      }

      container.appendChild(li);
    }

    function initFilters() {
      const f = loadFilters();
      const client = f.clients?.[0];

      const programItems =
        client
          ? [...new Set(
              data.filter((d) => d.client === client).map((d) => d.program)
            )].sort()
          : [];

      populateList(
        "programList",
        programItems,
        "programs",
        () => {
          updateInfoList(client);
          refreshDynamic();
        },
        "programs"
      );

      updateInfoList(client);
      refreshDynamic();
    }

    function updateInfoList(client) {
      const f = loadFilters();
      const progs = f.programs || [];

      const infos =
        client && progs.length
          ? [...new Set(
              data
                .filter(
                  (d) => d.client === client && progs.includes(d.program)
                )
                .map((d) => d.client_info)
            )].sort()
          : [];

      // para infos n√£o vamos arquivar (apenas clients/programs/turmas)
      populateList("infoList", infos, "clientInfos", refreshDynamic, null);
    }

    /**********************************************
     * 6) CAMPOS DIN√ÇMICOS (FORMADOR / PER√çODO / TURMAS)
     **********************************************/
    function createInputField(label, prog, key) {
      const w = document.createElement("div");
      const l = document.createElement("label");
      l.textContent = label;

      const i = document.createElement("input");
      i.type = "text";
      i.value = (loadFilters()[key] || {})[prog] || "";
      i.oninput = (e) => {
        const o = loadFilters()[key] || {};
        o[prog] = e.target.value;
        updateFilter(key, o);
      };

      w.append(l, i);
      return w;
    }

    function createMonthField(label, prog, key) {
      const w = document.createElement("div");
      const l = document.createElement("label");
      l.textContent = label;

      const i = document.createElement("input");
      i.type = "month";
      i.value = (loadFilters()[key] || {})[prog] || "";
      i.onchange = (e) => {
        const o = loadFilters()[key] || {};
        o[prog] = e.target.value;
        updateFilter(key, o);
      };

      w.append(l, i);
      return w;
    }

    function refreshDynamic() {
      const f = loadFilters();
      const client = f.clients?.[0];
      const progs = f.programs || [];
      const infos = f.clientInfos || [];

      const db = document.getElementById("dynamicBlocks");
      const vb = document.getElementById("viewReport");

      vb.disabled = !client || !progs.length || !infos.length;

      db.innerHTML = "";
      if (!client || !progs.length || !infos.length) return;

      progs.forEach((p) => db.appendChild(renderBlock(client, p, infos)));
    }

    function renderBlock(client, program, infos) {
      const block = document.createElement("div");
      block.className = "dynamic-block";

      const h3 = document.createElement("h3");
      h3.textContent = `Programa: ${program}`;
      block.appendChild(h3);

      block.appendChild(createInputField("Formador", program, "trainers"));
      block.appendChild(createMonthField("In√≠cio", program, "starts"));
      block.appendChild(createMonthField("Fim", program, "ends"));

      // turmas para este client/program/infos
      const turmas = [
        ...new Set(
          data
            .filter(
              (d) =>
                d.client === client &&
                d.program === program &&
                infos.includes(d.client_info)
            )
            .map((d) => d.turma)
        ),
      ].filter((t) => !isArchived("turmas", t));

      block.appendChild(
        buildCheckboxGroup("Turmas", turmas, `turmas_${program}`, "turmas")
      );

      return block;
    }

    function buildCheckboxGroup(label, opts, key, archiveType) {
      const w = document.createElement("div");
      const t = document.createElement("h4");
      t.textContent = label;
      w.appendChild(t);

      const info = document.createElement("div");
      info.className = "info-archived";
      info.textContent = "(podes arquivar turmas que j√° n√£o queiras ver)";
      w.appendChild(info);

      const ol = document.createElement("ol");
      opts.forEach((o) => {
        const li = document.createElement("li");

        const span = document.createElement("span");
        span.className = "option-label";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.value = o;
        cb.checked = (loadFilters()[key] || []).includes(o);
        cb.onchange = () => {
          const v = Array.from(
            ol.querySelectorAll("input[type='checkbox']:checked")
          ).map((i) => i.value);
          updateFilter(key, v);
        };

        const labelText = document.createTextNode(o);
        span.append(cb, labelText);

        const archBtn = document.createElement("button");
        archBtn.className = "archive-btn";
        archBtn.type = "button";
        archBtn.textContent = "üóÑ arquivar";
        archBtn.onclick = () => archiveItem(archiveType, o);

        li.append(span, archBtn);
        ol.appendChild(li);
      });

      w.appendChild(ol);
      return w;
    }

    /**********************************************
     * 7) ARQUIVAR (GitHub - archived.json)
     **********************************************/
    async function archiveItem(typeKey, value) {
      if (!confirm(`Arquivar "${value}"? Deixar√° de aparecer nas listas por defeito.`)) {
        return;
      }

      if (!archived[typeKey]) archived[typeKey] = [];
      if (!archived[typeKey].includes(value)) {
        archived[typeKey].push(value);
      }

      try {
        await saveArchivedToGitHub();
        // Rebuild UI com nova lista de arquivados
        await fetchDataAndInitUI();
        alert(`"${value}" arquivado com sucesso.`);
      } catch (e) {
        console.error(e);
        alert("Erro ao arquivar no GitHub. Ver consola para detalhes.");
      }
    }

    async function saveArchivedToGitHub() {
      if (!GH_OWNER || !GH_REPO || !GH_PATH || !GH_TOKEN) {
        throw new Error("Configura√ß√£o GitHub incompleta (OWNER/REPO/PATH/TOKEN).");
      }

      const url = `https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/contents/${GH_PATH}`;

      // 1) Obter sha atual (se existir)
      let sha = null;
      try {
        const res = await fetch(url, {
          headers: {
            Authorization: `token ${GH_TOKEN}`,
            Accept: "application/vnd.github+json",
          },
        });
        if (res.ok) {
          const info = await res.json();
          sha = info.sha;
        }
      } catch (e) {
        console.warn("N√£o foi poss√≠vel obter SHA de archived.json (pode ser 1¬™ vez).", e);
      }

      // 2) Preparar conte√∫do novo
      const contentString = JSON.stringify(archived, null, 2);
      const encodedContent = btoa(unescape(encodeURIComponent(contentString)));

      const body = {
        message: "Update archived filters via UI",
        content: encodedContent,
        branch: GH_BRANCH,
      };
      if (sha) body.sha = sha;

      const putRes = await fetch(url, {
        method: "PUT",
        headers: {
          Authorization: `token ${GH_TOKEN}`,
          Accept: "application/vnd.github+json",
          "Content-Type": "application/json",
        },
        body: JSON.stringify(body),
      });

      if (!putRes.ok) {
        const txt = await putRes.text();
        throw new Error("Falha ao gravar archived.json: " + txt);
      }
    }

    /**********************************************
     * 8) APLICAR E ABRIR REPORT
     **********************************************/
    function applyAndGo(download) {
      const all = loadFilters();
      // Mantemos este comportamento: guardamos filtros em localStorage
      localStorage.setItem("reportFilters", JSON.stringify(all));
      window.location.href = "report.html";
    }

    /**********************************************
     * 9) EVENTOS
     **********************************************/
    document.addEventListener("DOMContentLoaded", () => {
      init();
      document
        .getElementById("viewReport")
        .addEventListener("click", () => applyAndGo(false));
    });
  </script>
</body>
</html>
