<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8"/>
  <title>Training Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!-- Roboto font -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap" rel="stylesheet">
  <!-- ECharts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <!-- pdfMake -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <style>
    /* Apply Roboto globally */
    body, .page, .header, .footer, .hero-content, .banner-box,
    .chart-fullpage, .chart-grid, .text-page, .text-question {
      font-family: 'Roboto', sans-serif;
    }
    @page { size: 11in 8.5in; margin: 0; }
    @media print { .page { page-break-after: always; } }

    .page {
      position: relative;
      width: 100vw; height: 100vh;
      box-sizing: border-box;
      padding-top: 80px;
      padding-bottom: 60px;
      overflow: visible;
    }
    .header, .footer {
      position: absolute; left:0; right:0;
      display: flex; justify-content: space-between; align-items: center;
      background: #fff; padding: 0 30px; box-sizing: border-box; z-index:2;
    }
    .header { top:0; height:80px; border-bottom:1px solid #40a3a3; }
    .header img { height:60px; }
    .footer { bottom:0; height:60px; font-size:14px; color:#007c91; border-top:1px solid #40a3a3; }

    .hero {
      position: relative;
      display:flex; align-items:center; justify-content:center; text-align:center; color:#fff;
    }
    .hero .bg {
      position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; z-index:0;
    }
    .hero-content {
      position:relative; z-index:1;
      max-width:80%;
      display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%;
    }
    .hero-content small { font-style:italic; color:#e0f2f3; margin-bottom:8px; font-size:1.2rem; }
    .hero-content h1 { font-size:4rem; margin:0; font-weight:600; }
    .hero-content .subtitle { font-size:1.8rem; margin-top:12px; }
    .hero-content .meta { margin-top:24px; display:flex; gap:40px; justify-content:center; font-size:1.2rem; }
    .hero-content .meta span { display:block; font-style:italic; color:#e0f2f3; }
    .hero-content .meta strong { color:#fff; font-weight:600; }

    .banner { display:flex; align-items:center; justify-content:center; background:#fff; }
    .banner-box {
      background:#f0f8f9; padding:40px 60px; border-left:6px solid #007c91;
      box-shadow:0 2px 6px rgba(0,0,0,0.1); width:70%;
    }
    .banner-box h1 { margin:0 0 16px; font-size:48px; color:#007c91; }
    .banner-box .meta { display:flex; gap:40px; font-size:18px; color:#555; }

    .chart-fullpage { display:flex; align-items:center; justify-content:center; background:#fff; }
    .chart-full { width:90vw; height:80vh; }

    .chart-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows:
        calc((100vh - 80px - 60px - 40px)/2)
        calc((100vh - 80px - 60px - 40px)/2);
      gap: 30px;
      padding: 100px;
      box-sizing: border-box;
    }
    .chart-box { width:100%; height:100%; }

    .text-page {
      overflow: visible;
      background: #fff;
      box-sizing: border-box;
    }
    .text-question {
      border:1px solid #007c91; border-left:6px solid #007c91;
      width: 80vw; margin: 80px auto; padding: 24px 32px;
      background:#f9f9f9; box-sizing:border-box;
      page-break-inside: avoid; break-inside: avoid;
    }
    .text-question-title { font-size:18px; font-weight:bold; margin-bottom:12px; color:#007c91; }
    .text-question ul { padding-left:20px; font-size:16px; line-height:1.8; }
    .text-question li { margin-bottom: 12px; }

    /* PDF button */
    #gerar-pdf {
      position: fixed;
      top: 20px; right: 20px;
      z-index: 1000;
      padding: 10px 20px;
      background: #007c91;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- PDF generation trigger -->
  <button id="gerar-pdf">Gerar Relatório (PDF)</button>

  <!-- Your dynamic report -->
  <div id="report"></div>

  <script>
    // --- Helpers ---
    const currentYear = new Date().getFullYear();

    function createLabelMap(labels){ /*…*/ }
    function createSortMap(labels){ /*…*/ }
    function groupBy(arr,k){ /*…*/ }
    function computeAverages(rows,LM,OM){ /*…*/ }
    function createBarChart(div,title,data,uniform){ /*…*/ }
    function countUnique(rows,sec){ /*…*/ }
    function formatMonthYear(val){ /*…*/ }

    // --- Build Report into #report ---
    async function build() {
      // your existing build() logic goes here, unchanged…
      // it populates document.querySelector('#report') with .page elements
    }

    // --- PDF Generator via pdfMake ---
    async function generatePdf() {
      // give charts a moment to render/rescale
      await new Promise(r => setTimeout(r, 300));

      // capture images of each chart container
      const chartEls = document.querySelectorAll('.chart-full, .chart-box');
      const images = Array.from(chartEls).map(el => {
        const chart = echarts.getInstanceByDom(el);
        return chart.getDataURL({ pixelRatio: 2, backgroundColor: '#ffffff' });
      });

      // assemble pdfMake definition
      const docDefinition = {
        pageSize: 'A4',
        pageOrientation: 'landscape',
        pageMargins: [40, 60, 40, 60],
        footer: (currentPage, pageCount) => ({
          columns: [
            { text: `© MIND4TIME ${currentYear}`, alignment: 'left', fontSize: 8 },
            { text: `Página ${currentPage}/${pageCount}`, alignment: 'right', fontSize: 8 }
          ],
          margin: [40, 0, 40, 20]
        }),
        content: [],
        styles: {
          subheader: { fontSize:14, bold:true, margin:[0,10,0,5] }
        }
      };

      let imgIndex = 0;
      const pages = document.querySelectorAll('#report .page');
      pages.forEach((pageEl, idx) => {
        // full-chart pages
        if (pageEl.querySelector('.chart-full')) {
          docDefinition.content.push({ image: images[imgIndex++], width: 740 });
        }
        // grid pages
        else if (pageEl.querySelectorAll('.chart-box').length) {
          const cols = [];
          pageEl.querySelectorAll('.chart-box').forEach(() => {
            cols.push({ image: images[imgIndex++], width: 360, margin: [0,0,10,10] });
          });
          docDefinition.content.push({ columns: cols, columnGap: 10 });
        }
        // text pages
        else if (pageEl.querySelector('.text-question-title')) {
          const title = pageEl.querySelector('.text-question-title').innerText;
          const items = Array.from(pageEl.querySelectorAll('.text-question ul li')).map(li => li.innerText);
          docDefinition.content.push({ text: title, style: 'subheader' });
          docDefinition.content.push({ ul: items });
        }
        // page break after all but last
        if (idx < pages.length - 1) {
          docDefinition.content.push({ text: '', pageBreak: 'after' });
        }
      });

      // trigger download
      pdfMake.createPdf(docDefinition).download('report.pdf');
    }

    // --- Initialize ---
    document.addEventListener('DOMContentLoaded', async () => {
      await build();
      document.getElementById('gerar-pdf').onclick = generatePdf;
    });
  </script>
</body>
</html>
