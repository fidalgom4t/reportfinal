<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Selecionar Filtros</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f5f5f5;
      padding: 40px;
      max-width: 800px;
      margin: auto;
    }
    h2 {
      margin-bottom: 24px;
      color: #007c91;
    }
    form {
      display: grid;
      grid-template-columns: 200px 1fr;
      row-gap: 20px;
      column-gap: 20px;
      align-items: start;
    }
    label {
      font-weight: bold;
      align-self: center;
    }
    /* Dropdown‑multiselect */
    .dropdown-multiselect {
      position: relative;
      width: 100%;
    }
    .select-box {
      border: 1px solid #ccc;
      background: #fff;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      user-select: none;
      position: relative;
    }
    .select-box::after {
      content: '▾';
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 12px;
      color: #666;
    }
    .checkboxes {
      display: none;
      position: absolute;
      top: calc(100% + 4px);
      width: 100%;
      max-height: 180px;
      overflow-y: auto;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      z-index: 10;
    }
    .dropdown-multiselect.open .checkboxes {
      display: block;
    }
    .checkboxes label {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
      font-weight: normal;
      cursor: pointer;
    }
    .checkboxes label input {
      margin-right: 8px;
    }
    input[type="month"], input[type="text"] {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 100%;
      box-sizing: border-box;
    }
    .program-trainer {
      grid-column: span 2;
      display: grid;
      grid-template-columns: 200px 1fr;
      column-gap: 20px;
      margin-top: 10px;
    }
    .program-trainer input {
      margin-bottom: 10px;
    }
    .submit-row {
      grid-column: span 2;
      text-align: center;
      margin-top: 30px;
    }
    .link-button {
      display: inline-block;
      padding: 10px 30px;
      background: #007c91;
      color: #fff;
      text-decoration: none;
      font-weight: bold;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h2>Gerar Relatório Dinâmico</h2>
  <form id="filtersForm" onsubmit="return false;">
    <!-- Cliente -->
    <label for="clientWrapper">Cliente:</label>
    <div class="dropdown-multiselect" id="clientWrapper">
      <div class="select-box" data-placeholder="Selecionar cliente(s)"
           onclick="toggleDropdown('clientWrapper')">Selecionar cliente(s)</div>
      <div class="checkboxes" id="clientChecks"></div>
    </div>

    <!-- Programas -->
    <label for="programWrapper">Programas:</label>
    <div class="dropdown-multiselect" id="programWrapper">
      <div class="select-box" data-placeholder="Selecionar programa(s)"
           onclick="toggleDropdown('programWrapper')">Selecionar programa(s)</div>
      <div class="checkboxes" id="programChecks"></div>
    </div>

    <!-- Turmas -->
    <label for="turmaWrapper">Turmas:</label>
    <div class="dropdown-multiselect" id="turmaWrapper">
      <div class="select-box" data-placeholder="Selecionar turma(s)"
           onclick="toggleDropdown('turmaWrapper')">Selecionar turma(s)</div>
      <div class="checkboxes" id="turmaChecks"></div>
    </div>

    <!-- Perguntas Abertas -->
    <label for="textWrapper">Perguntas Abertas:</label>
    <div class="dropdown-multiselect" id="textWrapper">
      <div class="select-box" data-placeholder="Selecionar perguntas"
           onclick="toggleDropdown('textWrapper')">Selecionar perguntas</div>
      <div class="checkboxes" id="textQuestionSelect"></div>
    </div>

    <!-- Scope temporal -->
    <label for="startMonth">Scope temporal - Início:</label>
    <input type="month" id="startMonth" />

    <label for="endMonth">Scope temporal - Fim:</label>
    <input type="month" id="endMonth" />

    <!-- Placeholder for per-program trainers -->
    <div id="trainersContainer"></div>

    <!-- Submit -->
    <div class="submit-row">
      <a class="link-button" onclick="goToReport()">Ver Relatório</a>
    </div>
  </form>

  <script>
    let rawData = [];

    fetch('data.json')
      .then(r => r.json())
      .then(data => {
        rawData = data;
        initFilters();
      });

    function toggleDropdown(id) {
      document.querySelectorAll('.dropdown-multiselect').forEach(el => {
        if (el.id !== id) el.classList.remove('open');
      });
      document.getElementById(id).classList.toggle('open');
    }

    // Utility: fill checkboxes in a dropdown
    function fillChecks(checksId, items, stored, onChange) {
      const container = document.getElementById(checksId);
      container.innerHTML = '';
      items.forEach(val => {
        const lbl = document.createElement('label');
        const cb  = document.createElement('input');
        cb.type  = 'checkbox';
        cb.value = val;
        cb.checked = stored.includes(val);
        cb.onchange = () => {
          onChange();
          updateSelectText(checksId);
          if (checksId === 'programChecks') renderTrainerInputs();
        };
        lbl.appendChild(cb);
        lbl.appendChild(document.createTextNode(val));
        container.appendChild(lbl);
      });
      updateSelectText(checksId);
    }

    function updateSelectText(checksId) {
      const map = {
        clientChecks: 'clientWrapper',
        programChecks: 'programWrapper',
        turmaChecks: 'turmaWrapper',
        textQuestionSelect: 'textWrapper'
      };
      const wrapper = map[checksId];
      const box = document.querySelector(`#${wrapper} .select-box`);
      const vals = Array.from(document.getElementById(checksId)
                    .querySelectorAll('input:checked'))
                    .map(i=>i.value);
      box.textContent = vals.length
        ? vals.join(', ')
        : box.getAttribute('data-placeholder');
    }

    function getChecked(checksId) {
      return Array.from(document.getElementById(checksId)
        .querySelectorAll('input:checked')).map(i=>i.value);
    }

    function setFilter(key, val) {
      const s = JSON.parse(localStorage.getItem('filters')||'{}');
      s[key] = val;
      localStorage.setItem('filters', JSON.stringify(s));
    }
    function getFilter(key) {
      return JSON.parse(localStorage.getItem('filters')||'{}')[key] || [];
    }

    function initFilters() {
      // CLIENTES
      const clients = [...new Set(rawData.map(d=>d.client))].sort();
      fillChecks('clientChecks', clients, getFilter('clients'), () => {
        setFilter('clients', getChecked('clientChecks'));
        populatePrograms();
      });

      // PROGRAMAS
      populatePrograms();

      // TURMAS & QUESTIONS depend on above
      populateTurmas();
      populateQuestions();

      // SCOPE
      const f = JSON.parse(localStorage.getItem('filters')||'{}');
      if (f.start) document.getElementById('startMonth').value = f.start;
      if (f.end)   document.getElementById('endMonth').value = f.end;
      document.getElementById('startMonth').onchange = e => setFilter('start', e.target.value);
      document.getElementById('endMonth').onchange   = e => setFilter('end',   e.target.value);

      // Trainers for each program
      renderTrainerInputs();
    }

    function populatePrograms() {
      const clients = getFilter('clients');
      const progs = [...new Set(rawData
        .filter(d=>clients.includes(d.client))
        .map(d=>d.program)
      )].sort();
      fillChecks('programChecks', progs, getFilter('programs'), () => {
        setFilter('programs', getChecked('programChecks'));
        populateTurmas();
      });
      renderTrainerInputs();
    }

    function populateTurmas() {
      const clients = getFilter('clients');
      const progs   = getFilter('programs');
      const turmas = [...new Set(rawData
        .filter(d=>clients.includes(d.client)&&progs.includes(d.program))
        .map(d=>d.turma)
      )].sort();
      fillChecks('turmaChecks', turmas, getFilter('turmas'), () => {
        setFilter('turmas', getChecked('turmaChecks'));
      });
    }

    function populateQuestions() {
      const clients = getFilter('clients');
      const progs   = getFilter('programs');
      const turmas  = getFilter('turmas');
      const qs = [...new Set(rawData
        .filter(d=>clients.includes(d.client)&&progs.includes(d.program)&&turmas.includes(d.turma)&&isNaN(+d.value))
        .map(d=>d.question)
      )].sort();
      fillChecks('textQuestionSelect', qs, getFilter('textQuestions'), () => {
        setFilter('textQuestions', getChecked('textQuestionSelect'));
      });
    }

    // Render one trainer input per selected program
    function renderTrainerInputs() {
      const container = document.getElementById('trainersContainer');
      container.innerHTML = '';
      const progs = getFilter('programs');
      const saved = JSON.parse(localStorage.getItem('filters')||'{}').trainers || {};
      progs.forEach(prog => {
        const wrapper = document.createElement('div');
        wrapper.className = 'program-trainer';
        const lbl = document.createElement('label');
        lbl.textContent = `Formador (${prog}):`;
        const inp = document.createElement('input');
        inp.type = 'text';
        inp.value = saved[prog] || '';
        inp.placeholder = `Nome do formador para ${prog}`;
        inp.oninput = () => {
          saved[prog] = inp.value;
          const f = JSON.parse(localStorage.getItem('filters')||'{}');
          f.trainers = saved;
          localStorage.setItem('filters', JSON.stringify(f));
        };
        wrapper.appendChild(lbl);
        wrapper.appendChild(inp);
        container.appendChild(wrapper);
      });
    }

    function goToReport() {
      // Persist clients, programs, turmas, questions, start, end, trainers
      const f = JSON.parse(localStorage.getItem('filters')||'{}');
      f.clients        = getChecked('clientChecks');
      f.programs       = getChecked('programChecks');
      f.turmas         = getChecked('turmaChecks');
      f.textQuestions  = getChecked('textQuestionSelect');
      f.start          = document.getElementById('startMonth').value;
      f.end            = document.getElementById('endMonth').value;
      // trainers already saved on input
      localStorage.setItem('reportFilters', JSON.stringify(f));
      window.location.href = 'report.html';
    }
  </script>
</body>
</html>
