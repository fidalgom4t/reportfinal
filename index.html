<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Selecionar Filtros</title>
  <style>
    /* General styling */
    body { font-family: 'Segoe UI',sans-serif; background:#f5f5f5; margin:40px auto; max-width:800px; padding:0 20px; }
    h2 { text-align:center; color:#007c91; margin-bottom:24px; }
    form { display:grid; grid-template-columns:200px 1fr; gap:20px; align-items:center; }
    label { font-weight:bold; }

    /* Dropdown Multiselect */
    .dropdown-multiselect { position:relative; width:100%; }
    .select-box { background:#fff; border:1px solid #ccc; border-radius:4px; padding:8px 12px; cursor:pointer; position:relative; user-select:none; }
    .select-box::after { content:'▾'; position:absolute; right:12px; top:50%; transform:translateY(-50%); color:#666; font-size:12px; }
    .checkboxes { display:none; position:absolute; top:calc(100% + 4px); width:100%; max-height:180px; overflow-y:auto; background:#fff; border:1px solid #ccc; border-radius:4px; padding:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); z-index:10; }
    .dropdown-multiselect.open .checkboxes { display:block; }
    .checkboxes label { display:flex; align-items:center; margin-bottom:6px; cursor:pointer; }
    .checkboxes input { margin-right:8px; }
    .select-all { background:none; border:none; color:#007c91; cursor:pointer; display:block; margin-bottom:8px; padding:0; text-align:left; width:100%; font-size:0.9em; }

    /* Program-specific fields */
    .program-block { grid-column: span 2; border:1px solid #ddd; padding:16px; border-radius:4px; background:#fff; margin-bottom:20px; }
    .program-header { font-size:1.1em; margin-bottom:12px; color:#007c91; }
    .program-grid { display:grid; grid-template-columns:200px 1fr; gap:10px 20px; align-items:center; }

    /* Buttons */
    .submit-row { grid-column:span 2; text-align:center; margin-top:20px; }
    .link-button { background:#007c91; color:#fff; padding:10px 30px; border-radius:4px; text-decoration:none; font-weight:bold; margin:0 10px; display:inline-block; }
  </style>
</head>
<body>
  <h2>Gerar Relatório Dinâmico</h2>
  <form id="filtersForm" onsubmit="return false;">
    <label>Cliente:</label>
    <div class="dropdown-multiselect" id="clientWrapper">
      <div class="select-box" id="clientBox" data-placeholder="Selecionar cliente(s)">Selecionar cliente(s)</div>
      <div class="checkboxes" id="clientChecks"></div>
    </div>

    <label>Cliente Info:</label>
    <div class="dropdown-multiselect" id="clientInfoWrapper">
      <div class="select-box" id="clientInfoBox" data-placeholder="Selecionar info(s)">Selecionar info(s)</div>
      <div class="checkboxes" id="clientInfoChecks"></div>
    </div>

    <label>Programas:</label>
    <div class="dropdown-multiselect" id="programWrapper">
      <div class="select-box" id="programBox" data-placeholder="Selecionar programa(s)">Selecionar programa(s)</div>
      <div class="checkboxes" id="programChecks"></div>
    </div>

    <label>Perguntas Abertas:</label>
    <div class="dropdown-multiselect" id="textWrapper">
      <div class="select-box" id="textBox" data-placeholder="Selecionar perguntas">Selecionar perguntas</div>
      <div class="checkboxes" id="textChecks"></div>
    </div>

    <div id="programsContainer"></div>

    <div class="submit-row">
      <a href="#" class="link-button" id="viewReport">Ver Relatório</a>
      <a href="#" class="link-button" id="downloadReport">Download Relatório</a>
    </div>
  </form>

  <script>
    let rawData = [];
    const getStorageFilters = () => JSON.parse(localStorage.getItem('filters')||'{}');
    const saveFilter = (k,v)=>{ const f=getStorageFilters(); f[k]=v; localStorage.setItem('filters',JSON.stringify(f)); };
    const loadFilter = k=>getStorageFilters()[k]||[];
    const getCheckedValues = id=>Array.from(document.querySelectorAll(`#${id} input:checked`)).map(i=>i.value);
    const updateSelectBox = (id,vals,ph)=>{ const b=document.getElementById(id); b.textContent = vals.length? vals.join(', '): ph; };

    function populateCheckboxes({containerId,boxId,dataList,filterKey,placeholder,onChange}){
      const cont = document.getElementById(containerId);
      cont.innerHTML = '';
      const allBtn = document.createElement('button'); allBtn.type='button'; allBtn.className='select-all'; allBtn.textContent='Selecionar tudo'; allBtn.onclick=e=>{e.stopPropagation(); saveFilter(filterKey,dataList.slice()); onChange();}; cont.appendChild(allBtn);
      const noneBtn = document.createElement('button'); noneBtn.type='button'; noneBtn.className='select-all'; noneBtn.textContent='Desmarcar tudo'; noneBtn.onclick=e=>{e.stopPropagation(); saveFilter(filterKey,[]); onChange();}; cont.appendChild(noneBtn);
      const stored = loadFilter(filterKey);
      dataList.forEach(item=>{
        const lbl = document.createElement('label');
        const cb = document.createElement('input'); cb.type='checkbox'; cb.value=item; cb.checked=stored.includes(item);
        cb.onchange = ()=>{ const sel = getCheckedValues(containerId); saveFilter(filterKey,sel); onChange(); };
        lbl.append(cb, ' '+item);
        cont.appendChild(lbl);
      });
      updateSelectBox(boxId,loadFilter(filterKey),placeholder);
    }

    function toggleDropdown(id){ document.querySelectorAll('.dropdown-multiselect').forEach(el=>el.id!==id&&el.classList.remove('open')); document.getElementById(id).classList.toggle('open'); }
    function attachDropdownEvents(){ ['client','clientInfo','program','text'].forEach(k=>{ const w=document.getElementById(k+'Wrapper'), b=w.querySelector('.select-box'); b.onclick=e=>{e.stopPropagation(); toggleDropdown(k+'Wrapper');}; });
      document.addEventListener('click', e=>{ if(!e.target.closest('.dropdown-multiselect')) document.querySelectorAll('.dropdown-multiselect').forEach(el=>el.classList.remove('open')); }); }

    function populateClients(){ const arr=[...new Set(rawData.map(d=>d.client))].sort(); populateCheckboxes({containerId:'clientChecks',boxId:'clientBox',dataList:arr,filterKey:'clients',placeholder:'Selecionar cliente(s)',onChange:refreshAll}); }
    function populateClientInfos(){ const sel=loadFilter('clients'); const arr=[...new Set(rawData.filter(d=>sel.includes(d.client)).map(d=>d.client_info))].sort(); populateCheckboxes({containerId:'clientInfoChecks',boxId:'clientInfoBox',dataList:arr,filterKey:'clientInfos',placeholder:'Selecionar info(s)',onChange:refreshAll}); }
    function populatePrograms(){ const sel=loadFilter('clients'); const arr=[...new Set(rawData.filter(d=>sel.includes(d.client)).map(d=>d.program))].sort(); populateCheckboxes({containerId:'programChecks',boxId:'programBox',dataList:arr,filterKey:'programs',placeholder:'Selecionar programa(s)',onChange:refreshAll}); }
    function populateTextQuestions(){ const {clients=[],clientInfos=[],programs=[]} = getStorageFilters(); const qMap={}; rawData.forEach(d=>{ if(clients.includes(d.client) && clientInfos.includes(d.client_info) && programs.includes(d.program) && isNaN(+d.value)){ const sec = (d.section||'').toLowerCase(); const pr = sec.includes('assessment')?0: sec.includes('evaluation')?1:2; if(!qMap[d.question]||qMap[d.question]>pr) qMap[d.question] = pr; }});
      const arr = Object.keys(qMap).sort((a,b)=> qMap[a]-qMap[b] || a.localeCompare(b,'pt'));
      populateCheckboxes({containerId:'textChecks',boxId:'textBox',dataList:arr,filterKey:'textQuestions',placeholder:'Selecionar perguntas',onChange:()=>{}});
    }

    function renderProgramBlocks(){
      const container = document.getElementById('programsContainer'); container.innerHTML = '';
      const f = getStorageFilters(); const progs = f.programs||[];
      const selectedClients = f.clients||[]; const selectedClientInfos = f.clientInfos||[];

      progs.forEach(p=>{
        const block = document.createElement('div'); block.className='program-block';
        block.innerHTML = `<div class="program-header">Programa: ${p}</div>`;
        const grid = document.createElement('div'); grid.className='program-grid';

        // Trainer
        const tLab = document.createElement('label'); tLab.textContent=`Formador (${p}):`;
        const tIn = document.createElement('input'); tIn.type='text'; tIn.placeholder=`Nome do formador para ${p}`; tIn.value=(f.trainers||{})[p]||'';
        tIn.oninput=()=>{ const ff=getStorageFilters(); ff.trainers=ff.trainers||{}; ff.trainers[p]=tIn.value; localStorage.setItem('filters',JSON.stringify(ff)); };
        grid.append(tLab,tIn);
        // Dates
        ['starts','ends'].forEach(k=>{
          const lbl=document.createElement('label'); lbl.textContent=(k==='starts'?`Início (${p}):`:`Fim (${p}):`);
          const inp=document.createElement('input'); inp.type='month'; inp.value=(f[k]||{})[p]||'';
          inp.onchange=()=>{ const ff=getStorageFilters(); ff[k]=ff[k]||{}; ff[k][p]=inp.value; localStorage.setItem('filters',JSON.stringify(ff)); };
          grid.append(lbl,inp);
        });
        // Turmas
        const twId=`turmaWrapper_${p}`, tbId=`turmaBox_${p}`, tcId=`turmaChecks_${p}`;
        const l=document.createElement('label'); l.textContent=`Turmas (${p}):`;
        const w=document.createElement('div'); w.className='dropdown-multiselect'; w.id=twId;
        w.innerHTML=`<div class="select-box" id="${tbId}" data-placeholder="Selecionar turma(s)">Selecionar turma(s)</div><div class="checkboxes" id="${tcId}"></div>`;
        grid.append(l,w);
        // populate
        const available=[...new Set(rawData.filter(d=>d.program===p && selectedClients.includes(d.client) && selectedClientInfos.includes(d.client_info)).map(d=>d.turma))].sort();
        populateCheckboxes({containerId:tcId,boxId:tbId,dataList:available,filterKey:`turmas_${p}`,placeholder:'Selecionar turma(s)',onChange:()=>updateSelectBox(tbId,getCheckedValues(tcId),'Selecionar turma(s)')});
        updateSelectBox(tbId,loadFilter(`turmas_${p}`),'Selecionar turma(s)');
        w.querySelector('.select-box').onclick=e=>{e.stopPropagation();toggleDropdown(twId);};

        block.appendChild(grid); container.appendChild(block);
      });
    }

    function refreshAll(){ populateClientInfos(); populatePrograms(); populateTextQuestions(); renderProgramBlocks(); }

    function initFilters(){
      fetch('data.json').then(r=>r.json()).then(data=>{ rawData=data; populateClients(); attachDropdownEvents(); refreshAll();
        document.getElementById('viewReport').onclick=()=>window.location.href='report.html';
        document.getElementById('downloadReport').onclick=()=>window.location.href='report.html?download=true';
      });
    }
    document.addEventListener('DOMContentLoaded',initFilters);
  </script>
</body>
</html>
