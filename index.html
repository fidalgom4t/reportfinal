<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="UTF-8" />
  <title>Generate Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --primary: #007c91;
      --primary-soft: #e0f4f7;
      --bg: #f3f7f9;
      --card: #ffffff;
      --border: #dde5ec;
      --radius: 10px;
      --shadow-soft: 0 12px 30px rgba(15, 52, 67, 0.08);
      --text-main: #123047;
      --text-muted: #6b7a88;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 32px 16px 40px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #e5f5ff 0, #f5fafc 45%, #f3f7f9 100%);
      color: var(--text-main);
      display: flex;
      justify-content: center;
    }

    .shell {
      width: 100%;
      max-width: 1120px;
    }

    header h1 {
      margin: 0 0 4px;
      font-size: 26px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    header p {
      margin: 0 0 22px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .grid {
      display: grid;
      grid-template-columns: 1.1fr 1fr 1.1fr;
      gap: 18px;
    }

    .card {
      background: var(--card);
      border-radius: 18px;
      box-shadow: var(--shadow-soft);
      padding: 16px 16px 10px;
      display: flex;
      flex-direction: column;
      min-height: 260px;
      max-height: 320px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .card-title {
      font-size: 13px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--primary);
    }

    .helper-text {
      font-size: 11px;
      color: var(--text-muted);
      margin: 0 2px 6px;
    }

    .list {
      margin-top: 4px;
      padding: 4px 4px 4px 0;
      overflow-y: auto;
      flex: 1;
    }

    .item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      padding: 4px 6px;
      border-radius: 8px;
      font-size: 13px;
    }

    .item:hover {
      background: #f2f7fb;
    }

    .item-main {
      display: flex;
      align-items: center;
      gap: 6px;
      flex: 1;
      min-width: 0;
    }

    .item label {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      width: 100%;
    }

    .item span.text {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .chip-archive {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 0 10px;
      font-size: 11px;
      color: var(--text-muted);
      background: #f6fafc;
      cursor: pointer;
      flex-shrink: 0;
    }

    .chip-archive:hover {
      border-color: var(--primary);
      color: var(--primary);
      background: var(--primary-soft);
    }

    .btn-ghost {
      border-radius: 999px;
      border: 1px solid var(--primary-soft);
      padding: 4px 10px;
      font-size: 11px;
      background: #f5fafb;
      color: var(--primary);
      cursor: pointer;
    }

    .btn-ghost:hover {
      background: var(--primary-soft);
    }

    /* BLOCO DINÃ‚MICO POR PROGRAMA */
    .dynamic-blocks-container {
      margin-top: 22px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .dynamic-block {
      background: #ffffff;
      border-radius: 16px;
      border: 1px solid #dbe7ee;
      padding: 16px 18px 14px;
      box-shadow: 0 10px 26px rgba(15, 52, 67, 0.06);
    }

    .dynamic-block h3 {
      margin: 0 0 10px;
      font-size: 16px;
      color: var(--primary);
    }

    .db-row {
      display: grid;
      grid-template-columns: 1.2fr 0.8fr 0.8fr;
      gap: 10px;
      margin-bottom: 10px;
    }

    .db-field label {
      display: block;
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .db-field input[type="text"],
    .db-field input[type="month"] {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #d0dde0;
      font-size: 13px;
    }

    .db-field input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(0,124,145,0.12);
    }

    .turmas-title {
      font-size: 12px;
      color: var(--text-muted);
      margin: 4px 0 4px;
    }

    .turmas-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 13px;
    }

    .turmas-list label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    /* BARRA INFERIOR */
    .footer-bar {
      margin-top: 18px;
      background: rgba(255, 255, 255, 0.85);
      border-radius: 999px;
      box-shadow: 0 10px 26px rgba(15, 52, 67, 0.09);
      padding: 10px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .footer-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .pill-archived {
      border-radius: 999px;
      padding: 4px 10px;
      background: #f1f6f9;
      border: 1px solid #d8e4ee;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .badge-count {
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 10px;
      background: var(--primary-soft);
      color: var(--primary);
    }

    .btn-primary {
      border-radius: 999px;
      padding: 8px 22px;
      font-size: 14px;
      border: none;
      cursor: pointer;
      background: #9aa4af;
      color: white;
    }

    .btn-primary.enabled {
      background: var(--primary);
      box-shadow: 0 8px 18px rgba(0, 124, 145, 0.35);
    }

    .btn-primary.enabled:hover {
      background: #006173;
    }

    .archived-panel {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 70px;
      min-width: 420px;
      max-width: 620px;
      background: #ffffff;
      border-radius: 14px;
      box-shadow: 0 18px 40px rgba(15, 52, 67, 0.18);
      padding: 14px 16px 12px;
      font-size: 12px;
      color: var(--text-main);
      display: none;
    }

    .archived-panel.visible {
      display: block;
    }

    .archived-panel h4 {
      margin: 0 0 6px;
      font-size: 13px;
      color: var(--primary);
    }

    .archived-list-group {
      margin-bottom: 6px;
    }

    .archived-list-group strong {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .archived-tags {
      margin-top: 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .tag {
      border-radius: 999px;
      padding: 3px 8px;
      background: #f3f7fb;
      border: 1px solid #d9e4f0;
      font-size: 11px;
    }

    .tag span {
      margin-left: 4px;
      cursor: pointer;
      color: #b23b3b;
    }

    @media (max-width: 960px) {
      .grid {
        grid-template-columns: 1fr;
      }
      .card {
        max-height: none;
      }
      .dynamic-block {
        padding: 14px 14px 12px;
      }
      .db-row {
        grid-template-columns: 1fr;
      }
      .archived-panel {
        position: fixed;
        left: 12px;
        right: 12px;
        transform: none;
        bottom: 82px;
        max-width: none;
      }
    }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <h1>GENERATE REPORT</h1>
      <p>
        Escolhe o cliente, o(s) programa(s) e a informaÃ§Ã£o pretendida. Podes arquivar clientes / programas / infos
        para manter a lista limpa.
      </p>
    </header>

    <div class="grid">
      <!-- CLIENTES -->
      <section class="card" id="card-clients">
        <div class="card-header">
          <span class="card-title">Cliente</span>
        </div>
        <p class="helper-text">Seleciona exatamente um cliente.</p>
        <div class="list" id="clientList"></div>
      </section>

      <!-- PROGRAMAS -->
      <section class="card" id="card-programs">
        <div class="card-header">
          <span class="card-title">Programas</span>
          <button class="btn-ghost" id="btnSelectAllPrograms">Selecionar todos</button>
        </div>
        <p class="helper-text">Escolhe um ou mais programas para o cliente selecionado.</p>
        <div class="list" id="programList"></div>
      </section>

      <!-- INFOS -->
      <section class="card" id="card-infos">
        <div class="card-header">
          <span class="card-title">Data / Info</span>
          <button class="btn-ghost" id="btnSelectAllInfos">Selecionar todos</button>
        </div>
        <p class="helper-text">Filtra anos, turmas ou outras infos conforme os dados.</p>
        <div class="list" id="infoList"></div>
      </section>
    </div>

    <!-- BLOCO DINÃ‚MICO POR PROGRAMA -->
    <div id="dynamicBlocks" class="dynamic-blocks-container"></div>

    <!-- Barra inferior -->
    <div class="footer-bar">
      <div class="footer-left">
        <div class="pill-archived">
          <span>ðŸ”’ Arquivados</span>
          <span id="archivedCount" class="badge-count">0</span>
        </div>
        <span id="archivedHelper">Guardado no Apps Script (partilhado entre utilizadores).</span>
      </div>

      <div style="display:flex; align-items:center; gap:10px;">
        <button class="btn-ghost" id="btnToggleArchived">Ver arquivados â–¾</button>
        <button id="btnViewReport" class="btn-primary" disabled>Ver relatÃ³rio</button>
      </div>
    </div>

    <!-- Painel de arquivados -->
    <div id="archivedPanel" class="archived-panel">
      <h4>Itens arquivados</h4>
      <div id="archivedContent"></div>
      <p style="margin:6px 0 0; font-size:11px; color:var(--text-muted);">
        Nota: remover dos arquivados volta a mostrar o item nas listas acima.
      </p>
    </div>
  </div>

  <script>
    // ====================================================
    // CONFIG: URL do teu Apps Script Web App
    // ====================================================
    const APPS_SCRIPT_URL = 'PASTE_YOUR_WEBAPP_URL_HERE'; // termina em /exec

    // ====================================================
    // ESTADO
    // ====================================================
    let rawData = [];
    let archived = { clients: {}, programs: {}, infos: {} };

    let currentClient = null;
    let selectedPrograms = new Set();
    let selectedInfos = new Set();

    // meta por programa (formador, datas, turmas)
    // { [program]: { trainer, start, end, turmas: Set() } }
    const programMeta = {};

    function ensureProgramMeta(program) {
      if (!programMeta[program]) {
        programMeta[program] = {
          trainer: '',
          start: '',
          end: '',
          turmas: new Set()
        };
      }
      return programMeta[program];
    }

    // ====================================================
    // HELPERS APPS SCRIPT (GET/SET ARCHIVED)
    // ====================================================
    async function loadArchivedState() {
      if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.startsWith('PASTE_')) {
        console.warn('APPS_SCRIPT_URL ainda nÃ£o definido. A usar estado vazio.');
        return { clients: {}, programs: {}, infos: {} };
      }
      try {
        const res = await fetch(APPS_SCRIPT_URL + '?action=getArchived', { method: 'GET' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        return {
          clients: data.clients || {},
          programs: data.programs || {},
          infos: data.infos || {}
        };
      } catch (err) {
        console.warn('Erro ao carregar estado arquivado, a usar vazio:', err);
        return { clients: {}, programs: {}, infos: {} };
      }
    }

    async function saveArchivedState() {
      if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.startsWith('PASTE_')) return;
      try {
        await fetch(APPS_SCRIPT_URL + '?action=setArchived', {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // evita preflight
          body: JSON.stringify(archived)
        });
      } catch (err) {
        console.warn('Erro ao gravar estado arquivado:', err);
      }
    }

    // ====================================================
    // CARREGAR DADOS
    // ====================================================
    async function init() {
      try {
        rawData = await fetch('data.json').then(r => r.json());
      } catch (err) {
        alert('Erro a carregar data.json');
        console.error(err);
        return;
      }

      archived = await loadArchivedState();

      renderClients();
      updateArchivedUI();
      refreshProgramBlocks();

      document.getElementById('btnSelectAllPrograms').onclick = handleSelectAllPrograms;
      document.getElementById('btnSelectAllInfos').onclick = handleSelectAllInfos;
      document.getElementById('btnViewReport').onclick = handleViewReport;
      document.getElementById('btnToggleArchived').onclick = toggleArchivedPanel;

      document.addEventListener('click', e => {
        const panel = document.getElementById('archivedPanel');
        if (!panel.classList.contains('visible')) return;
        if (!panel.contains(e.target) && !document.getElementById('btnToggleArchived').contains(e.target)) {
          panel.classList.remove('visible');
        }
      });
    }

    // ====================================================
    // RENDER CLIENTES
    // ====================================================
    function renderClients() {
      const list = document.getElementById('clientList');
      list.innerHTML = '';

      const clients = [...new Set(rawData.map(r => r.client))].sort();

      clients
        .filter(c => !archived.clients[c])
        .forEach(client => {
          const item = document.createElement('div');
          item.className = 'item';

          const main = document.createElement('div');
          main.className = 'item-main';

          const label = document.createElement('label');
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.checked = currentClient === client;
          cb.onchange = () => handleClientChange(client, cb.checked);

          const span = document.createElement('span');
          span.className = 'text';
          span.textContent = client;

          label.append(cb, span);
          main.appendChild(label);

          const archBtn = document.createElement('button');
          archBtn.className = 'chip-archive';
          archBtn.textContent = 'Arquivar';
          archBtn.onclick = () => archiveClient(client);

          item.append(main, archBtn);
          list.appendChild(item);
        });
    }

    function handleClientChange(client, checked) {
      if (!checked) {
        currentClient = null;
      } else {
        currentClient = client;
      }

      // seleÃ§Ã£o Ãºnica
      Array.from(document.querySelectorAll('#clientList input[type=checkbox]')).forEach(cb => {
        cb.checked = cb.parentElement.querySelector('.text').textContent === currentClient;
      });

      selectedPrograms.clear();
      selectedInfos.clear();
      // reset meta quando muda de cliente
      Object.keys(programMeta).forEach(k => delete programMeta[k]);

      renderPrograms();
      renderInfos();
      refreshProgramBlocks();
      updateViewReportButton();
    }

    // ====================================================
    // RENDER PROGRAMAS
    // ====================================================
    function renderPrograms() {
      const list = document.getElementById('programList');
      list.innerHTML = '';

      if (!currentClient) return;

      const programs = [...new Set(rawData
        .filter(r => r.client === currentClient)
        .map(r => r.program))].sort();

      programs
        .filter(p => !archived.programs[`${currentClient}|${p}`])
        .forEach(program => {
          const item = document.createElement('div');
          item.className = 'item';

          const main = document.createElement('div');
          main.className = 'item-main';

          const label = document.createElement('label');
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.checked = selectedPrograms.has(program);
          cb.onchange = () => handleProgramChange(program, cb.checked);

          const span = document.createElement('span');
          span.className = 'text';
          span.textContent = program;

          label.append(cb, span);
          main.appendChild(label);

          const archBtn = document.createElement('button');
          archBtn.className = 'chip-archive';
          archBtn.textContent = 'Arquivar';
          archBtn.onclick = () => archiveProgram(currentClient, program);

          item.append(main, archBtn);
          list.appendChild(item);
        });
    }

    function handleProgramChange(program, checked) {
      if (checked) selectedPrograms.add(program);
      else selectedPrograms.delete(program);

      renderInfos();
      refreshProgramBlocks();
      updateViewReportButton();
    }

    function handleSelectAllPrograms() {
      if (!currentClient) return;
      const programs = [...new Set(rawData
        .filter(r => r.client === currentClient)
        .map(r => r.program))].sort()
        .filter(p => !archived.programs[`${currentClient}|${p}`]);

      const allSelected = programs.every(p => selectedPrograms.has(p));
      selectedPrograms = new Set(allSelected ? [] : programs);

      renderPrograms();
      renderInfos();
      refreshProgramBlocks();
      updateViewReportButton();
    }

    // ====================================================
    // RENDER INFOS
    // ====================================================
    function renderInfos() {
      const list = document.getElementById('infoList');
      list.innerHTML = '';

      if (!currentClient || selectedPrograms.size === 0) return;

      const programsArr = [...selectedPrograms];
      const infos = [...new Set(rawData
        .filter(r => r.client === currentClient && programsArr.includes(r.program))
        .map(r => r.client_info))].sort();

      infos
        .filter(info => !archived.infos[`${currentClient}|${info}`])
        .forEach(info => {
          const item = document.createElement('div');
          item.className = 'item';

          const main = document.createElement('div');
          main.className = 'item-main';

          const label = document.createElement('label');
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.checked = selectedInfos.has(info);
          cb.onchange = () => handleInfoChange(info, cb.checked);

          const span = document.createElement('span');
          span.className = 'text';
          span.textContent = info;

          label.append(cb, span);
          main.appendChild(label);

          const archBtn = document.createElement('button');
          archBtn.className = 'chip-archive';
          archBtn.textContent = 'Arquivar';
          archBtn.onclick = () => archiveInfo(currentClient, info);

          item.append(main, archBtn);
          list.appendChild(item);
        });
    }

    function handleInfoChange(info, checked) {
      if (checked) selectedInfos.add(info);
      else selectedInfos.delete(info);

      refreshProgramBlocks();
      updateViewReportButton();
    }

    function handleSelectAllInfos() {
      if (!currentClient || selectedPrograms.size === 0) return;

      const programsArr = [...selectedPrograms];
      const infos = [...new Set(rawData
        .filter(r => r.client === currentClient && programsArr.includes(r.program))
        .map(r => r.client_info))].sort()
        .filter(info => !archived.infos[`${currentClient}|${info}`]);

      const allSelected = infos.every(i => selectedInfos.has(i));
      selectedInfos = new Set(allSelected ? [] : infos);

      renderInfos();
      refreshProgramBlocks();
      updateViewReportButton();
    }

    // ====================================================
    // BLOCO DINÃ‚MICO POR PROGRAMA
    // ====================================================
    function refreshProgramBlocks() {
      const container = document.getElementById('dynamicBlocks');
      container.innerHTML = '';

      if (!currentClient || selectedPrograms.size === 0 || selectedInfos.size === 0) {
        return;
      }

      const programsArr = [...selectedPrograms].sort();
      const infosArr = [...selectedInfos];

      programsArr.forEach(program => {
        const meta = ensureProgramMeta(program);

        const block = document.createElement('div');
        block.className = 'dynamic-block';

        const title = document.createElement('h3');
        title.textContent = `Programa: ${program}`;
        block.appendChild(title);

        const row = document.createElement('div');
        row.className = 'db-row';

        // Formador
        const fField = document.createElement('div');
        fField.className = 'db-field';
        const fLabel = document.createElement('label');
        fLabel.textContent = 'Formador';
        const fInput = document.createElement('input');
        fInput.type = 'text';
        fInput.value = meta.trainer;
        fInput.oninput = (e) => {
          meta.trainer = e.target.value;
        };
        fField.append(fLabel, fInput);

        // InÃ­cio
        const sField = document.createElement('div');
        sField.className = 'db-field';
        const sLabel = document.createElement('label');
        sLabel.textContent = 'InÃ­cio';
        const sInput = document.createElement('input');
        sInput.type = 'month';
        sInput.value = meta.start;
        sInput.onchange = (e) => {
          meta.start = e.target.value;
        };
        sField.append(sLabel, sInput);

        // Fim
        const eField = document.createElement('div');
        eField.className = 'db-field';
        const eLabel = document.createElement('label');
        eLabel.textContent = 'Fim';
        const eInput = document.createElement('input');
        eInput.type = 'month';
        eInput.value = meta.end;
        eInput.onchange = (e) => {
          meta.end = e.target.value;
        };
        eField.append(eLabel, eInput);

        row.append(fField, sField, eField);
        block.appendChild(row);

        // Turmas
        const turmasTitle = document.createElement('div');
        turmasTitle.className = 'turmas-title';
        turmasTitle.textContent = 'Turmas';
        block.appendChild(turmasTitle);

        const turmasList = document.createElement('div');
        turmasList.className = 'turmas-list';

        const turmas = [
          ...new Set(
            rawData
              .filter(r =>
                r.client === currentClient &&
                r.program === program &&
                infosArr.includes(r.client_info)
              )
              .map(r => r.turma)
          )
        ].sort();

        turmas.forEach(turma => {
          const lbl = document.createElement('label');
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.checked = meta.turmas.has(turma);
          cb.onchange = () => {
            if (cb.checked) meta.turmas.add(turma);
            else meta.turmas.delete(turma);
          };
          lbl.append(cb, document.createTextNode(turma));
          turmasList.appendChild(lbl);
        });

        block.appendChild(turmasList);
        container.appendChild(block);
      });
    }

    // ====================================================
    // ARQUIVAR
    // ====================================================
    function archiveClient(client) {
      if (!confirm(`Arquivar o cliente "${client}"?`)) return;
      archived.clients[client] = true;
      if (currentClient === client) {
        currentClient = null;
        selectedPrograms.clear();
        selectedInfos.clear();
        Object.keys(programMeta).forEach(k => delete programMeta[k]);
        renderPrograms();
        renderInfos();
        refreshProgramBlocks();
      }
      renderClients();
      updateArchivedUI();
      saveArchivedState();
      updateViewReportButton();
    }

    function archiveProgram(client, program) {
      if (!confirm(`Arquivar o programa "${program}" para o cliente "${client}"?`)) return;
      archived.programs[`${client}|${program}`] = true;
      selectedPrograms.delete(program);
      delete programMeta[program];
      renderPrograms();
      renderInfos();
      refreshProgramBlocks();
      updateArchivedUI();
      saveArchivedState();
      updateViewReportButton();
    }

    function archiveInfo(client, info) {
      if (!confirm(`Arquivar a info "${info}" para o cliente "${client}"?`)) return;
      archived.infos[`${client}|${info}`] = true;
      selectedInfos.delete(info);
      renderInfos();
      refreshProgramBlocks();
      updateArchivedUI();
      saveArchivedState();
      updateViewReportButton();
    }

    // remover dos arquivados
    function unarchiveClient(client) {
      delete archived.clients[client];
      renderClients();
      updateArchivedUI();
      saveArchivedState();
    }

    function unarchiveProgram(client, program) {
      delete archived.programs[`${client}|${program}`];
      renderPrograms();
      updateArchivedUI();
      saveArchivedState();
    }

    function unarchiveInfo(client, info) {
      delete archived.infos[`${client}|${info}`];
      renderInfos();
      updateArchivedUI();
      saveArchivedState();
    }

    // ====================================================
    // UI ARQUIVADOS
    // ====================================================
    function updateArchivedUI() {
      const clients = Object.keys(archived.clients);
      const programs = Object.keys(archived.programs);
      const infos = Object.keys(archived.infos);
      const total = clients.length + programs.length + infos.length;

      document.getElementById('archivedCount').textContent = total;

      const content = document.getElementById('archivedContent');
      content.innerHTML = '';

      if (total === 0) {
        content.textContent = 'Nenhum item arquivado.';
        return;
      }

      // clientes
      if (clients.length) {
        const group = document.createElement('div');
        group.className = 'archived-list-group';
        group.innerHTML = '<strong>Clientes</strong>';
        const tags = document.createElement('div');
        tags.className = 'archived-tags';

        clients.forEach(c => {
          const tag = document.createElement('span');
          tag.className = 'tag';
          tag.innerHTML = `${c} <span title="Desarquivar">Ã—</span>`;
          tag.querySelector('span').onclick = () => unarchiveClient(c);
          tags.appendChild(tag);
        });
        group.appendChild(tags);
        content.appendChild(group);
      }

      // programas
      if (programs.length) {
        const group = document.createElement('div');
        group.className = 'archived-list-group';
        group.innerHTML = '<strong>Programas</strong>';
        const tags = document.createElement('div');
        tags.className = 'archived-tags';

        programs.forEach(key => {
          const [client, program] = key.split('|');
          const tag = document.createElement('span');
          tag.className = 'tag';
          tag.innerHTML = `${client} â€“ ${program} <span title="Desarquivar">Ã—</span>`;
          tag.querySelector('span').onclick = () => unarchiveProgram(client, program);
          tags.appendChild(tag);
        });
        group.appendChild(tags);
        content.appendChild(group);
      }

      // infos
      if (infos.length) {
        const group = document.createElement('div');
        group.className = 'archived-list-group';
        group.innerHTML = '<strong>Infos</strong>';
        const tags = document.createElement('div');
        tags.className = 'archived-tags';

        infos.forEach(key => {
          const [client, info] = key.split('|');
          const tag = document.createElement('span');
          tag.className = 'tag';
          tag.innerHTML = `${client} â€“ ${info} <span title="Desarquivar">Ã—</span>`;
          tag.querySelector('span').onclick = () => unarchiveInfo(client, info);
          tags.appendChild(tag);
        });
        group.appendChild(tags);
        content.appendChild(group);
      }
    }

    function toggleArchivedPanel() {
      const panel = document.getElementById('archivedPanel');
      panel.classList.toggle('visible');
    }

    // ====================================================
    // BOTÃƒO "VER RELATÃ“RIO"
    // ====================================================
    function updateViewReportButton() {
      const btn = document.getElementById('btnViewReport');
      const enabled = currentClient && selectedPrograms.size > 0 && selectedInfos.size > 0;
      btn.disabled = !enabled;
      btn.classList.toggle('enabled', enabled);
    }

    function handleViewReport() {
      if (!currentClient) return;

      // preparar meta por programa para enviar ao report.html
      const metaOut = {};
      [...selectedPrograms].forEach(program => {
        const meta = ensureProgramMeta(program);
        metaOut[program] = {
          trainer: meta.trainer || '',
          start: meta.start || '',
          end: meta.end || '',
          turmas: [...meta.turmas]
        };
      });

      const filters = {
        client: currentClient,
        programs: [...selectedPrograms],
        infos: [...selectedInfos],
        meta: metaOut
      };

      localStorage.setItem('reportFilters', JSON.stringify(filters));
      window.location.href = 'report.html';
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
