<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Relatório de Formação</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 30px;
      background-color: #fff;
      color: #333;
    }
    header {
      display: flex;
      align-items: center;
      border-bottom: 2px solid #007c91;
      padding-bottom: 10px;
      margin-bottom: 30px;
    }
    .logo-text {
      font-size: 20px;
      font-weight: bold;
      color: #007c91;
      margin-left: 15px;
    }
    select {
      margin: 10px;
      padding: 5px;
    }
    .chart-container {
      width: 100%;
      height: 400px;
      margin-bottom: 40px;
    }
    .turma-title {
      font-size: 18px;
      font-weight: bold;
      margin-top: 40px;
      margin-bottom: 10px;
      color: #007c91;
    }
    .text-question {
      border: 1px solid #007c91;
      border-left: 6px solid #007c91;
      padding: 16px;
      margin-bottom: 30px;
      background: #f9f9f9;
    }
    .text-question-title {
      font-weight: bold;
      margin-bottom: 8px;
      font-size: 16px;
      color: #007c91;
    }
    .program-buttons button,
    .section-toggle button {
      margin: 5px;
      padding: 8px 16px;
      border: none;
      background-color: #007c91;
      color: #fff;
      cursor: pointer;
    }
    .section {
      display: none;
      margin-top: 30px;
    }
    .active-section {
      display: block;
    }
    .summary-box {
      border: 2px solid #007c91;
      padding: 20px;
      margin-bottom: 30px;
    }
    .summary-box h2 {
      margin-top: 0;
    }
    .formador-select {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Logo" height="50">
    <div class="logo-text">MIND4TIME<br><span style="font-weight: normal; font-size: 14px;">Productivity Consulting</span></div>
  </header>

  <div id="welcome">
    <img src="welcome.png" alt="Página Inicial" style="width: 100%; max-width: 900px;">
  </div>

  <h1>Relatório de Formação</h1>
  <label>Cliente:</label>
  <select id="clientSelect"></select>

  <div class="program-buttons" id="programButtons"></div>
  <div id="programSections"></div>

  <script>
    let rawData = [];

    fetch('data.json')
      .then(res => res.json())
      .then(data => {
        rawData = data;
        populateClients();
      });

    function populateClients() {
      const clientSelect = document.getElementById("clientSelect");
      const clients = [...new Set(rawData.map(d => d.client))].sort();
      clients.forEach(client => {
        const opt = document.createElement("option");
        opt.value = client;
        opt.textContent = client;
        clientSelect.appendChild(opt);
      });
      clientSelect.onchange = () => generateProgramButtons(clientSelect.value);
    }

    function generateProgramButtons(client) {
      const container = document.getElementById("programButtons");
      container.innerHTML = '';
      const programs = [...new Set(rawData.filter(d => d.client === client).map(d => d.program))];
      const sectionContainer = document.getElementById("programSections");
      sectionContainer.innerHTML = '';

      programs.forEach(program => {
        const btn = document.createElement("button");
        btn.textContent = program;
        btn.onclick = () => showProgramSection(program);
        container.appendChild(btn);

        const section = document.createElement("div");
        section.id = `section-${program}`;
        section.className = 'section';
        sectionContainer.appendChild(section);

        renderProgramSection(section, client, program);
      });
    }

    function showProgramSection(program) {
      document.querySelectorAll('.section').forEach(div => div.classList.remove('active-section'));
      document.getElementById(`section-${program}`).classList.add('active-section');
    }

    function renderProgramSection(container, client, program) {
      const data = rawData.filter(d => d.client === client && d.program === program);
      const assessment = data.filter(d => d.section === 'assessment');
      const evaluation = data.filter(d => d.section === 'evaluation');

      const months = str => new Date(str).toLocaleDateString('pt-PT', { month: 'long', year: 'numeric' });
      const scope = `${months(assessment[0]?.submitted_at)} - ${months(evaluation[0]?.submitted_at)}`;

      const formadorSet = new Set(data.map(d => d.trainer).filter(Boolean));
      const formadores = Array.from(formadorSet).sort();

      const summary = `
        <div class="summary-box">
          <h2>${program}</h2>
          <p><strong>Scope Temporal:</strong> ${scope}</p>
          <p><strong>Respostas Assessment:</strong> ${assessment.length}</p>
          <p><strong>Respostas Avaliação:</strong> ${evaluation.length}</p>
          <label>Formador:</label>
          <select class="formador-select">
            ${formadores.map(f => `<option>${f}</option>`).join('')}
          </select>
        </div>`;

      const chartDiv = `<div id="chart-${program}" class="chart-container"></div>`;
      const textDiv = `<div id="text-${program}"></div>`;
      container.innerHTML = summary + chartDiv + textDiv;

      const chartData = {};
      assessment.concat(evaluation).forEach(d => {
        if (typeof d.value === 'number') {
          if (!chartData[d.question]) chartData[d.question] = [];
          chartData[d.question].push(d.value);
        }
      });

      const chartDataset = Object.entries(chartData).map(([q, vals]) => ({
        question: q,
        average: vals.reduce((a, b) => a + b, 0) / vals.length
      }));
      drawBarChart(`chart-${program}`, chartDataset);

      const textMap = {};
      data.filter(d => typeof d.value !== 'number').forEach(d => {
        if (!textMap[d.question]) textMap[d.question] = [];
        textMap[d.question].push(d.value);
      });
      const textContainer = document.getElementById(`text-${program}`);
      Object.entries(textMap).forEach(([q, answers]) => {
        const box = document.createElement("div");
        box.className = "text-question";
        box.innerHTML = `<div class="text-question-title">${q}</div>` + answers.map(a => `<p>${a}</p>`).join('');
        textContainer.appendChild(box);
      });
    }

    function drawBarChart(containerId, data) {
      const chart = echarts.init(document.getElementById(containerId));
      const questions = data.map(d => d.question);
      const values = data.map(d => d.average);

      chart.setOption({
        tooltip: {},
        xAxis: { type: 'category', data: questions, axisLabel: { rotate: 30 } },
        yAxis: { type: 'value', min: 0, max: 5 },
        series: [{
          type: 'bar',
          data: values,
          itemStyle: {
            color: val => val.value < 3 ? '#d94e5d' : val.value < 4 ? '#f2c037' : '#61c277'
          },
          label: {
            show: true,
            position: 'top',
            formatter: '{c}'
          }
        }]
      });
    }
  </script>
</body>
</html>
