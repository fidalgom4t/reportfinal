<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Selecionar Filtros</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; padding:40px; background:#f5f5f5 }
    label { font-weight:bold; margin-top:20px; display:block }
    select,input { padding:5px; margin-top:5px; width:300px }
    .dropdown-multiselect { margin-top:15px }
    .link-button {
      display:inline-block; margin:30px 0; padding:10px 20px;
      background:#007c91; color:#fff; text-decoration:none;
      font-weight:bold; border-radius:5px; cursor:pointer;
    }
  </style>
</head>
<body>

  <h2>Gerar Relatório Dinâmico</h2>

  <label>Cliente:</label>
  <select id="clientSelect"></select>

  <label>Programas:</label>
  <select id="programSelect" multiple size="4"></select>

  <label>Turmas:</label>
  <select id="turmaSelect" multiple size="5"></select>

  <label>Formador:</label>
  <input type="text" id="trainerInput" placeholder="Nome do formador" />

  <label>Perguntas Abertas:</label>
  <div class="dropdown-multiselect" id="textWrapper">
    <div class="select-box" onclick="toggleDropdown()">Selecionar perguntas</div>
    <div class="checkboxes" id="textQuestionSelect"></div>
  </div>

  <label>Scope temporal - Início:</label>
  <input type="month" id="startMonthInput" />

  <label>Scope temporal - Fim:</label>
  <input type="month" id="endMonthInput" />

  <a class="link-button" onclick="goToReport()">Ver Relatório</a>

  <script>
    let rawData = [];

    fetch('data.json')
      .then(res => res.json())
      .then(data => {
        rawData = data;
        populateClients();
        syncScopeInputs();
      });

    function toggleDropdown() {
      document.getElementById("textWrapper").classList.toggle("open");
    }

    function populateClients() {
      const clients = [...new Set(rawData.map(d => d.client))];
      const clientSelect = document.getElementById("clientSelect");
      clientSelect.innerHTML = clients.map(c => `<option value="${c}">${c}</option>`).join('');
      clientSelect.onchange = populatePrograms;
      clientSelect.value = getStored('client') || clients[0];
      populatePrograms();
    }

    function populatePrograms() {
      const client = document.getElementById("clientSelect").value;
      store('client', client);
      const filtered = rawData.filter(d => d.client === client);
      const programs = [...new Set(filtered.map(d => d.program))];
      const programSelect = document.getElementById("programSelect");
      programSelect.innerHTML = programs
        .map(p => `<option value="${p}">${p}</option>`)
        .join('');
      // restore
      const stored = getStored('programs') || [programs[0]];
      Array.from(programSelect.options).forEach(opt =>
        opt.selected = stored.includes(opt.value)
      );
      programSelect.onchange = () => {
        const sel = Array.from(programSelect.selectedOptions).map(o => o.value);
        store('programs', sel);
        populateTurmas();
      };
      store('programs', stored);
      populateTurmas();
    }

    function populateTurmas() {
      const client = getStored('client');
      const programs = getStored('programs') || [];
      const filtered = rawData.filter(d =>
        d.client === client && programs.includes(d.program)
      );
      const turmas = [...new Set(filtered.map(d => d.turma))];
      const turmaSelect = document.getElementById("turmaSelect");
      turmaSelect.innerHTML = turmas
        .map(t => `<option value="${t}">${t}</option>`)
        .join('');
      // restore
      const stored = getStored('turmas') || [];
      Array.from(turmaSelect.options).forEach(opt =>
        opt.selected = stored.includes(opt.value)
      );
      turmaSelect.onchange = () => {
        const sel = Array.from(turmaSelect.selectedOptions).map(o => o.value);
        store('turmas', sel);
      };
      store('turmas', stored);
      populateTextQs(filtered);
    }

    function populateTextQs(filtered) {
      const textQs = [...new Set(filtered.filter(d => isNaN(+d.value)).map(d => d.question))];
      const container = document.getElementById("textQuestionSelect");
      container.innerHTML = '';
      const stored = getStored('textQuestions') || [];
      textQs.forEach(q => {
        const lbl = document.createElement('label');
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.value = q;
        cb.checked = stored.includes(q);
        cb.onchange = () => {
          const sel = Array.from(container.querySelectorAll('input:checked')).map(i=>i.value);
          store('textQuestions', sel);
        };
        lbl.appendChild(cb);
        lbl.appendChild(document.createTextNode(' ' + q));
        container.appendChild(lbl);
        container.appendChild(document.createElement('br'));
      });
    }

    function syncScopeInputs() {
      const stored = JSON.parse(localStorage.getItem('filters')||'{}');
      if (stored.start) document.getElementById('startMonthInput').value = stored.start;
      if (stored.end)   document.getElementById('endMonthInput').value   = stored.end;
      document.getElementById('startMonthInput').onchange = e => store('start', e.target.value);
      document.getElementById('endMonthInput').onchange   = e => store('end',   e.target.value);
    }

    function store(key, value) {
      const s = JSON.parse(localStorage.getItem('filters')||'{}');
      s[key] = value;
      localStorage.setItem('filters', JSON.stringify(s));
    }
    function getStored(key) {
      return JSON.parse(localStorage.getItem('filters')||'{}')[key];
    }

    function goToReport() {
      localStorage.setItem('reportFilters', localStorage.getItem('filters'));
      window.location.href = 'report.html';
    }
  </script>
</body>
</html>
