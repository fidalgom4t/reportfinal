<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8"/>
  <title>Training Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- Roboto & ECharts -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

  <!-- html2canvas & pdfMake -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

  <style>
    /* RESET & PAGE SETUP */
    html, body { margin:0; padding:0; background:#333; }
    body { font-family:'Roboto',sans-serif; }
    @page { size:960px 540px; margin:0; }
    @media print { .page { page-break-after: always; } }

    /* PAGE CONTAINER */
    .page {
      position:relative;
      width:960px; height:540px;
      margin:20px auto; background:#fff;
      overflow:hidden; box-sizing:border-box;
    }

    /* HEADER & FOOTER */
    .header, .footer {
      position:absolute; left:0; right:0;
      display:flex; justify-content:space-between; align-items:center;
      padding:0 30px; background:#fff; z-index:10;
    }
    .header { top:0; height:80px; border-bottom:1px solid #40a3a3; }
    .header img { height:60px; }
    .footer {
      bottom:0; height:60px; border-top:1px solid #40a3a3;
      color:#007c91; font-size:14px;
    }

    /* CONTENT WINDOW */
    .page > .content {
      position:absolute;
      top:80px; bottom:60px;
      left:0; right:0;
      overflow:hidden; box-sizing:border-box;
    }
    .content > * { width:100%; height:100%; position:relative; }

    /* HERO */
    .page.hero { overflow:hidden; }
    .page.hero > .hero {
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
    }
    .page.hero .bg {
      position:absolute; inset:0;
      width:100%; height:100%; object-fit:cover;
    }
    .hero-content {
      position:relative; z-index:1;
      display:flex; flex-direction:column; align-items:left; justify-content:center;
      color:#fff; text-align:left; padding:0 30px; box-sizing:border-box;
    }
    .hero-content h1 { font-size:3.5rem; margin:0; }
    .hero-content .subtitle { font-size:1rem; margin-top:0; opacity:.85; font-style:italic; }
    .hero-logo {
      position:absolute; bottom:30px; right:30px; height:100px;
    }

    /* BANNERS */
    .banner { position:relative; overflow:hidden; }
    .banner-bg { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; }
    .banner-text {
      position:absolute; left:30px; bottom:20px;
      font-size:1.25rem; font-weight:400; color:#4C4C4C; z-index:1;
    }
    .banner-super {
      font-size:1rem; color:#007c91; font-weight:400;
      opacity:0.85; margin-bottom:6px; letter-spacing:0.03em; font-style:italic;
    }

    /* PROGRAM DETAILS BOX */
    .banner-box {
      position:absolute; top:50%; left:50%;
      transform:translate(-50%,-50%);
      color:#000; text-align:left;
      display:flex; flex-direction:column; align-items:flex-start;
      padding:0 30px;
    }
    .banner-box h1 {
      margin:0; font-size:3.5rem; color:#007c91;
      font-weight:700; text-transform:uppercase; white-space:nowrap;
    }
    .program-subtitle {
      margin-top:3px; font-size:1.25rem; font-style:italic;
      color:#007c91; opacity:0.7; white-space:nowrap;
    }
    .meta-banner { margin-top:70px; font-size:1rem; line-height:1.6; }
    .meta-line { color:#4C4C4C; font-size:1rem; opacity:0.85; }
    .meta-value { padding-left:12px; }

    /* CHARTS */
    .chart-fullpage { display:flex; align-items:center; justify-content:center; padding:20px; }
    .chart-full { width:100%; height:100%; }
    .chart-grid {
      display:grid; grid-template-columns:1fr 1fr; gap:20px; padding:20px;
    }
    .chart-box { width:100%; height:100%; }

    /* TEXT PAGES */
    .text-page { padding:20px; box-sizing:border-box; }
    .text-question {
      background:#f9f9f9; border:1px solid #007c91;
      padding:10px; box-sizing:border-box;
      max-width:calc(100% - 40px); max-height:360px;
      overflow:visible; page-break-inside:avoid; break-inside:avoid;
      margin:20px auto;
    }
    .text-question-title {
      font-size:1.2rem; font-weight:bold; margin-bottom:12px; color:#007c91;
    }
    .text-question ul { padding-left:16px; font-size:0.75rem; line-height:1.6; }
    .text-question li { margin-bottom:8px; }

    /* SECTION TITLE */
    .header .section-title {
      text-transform:uppercase; color:#007c91;
      font-weight:600; letter-spacing:0.05em; font-size:1rem; font-style:italic;
    }

    /* HIDE HEADER/FOOTER ON HERO */
    .page.hero > .header,
    .page.hero > .footer { display:none; }
    .page.hero > .content { top:0; bottom:0; }
  </style>
</head>
<body>
  <button id="gerar-pdf">Gerar Relatório (PDF)</button>
  <div id="report"></div>

  <script>
  const currentYear = new Date().getFullYear();

  // 1) Static texts
  const T = {
    pt: {
      gerarPdf: 'Gerar Relatório (PDF)',
      corporateTraining: 'corporate training',
      section: { assessment: 'Assessment', evaluation: 'Evaluation' },
      totalResponses: total => `Total de respostas: ${total}`,
      months: {
        '01':'janeiro','02':'fevereiro','03':'março','04':'abril',
        '05':'maio','06':'junho','07':'julho','08':'agosto',
        '09':'setembro','10':'outubro','11':'novembro','12':'dezembro'
      }
    },
    en: {
      gerarPdf: 'Generate Report (PDF)',
      corporateTraining: 'Corporate Training',
      section: { assessment: 'Assessment', evaluation: 'Evaluation' },
      totalResponses: total => `Total responses: ${total}`,
      months: {
        '01':'January','02':'February','03':'March','04':'April',
        '05':'May','06':'June','07':'July','08':'August',
        '09':'September','10':'October','11':'November','12':'December'
      }
    }
  };

  // 2) Label/ID/sort maps
  function createLabelMap(labels, lang) {
    return labels.reduce((m, item) => {
      const k = item.questionId || item['QUESTION ID'];
      m[k] = lang === 'en'
        ? (item.label_en || item.label || item['LABEL'])
        : (item.label_pt || item.label || item['LABEL_PT'] || item['LABEL']);
      return m;
    }, {});
  }
  function createIdMap(labels, lang) {
    return labels.reduce((m, item) => {
      const k = item.questionId || item['QUESTION ID'];
      m[k] = lang === 'en'
        ? (item.questionId_en || k)
        : (item.questionId_pt || k);
      return m;
    }, {});
  }
  function createSortMap(labels) {
    return labels.reduce((m, l) => {
      const k = l.questionId || l['QUESTION ID'];
      m[k] = +(l.sortOrder || l['SORT ORDER'] || l.sort_order || 0);
      return m;
    }, {});
  }

  // 3) Data helpers
  function groupBy(arr, key) {
    return arr.reduce((o, i) => ((o[i[key]] ||= []).push(i), o), {});
  }
  function computeAverages(rows, LM, OM) {
    const g = {};
    rows.forEach(r => (g[r.question] ||= []).push(+r.value));
    return Object.entries(g).map(([q, vals]) => ({
      question: q,
      label: LM[q] || q,
      avg: +(vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(1)
    })).sort((a,b)=> (OM[a.question]||0)-(OM[b.question]||0));
  }
  function countUnique(rows, sec) {
    return new Set(
      rows.filter(d => String(d.section||'').toLowerCase().includes(sec))
          .map(d => d['Submission ID'])
    ).size;
  }
  function formatMonthYear(v, lang) {
    const [year, mon] = v.split('-');
    return { month: T[lang].months[mon], year };
  }

  // 4) Chart & text‐page builders
  function createBarChart(container, title, data, uniform) {
    const chart = echarts.init(container, null, { renderer:'svg' });
    chart.setOption({
      title:{ text:title, left:'center', textStyle:{fontSize:20} },
      grid:{ top:80,left:'10%',right:'10%',bottom:120 },
      tooltip:{},
      xAxis:{ type:'category', data:data.map(d=>d.label),
        axisLabel:{ rotate:30, interval:0, margin:10 } },
      yAxis:{ type:'value', min:1, max:5, splitLine:{show:false},
        axisLine:{show:false}, axisTick:{show:false}, axisLabel:{show:false} },
      series:[{
        type:'bar',
        data:data.map(d=>d.avg),
        label:{ show:true, position:'top', formatter:'{c}' },
        itemStyle: uniform
          ? { color:'#6A99D0' }
          : { color:p=>p.value<3?'#EA3323':p.value<4?'#6A99D0':'#9FCE63' }
      }]
    });
    chart.resize();
  }
  function createTextPage(secTitle, displayId) {
    const tp = document.createElement('div');
    tp.className = 'page text-page';
    tp.innerHTML = `
      <div class="header">
        <img src="mind4time-logo.png">
        <div class="section-title">${secTitle}</div>
      </div>
      <div class="content">
        <div class="text-question">
          <div class="text-question-title">${displayId}</div>
          <ul class="answer-list"></ul>
        </div>
      </div>
      <div class="footer">
        <div>www.MIND4TIME.com</div>
        <div>© MIND4TIME ${currentYear}</div>
      </div>`;
    return tp;
  }

  // 5) Build
  async function build() {
    const f = JSON.parse(localStorage.getItem('reportFilters') || '{}');

    // 1️⃣ fetch data + meta
    const [data, meta] = await Promise.all([
      fetch('data.json').then(r => r.json()),
      fetch('meta.json').then(r => r.json())
    ]);

    // 2️⃣ detect lang from first row of data.json
    const lang = (data[0] && data[0].lang === 'en') ? 'en' : 'pt';
    const tx   = T[lang];

    // 3️⃣ update button
    document.getElementById('gerar-pdf').textContent = tx.gerarPdf;

    // 4️⃣ build maps
    const LM = createLabelMap(meta.labels, lang);
    const IM = createIdMap(meta.labels,   lang);
    const OM = createSortMap(meta.labels);

    // 5️⃣ clear and render
    const root = document.getElementById('report');
    root.innerHTML = '';

    for (const prog of f.programs || []) {
      // TIME SCOPE
      let timeScope = '';
      const start = (f.starts||{})[prog], end = (f.ends||{})[prog];
      if (start && end) {
        const s = formatMonthYear(start, lang),
              e = formatMonthYear(end,   lang);
        timeScope = `${s.month} – ${e.month} ${e.year}`;
      }

      // HERO
      const hero = document.createElement('div');
      hero.className = 'page hero';
      hero.innerHTML = `
        <div class="hero">
          <img class="bg" src="hourglass-bg.jpg">
          <div class="hero-content">
            <h1>${tx.title || 'TRAINING REPORT'}</h1>
            <div class="subtitle">${timeScope}</div>
          </div>
          <img class="hero-logo" src="Logo.png">
        </div>`;
      root.appendChild(hero);

      // PROGRAM DETAILS
      const pm = meta.titles.find(t=>t.program_id===prog) || {};
      const title    = lang==='en' ? (pm.title_en||pm.TÍTULO||prog) : (pm.title_pt||pm.TÍTULO||prog);
      const subtitle = lang==='en' ? (pm.subtitle_en||pm.SUBTÍTULO||'') : (pm.subtitle_pt||pm.SUBTÍTULO||'');
      const bannerImg = prog.toLowerCase()==='p365'
        ? 'p365-banner.png'
        : prog.toLowerCase()==='colab365'
          ? 'colab365-banner.png'
          : 'p365-banner.png';
      const info = document.createElement('div');
      info.className = 'page';
      info.innerHTML = `
        <div class="header"><img src="mind4time-logo.png"><div></div></div>
        <div class="content">
          <div class="banner">
            <img class="banner-bg" src="${bannerImg}">
            <div class="banner-box">
              <div class="banner-super">${tx.corporateTraining}</div>
              <h1>${title}</h1>
              <div class="program-subtitle">${subtitle}</div>
              <div class="meta-banner">
                <div class="meta-line">Scope temporal:<span class="meta-value">${timeScope}</span></div>
                <div class="meta-line">Trainers:<span class="meta-value">${(f.trainers||{})[prog]||'N/A'}</span></div>
              </div>
            </div>
          </div>
        </div>
        <div class="footer">
          <div>www.MIND4TIME.com</div><div>© MIND4TIME ${currentYear}</div>
        </div>`;
      root.appendChild(info);

      // SECTIONS
      for (const sec of ['assessment','evaluation']) {
        const secTitle = tx.section[sec];
        const rows = data.filter(d =>
          (f.clients||[]).includes(d.client) &&
          d.program === prog &&
          (f[`turmas_${prog}`]||[]).includes(d.turma)
        );
        const total   = countUnique(rows, sec);
        const numeric = rows.filter(d =>
          String(d.section||'').toLowerCase().includes(sec) &&
          /^\d+(\.\d+)?$/.test(String(d.value).trim())
        );
        const byT = Object.entries(groupBy(numeric,'turma'));

        // SECTION BANNER
        const ban = document.createElement('div'); ban.className = 'page';
        ban.innerHTML = `
          <div class="header"><img src="mind4time-logo.png"></div>
          <div class="content">
            <div class="banner">
              <img class="banner-bg" src="${sec}-bg.jpg">
              <div class="banner-text">${tx.totalResponses(total)}</div>
            </div>
          </div>
          <div class="footer">
            <div>www.MIND4TIME.com</div><div>© MIND4TIME ${currentYear}</div>
          </div>`;
        root.appendChild(ban);

        // GLOBAL CHART
        if (numeric.length) {
          const gp = document.createElement('div'); gp.className='page';
          gp.innerHTML = `
            <div class="header">
              <img src="mind4time-logo.png">
              <div class="section-title">${secTitle}</div>
            </div>
            <div class="content">
              <div class="chart-fullpage">
                <div class="chart-full" id="chart-global-${prog}-${sec}"></div>
              </div>
            </div>
            <div class="footer">
              <div>www.MIND4TIME.com</div>
              <div>© MIND4TIME ${currentYear}</div>
            </div>`;
          root.appendChild(gp);
          createBarChart(
            gp.querySelector('.chart-full'),
            'Global',
            computeAverages(numeric, LM, OM),
            sec === 'evaluation'
          );
        }

        // GRID CHARTS
        if (byT.length > 1) {
          for (let i = 0; i < byT.length; i += 2) {
            const gp2 = document.createElement('div'); gp2.className = 'page';
            const boxes = byT.slice(i, i+2)
              .map(([,v], j) => `<div class="chart-box" id="chart-${prog}-${sec}-grid-${i+j}"></div>`)
              .join('');
            gp2.innerHTML = `
              <div class="header">
                <img src="mind4time-logo.png">
                <div class="section-title">${secTitle}</div>
              </div>
              <div class="content">
                <div class="chart-grid">${boxes}</div>
              </div>
              <div class="footer">
                <div>www.MIND4TIME.com</div>
                <div>© MIND4TIME ${currentYear}</div>
              </div>`;
            root.appendChild(gp2);
            byT.slice(i, i+2).forEach(([,v], j) => {
              createBarChart(
                document.getElementById(`chart-${prog}-${sec}-grid-${i+j}`),
                byT[i+j][0],
                computeAverages(v, LM, OM),
                sec === 'evaluation'
              );
            });
          }
        }

        // TEXT ANSWERS
        (f.textQuestions||[]).forEach(qid => {
          const ans = data.filter(d =>
            (f.clients||[]).includes(d.client) &&
            d.program === prog &&
            d.question === qid &&
            String(d.section||'').toLowerCase().includes(sec) &&
            isNaN(+d.value)
          );
          if (!ans.length) return;
          const pages = [];
          let page = createTextPage(secTitle, IM[qid]||qid);
          let listEl = page.querySelector('.answer-list');
          root.appendChild(page);
          pages.push(page);
          ans.forEach(a => {
            const li = document.createElement('li');
            li.textContent = a.value;
            listEl.appendChild(li);
            const tq = page.querySelector('.text-question');
            if (tq.scrollHeight > tq.clientHeight) {
              listEl.removeChild(li);
              page = createTextPage(secTitle, IM[qid]||qid);
              listEl = page.querySelector('.answer-list');
              root.appendChild(page);
              pages.push(page);
              listEl.appendChild(li);
            }
          });
          pages.forEach(pg => {
            const tq = pg.querySelector('.text-question');
            tq.style.height = tq.scrollHeight + 'px';
          });
        });
      } // end programs loop

      // FINAL PAGE
      const endPage = document.createElement('div');
      endPage.className = 'page hero';
      endPage.innerHTML = `<div class="hero"><img class="bg" src="endpage-bg.png"></div>`;
      root.appendChild(endPage);
    }

    // 6) Generate PDF
    async function generatePdf() {
      await build();
      document.querySelectorAll('.chart-full, .chart-box').forEach(el => {
        const c = echarts.getInstanceByDom(el);
        if (c) c.resize();
      });
      await new Promise(r => setTimeout(r,100));
      const pages = Array.from(document.querySelectorAll('.page'));
      const CANVAS_SCALE = 4;
      const images = await Promise.all(pages.map(pg =>
        html2canvas(pg, { backgroundColor:'#fff', useCORS:true, scale:CANVAS_SCALE })
          .then(cv => cv.toDataURL('image/png',1.0))
      ));
      pdfMake.createPdf({
        pageSize:{width:960, height:540},
        pageMargins:[0,0,0,0],
        content: images.map((img,i) => ({
          image: img, width: 960,
          pageBreak: i<images.length-1 ? 'after' : undefined
        }))
      }).download('report.pdf');
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('gerar-pdf').addEventListener('click', generatePdf);
      build();
    });
</script>
  </script>
</body>
</html>
