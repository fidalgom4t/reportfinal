<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8"/>
  <title>Training Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- Roboto & ECharts -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

  <!-- html2canvas & pdfMake -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

  <style>
    /* RESET & PAGE SETUP */
    html, body { margin: 0; padding: 0; background: #333; }
    body { font-family: 'Roboto', sans-serif; }
    @page { size: 960px 540px; margin: 0; }
    @media print { .page { page-break-after: always; } }

    /* PAGE CONTAINER */
    .page {
      position: relative;
      width: 960px; height: 540px;
      margin: 20px auto; background: #fff;
      overflow: hidden; box-sizing: border-box;
    }

    /* HEADER & FOOTER */
    .header, .footer {
      position: absolute; left: 0; right: 0;
      display: flex; justify-content: space-between; align-items: center;
      padding: 0 30px; background: #fff; z-index: 10;
    }
    .header { top: 0; height: 80px; border-bottom: 1px solid #40a3a3; }
    .header img { height: 60px; }
    .footer {
      bottom: 0; height: 60px; border-top: 1px solid #40a3a3;
      color: #007c91; font-size: 14px;
    }

    /* CONTENT WINDOW (960×400 minus 20px bottom padding) */
    .page > .content {
      position: absolute;
      top: 80px; bottom: 80px; /* 60px footer + 20px breathing */
      left: 0; right: 0;
      overflow: hidden; box-sizing: border-box;
    }

    /* FILL CONTENT */
    .content > .hero,
    .content > .banner,
    .content > .chart-fullpage,
    .content > .chart-grid,
    .content > .text-page {
      width: 100%; height: 100%; box-sizing: border-box;
      position: relative;
    }

    /* HERO (full‑bleed, no header/footer) */
    .page.hero { overflow: hidden; }
    .page.hero > .hero {
      position: absolute; inset: 0;
      display: flex; align-items: center; justify-content: center;
    }
    .page.hero .bg {
      position: absolute; inset: 0;
      width:100%; height:100%; object-fit:cover;
    }
    .hero-content {
      position: relative; z-index:1;
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      color:#fff; text-align:center;
      padding:0 30px; box-sizing:border-box;
    }
    .hero-content h1 { font-size:3.5rem; margin:0; }
    .hero-content .subtitle { font-size:1.5rem; margin-top:12px; opacity:.85; }

    /* SECTION BANNERS */
    .banner {
      position: relative; width:100%; height:100%; overflow:hidden;
    }
    .banner-bg {
      position:absolute; inset:0;
      width:100%; height:100%; object-fit:cover;
    }
    .banner-text {
      position:absolute;
      left:30px;
      bottom:20px;
      font-size:1.25rem;
      font-weight:500;
      color:#000;
      z-index:1;
    }

    /* INFO BANNER BOX (program details) */
    .banner-box {
      position: absolute; top:50%; left:50%;
      transform: translate(-50%, -50%);
      background: rgba(240,248,249,0.9);
      padding:30px 50px; box-sizing:border-box;
      border-left:6px solid #007c91;
      box-shadow:0 2px 6px rgba(0,0,0,0.1);
      color:#000;
    }
    .banner-box h1 { margin:0 0 12px; color:#007c91; font-size:2.5rem; }
    .banner-box .meta { display:flex; gap:20px; font-size:1rem; }
    .banner-box .meta span { font-weight:500; color:#000; }
    .banner-box .meta strong { color:#000; }

    /* GLOBAL CHART */
    .chart-fullpage {
      display:flex; align-items:center; justify-content:center;
      padding:20px; box-sizing:border-box;
    }
    .chart-full { width:100%; height:100%; }

    /* 2‑CHART GRID */
    .chart-grid {
      display:grid; grid-template-columns:1fr 1fr;
      gap:20px; padding:20px; box-sizing:border-box;
    }
    .chart-box { width:100%; height:100%; }

    /* TEXT ANSWERS */
    .text-page {
      overflow-y:auto; padding:20px; box-sizing:border-box;
    }
    .text-question {
      background:#f9f9f9; border:1px solid #007c91; border-left:6px solid #007c91;
      padding:20px; margin-bottom:20px; box-sizing:border-box;
      page-break-inside:avoid; break-inside:avoid;
    }
    .text-question-title {
      font-size:1.2rem; font-weight:bold; margin-bottom:12px; color:#007c91;
    }
    .text-question ul {
      padding-left:16px; font-size:0.75rem; line-height:1.6;
    }
    .text-question li { margin-bottom:8px; }

    /* SECTION TITLE IN HEADER */
    .header .section-title {
      text-transform:uppercase; color:#007c91;
      font-weight:600; letter-spacing:.05em;
      font-size:1rem; font-style:italic;
    }

    /* hide header/footer on hero */
    .page.hero > .header,
    .page.hero > .footer { display:none; }
    .page.hero > .content { top:0; bottom:0; }

    /* PDF button */
    #gerar-pdf {
      position:fixed; top:10px; right:10px; z-index:1000;
      padding:8px 16px; background:#007c91; color:#fff;
      border:none; border-radius:4px; cursor:pointer;
    }
  </style>
</head>
<body>
  <button id="gerar-pdf">Gerar Relatório (PDF)</button>
  <div id="report"></div>

 <script>
  const currentYear = new Date().getFullYear();
  const TEXT_PAGE_MAX_HEIGHT = 360; // 400px content height minus 20px padding

  function createLabelMap(labels) {
    return labels.reduce((m, l) => {
      const k = l.questionId || l['QUESTION ID'];
      m[k] = l.label || l['LABEL'];
      return m;
    }, {});
  }
  function createSortMap(labels) {
    return labels.reduce((m, l) => {
      const k = l.questionId || l['QUESTION ID'];
      m[k] = +(l.sortOrder || l['SORT ORDER'] || l.sort_order);
      return m;
    }, {});
  }
  function groupBy(arr, k) {
    return arr.reduce((o, i) => {
      (o[i[k]] ||= []).push(i);
      return o;
    }, {});
  }
  function computeAverages(rows, LM, OM) {
    const g = {};
    rows.forEach(r => (g[r.question] ||= []).push(+r.value));
    return Object.entries(g)
      .map(([q, vals]) => ({
        question: q,
        label: LM[q] || q,
        avg: +(vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(1)
      }))
      .sort((a,b) => (OM[a.question]||0) - (OM[b.question]||0));
  }
  function countUnique(rows, sec) {
    return new Set(
      rows
        .filter(d => String(d.section||'').toLowerCase().includes(sec))
        .map(d => d["Submission ID"])
    ).size;
  }
  function formatMonthYear(v) {
    const names = {
      '01':'janeiro','02':'fevereiro','03':'março','04':'abril',
      '05':'maio','06':'junho','07':'julho','08':'agosto',
      '09':'setembro','10':'outubro','11':'novembro','12':'dezembro'
    };
    const [y, m] = v.split('-');
    return { month: names[m], year: y };
  }
  function createBarChart(container, title, data, uniform) {
    const chart = echarts.init(container);
    chart.setOption({
      title: { text: title, left:'center', textStyle:{ fontSize:20 } },
      grid: { top:80, left:'10%', right:'10%', bottom:120 },
      tooltip: {},
      xAxis: {
        type:'category',
        data: data.map(d=>d.label),
        axisLabel:{ rotate:30, interval:0, margin:10 }
      },
      yAxis: {
        type:'value', min:1, max:5,
        splitLine:{ show:false },
        axisLine:{ show:false },
        axisTick:{ show:false },
        axisLabel:{ show:false }
      },
      series: [{
        type:'bar',
        data: data.map(d=>d.avg),
        label:{ show:true, position:'top', formatter:'{c}' },
        itemStyle: uniform
          ? { color:'#6A99D0' }
          : { color: p => p.value < 3 ? '#EA3323' : p.value < 4 ? '#6A99D0' : '#9FCE63' }
      }]
    });
    chart.resize();
  }

  function createTextPage(prog, sec, qid, showTitle) {
    const tp = document.createElement('div');
    tp.className = 'page text-page';
    tp.innerHTML = `
      <div class="header">
        <img src="mind4time-logo.png">
        <div class="section-title">
          ${sec === 'assessment' ? 'Assessment' : 'Evaluation'}
        </div>
      </div>
      <div class="content">
        <div class="text-page">
          <div class="text-question">
            ${showTitle ? `<div class="text-question-title">${qid}</div>` : ``}
            <ul class="answer-list"></ul>
          </div>
        </div>
      </div>
      <div class="footer">
        <div>www.MIND4TIME.com</div>
        <div>© MIND4TIME ${currentYear}</div>
      </div>`;
    return tp;
  }

  async function build() {
    const f = JSON.parse(localStorage.getItem('reportFilters')||'{}');
    const [data, meta] = await Promise.all([
      fetch('data.json').then(r=>r.json()),
      fetch('meta.json').then(r=>r.json())
    ]);
    const LM = createLabelMap(meta.labels),
          OM = createSortMap(meta.labels);
    const root = document.getElementById('report');
    root.innerHTML = '';

    let timeScope = '';
    if (f.start && f.end) {
      const s = formatMonthYear(f.start),
            e = formatMonthYear(f.end);
      timeScope = `${s.month} – ${e.month} ${e.year}`;
    }

    for (const prog of f.programs||[]) {
      const selTur = f[`turmas_${prog}`]||[];
      const rows = data.filter(d =>
        (f.clients||[]).includes(d.client) &&
        d.program === prog &&
        selTur.includes(d.turma)
      );
      const pm = meta.titles.find(t=>t.program_id===prog) || {};

      // — Hero page —
      const hero = document.createElement('div');
      hero.className = 'page hero';
      hero.innerHTML = `
        <div class="hero">
          <img class="bg" src="hourglass-bg.jpg">
          <div class="hero-content">
            <h1>${pm.TÍTULO||prog}</h1>
            <div class="subtitle">${pm.SUBTÍTULO||''}</div>
          </div>
        </div>`;
      root.appendChild(hero);

      // — Program Details banner —
      const info = document.createElement('div');
      info.className = 'page';
      info.innerHTML = `
        <div class="header">
          <img src="mind4time-logo.png"><div></div>
        </div>
        <div class="content">
          <div class="banner">
            <img class="banner-bg" src="assessment-bg.jpg">
            <div class="banner-box">
              <h1>Detalhes do Programa</h1>
              <div class="meta">
                <span>Time Scope:</span><strong>${timeScope}</strong>
                <span>Trainers:</span><strong>${(f.trainers||{})[prog]||'N/A'}</strong>
              </div>
            </div>
          </div>
        </div>
        <div class="footer">
          <div>www.MIND4TIME.com</div>
          <div>© MIND4TIME ${currentYear}</div>
        </div>`;
      root.appendChild(info);

      // — Assessment & Evaluation Sections —
      for (const sec of ['assessment','evaluation']) {
        const name = sec==='assessment' ? 'Assessment' : 'Evaluation';
        const total = countUnique(rows, sec);
        const numeric = rows.filter(d =>
          String(d.section||'').toLowerCase().includes(sec) &&
          /^\d+(\.\d+)?$/.test(String(d.value).trim())
        );
        const byT = Object.entries(groupBy(numeric,'turma'));

        // Section banner
        const ban = document.createElement('div');
        ban.className = 'page';
        ban.innerHTML = `
          <div class="header">
            <img src="mind4time-logo.png">
            <div class="section-title">${name}</div>
          </div>
          <div class="content">
            <div class="banner">
              <img class="banner-bg" src="${sec}-bg.jpg">
              <div class="banner-text">Total de respostas: ${total}</div>
            </div>
          </div>
          <div class="footer">
            <div>www.MIND4TIME.com</div>
            <div>© MIND4TIME ${currentYear}</div>
          </div>`;
        root.appendChild(ban);

        // Global chart
        if (numeric.length) {
          const gp = document.createElement('div');
          gp.className = 'page';
          gp.innerHTML = `
            <div class="header">
              <img src="mind4time-logo.png">
              <div class="section-title">${name}</div>
            </div>
            <div class="content">
              <div class="chart-fullpage">
                <div class="chart-full" id="chart-global-${prog}-${sec}"></div>
              </div>
            </div>
            <div class="footer">
              <div>www.MIND4TIME.com</div>
              <div>© MIND4TIME ${currentYear}</div>
            </div>`;
          root.appendChild(gp);
          createBarChart(
            gp.querySelector('.chart-full'),
            `Global (${name})`,
            computeAverages(numeric, LM, OM),
            sec==='evaluation'
          );
        }

        // 2‑chart grid
        if (byT.length > 1) {
          for (let i = 0; i < byT.length; i += 2) {
            const gp2 = document.createElement('div');
            gp2.className = 'page';
            const boxes = byT.slice(i,i+2)
              .map(([,v],j) => `<div class="chart-box" id="chart-${prog}-grid-${i+j}"></div>`)
              .join('');
            gp2.innerHTML = `
              <div class="header">
                <img src="mind4time-logo.png">
                <div class="section-title">${name}</div>
              </div>
              <div class="content">
                <div class="chart-grid">${boxes}</div>
              </div>
              <div class="footer">
                <div>www.MIND4TIME.com</div>
                <div>© MIND4TIME ${currentYear}</div>
              </div>`;
            root.appendChild(gp2);
            byT.slice(i,i+2).forEach(([,v],j) => {
              createBarChart(
                document.getElementById(`chart-${prog}-grid-${i+j}`),
                byT[i+j][0],
                computeAverages(v, LM, OM),
                sec==='evaluation'
              );
            });
          }
        }

        // Text answers with height‑based paging
        const selQs = f.textQuestions||[];
        selQs.forEach(qid => {
          const ans = rows.filter(d =>
            String(d.section||'').toLowerCase().includes(sec) &&
            d.question===qid && isNaN(+d.value)
          );
          if (!ans.length) return;

          let page = createTextPage(prog, sec, qid, true);
          let listEl = page.querySelector('.answer-list');
          root.appendChild(page);

          ans.forEach(a => {
            const li = document.createElement('li');
            li.textContent = a.value;
            listEl.appendChild(li);

            // if it overflows its box, start a new page
            const container = page.querySelector('.content .text-page');
            if (listEl.scrollHeight > TEXT_PAGE_MAX_HEIGHT) {
              listEl.removeChild(li);
              page = createTextPage(prog, sec, qid, false);
              root.appendChild(page);
              listEl = page.querySelector('.answer-list');
              listEl.appendChild(li);
            }
          });
        });

      } // end sections
    } // end build()

    async function generatePdf(){
      await build();
      // resize all charts one more time
      document.querySelectorAll('.chart-full, .chart-box').forEach(el => {
        const c = echarts.getInstanceByDom(el);
        if (c) c.resize();
      });
      // small delay
      await new Promise(r=>setTimeout(r,100));

      const pages = Array.from(document.querySelectorAll('.page'));
      const images = await Promise.all(pages.map(pg =>
        html2canvas(pg, {
          backgroundColor:'#fff',
          useCORS:true,
          scale:3
        }).then(c => c.toDataURL('image/png',1.0))
      ));

      pdfMake.createPdf({
        pageSize: { width:960, height:540 },
        pageMargins: [0,0,0,0],
        content: images.map((img,i)=>({
          image: img,
          width: 960,
          pageBreak: i < images.length-1 ? 'after' : undefined
        }))
      }).download('report.pdf');
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('gerar-pdf').addEventListener('click', generatePdf);
      build();
    });
</script>
</body>
</html>
