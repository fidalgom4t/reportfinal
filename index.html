<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Relatório de Formação</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 30px;
      background-color: #fff;
      color: #333;
    }
    header {
      display: flex;
      align-items: center;
      border-bottom: 2px solid #007c91;
      padding-bottom: 10px;
      margin-bottom: 30px;
    }
    .logo-text {
      font-size: 20px;
      font-weight: bold;
      color: #007c91;
      margin-left: 15px;
    }
    select {
      margin: 10px;
      padding: 5px;
    }
    .chart-container {
      width: 100%;
      height: 400px;
      margin-bottom: 40px;
    }
    .turma-title {
      font-size: 18px;
      font-weight: bold;
      margin-top: 40px;
      margin-bottom: 10px;
      color: #007c91;
    }
    .text-question {
      border: 1px solid #007c91;
      border-left: 6px solid #007c91;
      padding: 16px;
      margin-bottom: 30px;
      background: #f9f9f9;
    }
    .text-question-title {
      font-weight: bold;
      margin-bottom: 8px;
      font-size: 16px;
      color: #007c91;
    }
    .toggle-btns button {
      margin: 5px;
      padding: 8px 16px;
      border: none;
      background-color: #007c91;
      color: #fff;
      cursor: pointer;
    }
    .toggle-btns button.active {
      background-color: #005c6b;
    }
    .filter-group {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Logo" height="50">
    <div class="logo-text">MIND4TIME<br><span style="font-weight: normal; font-size: 14px;">Productivity Consulting</span></div>
  </header>

  <h1>Relatório de Formação</h1>

  <div class="filter-group">
    <label>Cliente:</label>
    <select id="clientSelect"></select>

    <label>Turmas:</label>
    <select id="turmaSelect" multiple></select>

    <label>Perguntas Abertas:</label>
    <select id="textQuestionSelect" multiple></select>
  </div>

  <div class="toggle-btns" id="programButtons"></div>

  <div id="reportContainer"></div>

  <script>
    let rawData = [];
    let currentProgram = null;
    const reportContainer = document.getElementById('reportContainer');

    fetch('data.json')
      .then(res => res.json())
      .then(data => {
        rawData = data;
        populateClientFilter();
      });

    function fillSelect(id, values, multiple = false) {
      const select = document.getElementById(id);
      select.innerHTML = '';
      values.forEach(val => {
        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = val.length > 50 ? val.slice(0, 47) + '…' : val;
        select.appendChild(opt);
      });
    }

    function getSelected(id) {
      return Array.from(document.getElementById(id).selectedOptions).map(o => o.value);
    }

    function populateClientFilter() {
      const clients = [...new Set(rawData.map(d => d.client))].sort();
      fillSelect("clientSelect", clients);
      document.getElementById("clientSelect").onchange = () => {
        const selectedClient = document.getElementById("clientSelect").value;
        const filtered = rawData.filter(d => d.client === selectedClient);
        const programs = [...new Set(filtered.map(d => d.program))].sort();

        // Create toggle buttons for programs
        const programBtns = document.getElementById("programButtons");
        programBtns.innerHTML = '';
        programs.forEach(p => {
          const btn = document.createElement("button");
          btn.textContent = p;
          btn.className = "toggle-btn";
          btn.onclick = () => setProgram(p);
          programBtns.appendChild(btn);
        });

        // default selection
        setProgram(programs[0]);
      };
    }

    function setProgram(program) {
      currentProgram = program;
      const client = document.getElementById("clientSelect").value;
      const filtered = rawData.filter(d => d.client === client && d.program === program);
      const turmas = [...new Set(filtered.map(d => d.turma))].sort();
      const textQs = [...new Set(filtered.filter(d => typeof d.value !== 'number').map(d => d.question))].sort();

      fillSelect("turmaSelect", turmas, true);
      fillSelect("textQuestionSelect", textQs, true);

      document.getElementById("turmaSelect").onchange = renderReport;
      document.getElementById("textQuestionSelect").onchange = renderReport;
      renderReport();
    }

    function renderReport() {
      const client = document.getElementById("clientSelect").value;
      const turmas = getSelected("turmaSelect");
      const selectedTextQs = getSelected("textQuestionSelect");
      const sectionData = rawData.filter(d =>
        d.client === client &&
        d.program === currentProgram &&
        (!turmas.length || turmas.includes(d.turma))
      );

      const assessments = sectionData.filter(d => d.section === 'assessment');
      const evaluations = sectionData.filter(d => d.section === 'evaluation');

      reportContainer.innerHTML = '';

      if (assessments.length > 0) {
        addSection('Assessment', assessments, turmas, selectedTextQs, true);
      }
      if (evaluations.length > 0) {
        addSection('Avaliação', evaluations, turmas, selectedTextQs, false);
      }
    }

    function addSection(title, data, turmas, textQs, useHeatmap) {
      const titleEl = document.createElement('h2');
      titleEl.textContent = `${title} - ${currentProgram}`;
      reportContainer.appendChild(titleEl);

      const chartDiv = document.createElement('div');
      chartDiv.className = 'chart-container';
      chartDiv.id = `${title}-overall`; 
      if (turmas.length > 1) reportContainer.appendChild(chartDiv);

      const turmaContainer = document.createElement('div');
      reportContainer.appendChild(turmaContainer);

      const byTurma = {};
      const overall = {};

      data.forEach(({ turma, question, value }) => {
        if (typeof value === 'number') {
          if (!byTurma[turma]) byTurma[turma] = {};
          if (!byTurma[turma][question]) byTurma[turma][question] = [];
          byTurma[turma][question].push(value);

          if (!overall[question]) overall[question] = [];
          overall[question].push(value);
        }
      });

      if (turmas.length > 1) {
        const overallData = Object.entries(overall).map(([q, vals]) => ({
          question: q,
          average: vals.reduce((a, b) => a + b, 0) / vals.length
        }));
        drawBarChart(`${title}-overall`, overallData, useHeatmap);
      }

      Object.entries(byTurma).forEach(([turma, questions], i) => {
        const chartId = `${title}-turma-${i}`;
        const title = document.createElement("div");
        title.className = "turma-title";
        title.textContent = `Turma: ${turma}`;
        const div = document.createElement("div");
        div.id = chartId;
        div.className = "chart-container";
        turmaContainer.appendChild(title);
        turmaContainer.appendChild(div);

        const chartData = Object.entries(questions).map(([q, vals]) => ({
          question: q,
          average: vals.reduce((a, b) => a + b, 0) / vals.length
        }));
        drawBarChart(chartId, chartData, useHeatmap);
      });

      const textData = data.filter(d => typeof d.value !== 'number' && textQs.includes(d.question));
      const textDiv = document.createElement('div');
      reportContainer.appendChild(textDiv);
      const byQuestion = {};
      textData.forEach(d => {
        if (!byQuestion[d.question]) byQuestion[d.question] = [];
        byQuestion[d.question].push(d.value);
      });

      Object.entries(byQuestion).forEach(([q, answers]) => {
        const box = document.createElement("div");
        box.className = "text-question";
        const title = document.createElement("div");
        title.className = "text-question-title";
        title.textContent = q;
        const ul = document.createElement("ul");
        answers.forEach(txt => {
          const li = document.createElement("li");
          li.textContent = txt;
          ul.appendChild(li);
        });
        box.appendChild(title);
        box.appendChild(ul);
        textDiv.appendChild(box);
      });
    }

    function drawBarChart(containerId, data, useHeatmap) {
      const chart = echarts.init(document.getElementById(containerId));
      const questions = data.map(d => d.question);
      const values = data.map(d => d.average);
      const color = useHeatmap
        ? val => val.value < 3 ? '#d94e5d' : val.value < 4 ? '#f2c037' : '#61c277'
        : '#61c277';

      chart.setOption({
        tooltip: {},
        xAxis: { type: 'category', data: questions, axisLabel: { rotate: 30 } },
        yAxis: { type: 'value', min: 0, max: 5, axisLabel: { show: false } },
        series: [{
          type: 'bar',
          data: values,
          itemStyle: { color },
          label: { show: true, position: 'top', formatter: '{c}' }
        }]
      });
    }
  </script>
</body>
</html>
