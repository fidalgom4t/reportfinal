<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Selecionar Filtros</title>
  <style>
    /* === Geral === */
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f5f5f5;
      margin: 40px auto;
      max-width: 800px;
      padding: 0 20px;
    }
    h2 {
      text-align: center;
      color: #007c91;
      margin-bottom: 24px;
    }
    form {
      display: grid;
      grid-template-columns: 200px 1fr;
      gap: 20px;
      align-items: center;
    }
    label { font-weight: bold; }

    /* === Dropdown Multiselect === */
    .dropdown-multiselect {
      position: relative;
      width: 100%;
    }
    .select-box {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 8px 12px;
      cursor: pointer;
      user-select: none;
      position: relative;
    }
    .select-box::after {
      content: '▾';
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #666;
      font-size: 12px;
    }
    .checkboxes {
      display: none;
      position: absolute;
      top: calc(100% + 4px);
      width: 100%;
      max-height: 180px;
      overflow-y: auto;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      z-index: 10;
    }
    .dropdown-multiselect.open .checkboxes { display: block; }
    .checkboxes label {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
      cursor: pointer;
    }
    .checkboxes input { margin-right: 8px; }
    .select-all {
      background: none;
      border: none;
      color: #007c91;
      cursor: pointer;
      display: block;
      margin-bottom: 8px;
      padding: 0;
      text-align: left;
      width: 100%;
      font-size: 0.9em;
    }

    /* === Blocos de Programa === */
    .program-block {
      grid-column: span 2;
      border: 1px solid #ddd;
      padding: 16px;
      border-radius: 4px;
      background: #fff;
      margin-top: 20px;
    }
    .program-header {
      font-size: 1.1em;
      margin-bottom: 12px;
      color: #007c91;
    }
    .program-grid {
      display: grid;
      grid-template-columns: 200px 1fr;
      gap: 10px 20px;
      align-items: center;
    }

    /* === Botões === */
    .submit-row {
      grid-column: span 2;
      text-align: center;
      margin-top: 30px;
    }
    .link-button {
      background: #007c91;
      color: #fff;
      padding: 10px 30px;
      border-radius: 4px;
      text-decoration: none;
      font-weight: bold;
      margin: 0 10px;
    }
  </style>
</head>
<body>
  <h2>Gerar Relatório Dinâmico</h2>
  <form id="filtersForm" onsubmit="return false;">

    <!-- === Filtros Principais === -->
    <label>Cliente:</label>
    <div class="dropdown-multiselect" id="clientWrapper">
      <div class="select-box" id="clientBox" data-placeholder="Selecionar cliente(s)">Selecionar cliente(s)</div>
      <div class="checkboxes" id="clientChecks"></div>
    </div>

    <label>Programas:</label>
    <div class="dropdown-multiselect" id="programWrapper">
      <div class="select-box" id="programBox" data-placeholder="Selecionar programa(s)">Selecionar programa(s)</div>
      <div class="checkboxes" id="programChecks"></div>
    </div>

    <label>Cliente Info:</label>
    <div class="dropdown-multiselect" id="clientInfoWrapper">
      <div class="select-box" id="clientInfoBox" data-placeholder="Selecionar info(s)">Selecionar info(s)</div>
      <div class="checkboxes" id="clientInfoChecks"></div>
    </div>

    <!-- === Containers Dinâmicos por Programa === -->
    <div id="programsContainer"></div>

    <div class="submit-row">
      <button type="button" class="link-button" id="viewReport">Ver Relatório</button>
      <button type="button" class="link-button" id="downloadReport">Download Relatório</button>
    </div>
  </form>

  <script>
    // ===== Variáveis Globais =====
    let rawData = [];
    const getStorage = () => JSON.parse(localStorage.getItem('filters') || '{}');
    const saveStorage = (key, value) => {
      const store = getStorage();
      store[key] = value;
      localStorage.setItem('filters', JSON.stringify(store));
    };
    const load = key => getStorage()[key] || [];
    const getChecked = containerId => 
      Array.from(document.querySelectorAll(`#${containerId} input:checked`))
           .map(input => input.value);
    const updateBox = (boxId, values, placeholder) => {
      const box = document.getElementById(boxId);
      box.textContent = values.length ? values.join(', ') : placeholder;
    };

    // ===== Helpers de UI =====
    function toggleDropdown(id) {
      document.querySelectorAll('.dropdown-multiselect').forEach(el => {
        if (el.id !== id) el.classList.remove('open');
      });
      document.getElementById(id).classList.toggle('open');
    }

    function attachDropdownListeners(keys) {
      keys.forEach(key => {
        const wrapper = document.getElementById(`${key}Wrapper`);
        const box = wrapper.querySelector('.select-box');
        box.addEventListener('click', e => {
          e.stopPropagation();
          toggleDropdown(`${key}Wrapper`);
        });
      });
      document.addEventListener('click', e => {
        if (!e.target.closest('.dropdown-multiselect')) {
          document.querySelectorAll('.dropdown-multiselect').forEach(el => el.classList.remove('open'));
        }
      });
    }

    function populateCheckboxes({ containerId, boxId, items, storageKey, placeholder, onChange }) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';

      // Botões selecionar tudo/nada
      ['Selecionar tudo', 'Desmarcar tudo'].forEach((text, i) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'select-all';
        btn.textContent = text;
        btn.addEventListener('click', e => {
          e.stopPropagation();
          saveStorage(storageKey, i === 0 ? [...items] : []);
          onChange();
        });
        container.appendChild(btn);
      });

      const stored = load(storageKey);
      items.forEach(item => {
        const label = document.createElement('label');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = item;
        checkbox.checked = stored.includes(item);
        checkbox.addEventListener('change', () => {
          saveStorage(storageKey, getChecked(containerId));
          onChange();
        });
        label.append(checkbox, ` ${item}`);
        container.appendChild(label);
      });

      updateBox(boxId, stored, placeholder);
    }

    // ===== Carregamento de Dados e Filtros =====
    function populateClients() {
      const clients = [...new Set(rawData.map(d => d.client))].sort();
      populateCheckboxes({
        containerId: 'clientChecks',
        boxId: 'clientBox',
        items: clients,
        storageKey: 'clients',
        placeholder: 'Selecionar cliente(s)',
        onChange: refreshAll
      });
    }

    function populatePrograms() {
      const selectedClients = load('clients');
      const programs = [...new Set(
        rawData
          .filter(d => selectedClients.includes(d.client))
          .map(d => d.program)
      )].sort();
      populateCheckboxes({
        containerId: 'programChecks',
        boxId: 'programBox',
        items: programs,
        storageKey: 'programs',
        placeholder: 'Selecionar programa(s)',
        onChange: refreshAll
      });
    }

    function populateClientInfos() {
      const selectedClients = load('clients');
      const selectedPrograms = load('programs');
      const infos = [...new Set(
        rawData
          .filter(d =>
            selectedClients.includes(d.client) &&
            selectedPrograms.includes(d.program)
          )
          .map(d => d.client_info)
      )].sort();
      populateCheckboxes({
        containerId: 'clientInfoChecks',
        boxId: 'clientInfoBox',
        items: infos,
        storageKey: 'clientInfos',
        placeholder: 'Selecionar info(s)',
        onChange: refreshAll
      });
    }

    // ===== Blocos Dinâmicos por Programa =====
    function getTextQuestionsFor(program) {
      const filter = getStorage();
      const selectedClients = filter.clients || [];
      const selectedInfos = filter.clientInfos || [];
      const questions = new Set();

      rawData.forEach(d => {
        if (
          selectedClients.includes(d.client) &&
          selectedInfos.includes(d.client_info) &&
          d.program === program &&
          isNaN(+d.value)
        ) {
          questions.add(d.question);
        }
      });

      return Array.from(questions).sort();
    }

    function renderProgramBlocks() {
      const container = document.getElementById('programsContainer');
      container.innerHTML = '';

      const filter = getStorage();
      const selectedClients = filter.clients || [];
      const selectedInfos = filter.clientInfos || [];

      (filter.programs || []).forEach(program => {
        const block = document.createElement('div');
        block.className = 'program-block';

        // Cabeçalho
        const header = document.createElement('div');
        header.className = 'program-header';
        header.textContent = `Programa: ${program}`;
        block.appendChild(header);

        // Grid interno
        const grid = document.createElement('div');
        grid.className = 'program-grid';

        // Formador
        const lblTrainer = document.createElement('label');
        lblTrainer.textContent = `Formador:`;
        const inpTrainer = document.createElement('input');
        inpTrainer.type = 'text';
        inpTrainer.placeholder = `Nome do formador`;
        inpTrainer.value = (filter.trainers || {})[program] || '';
        inpTrainer.addEventListener('input', () => {
          const s = getStorage();
          s.trainers = s.trainers || {};
          s.trainers[program] = inpTrainer.value;
          localStorage.setItem('filters', JSON.stringify(s));
        });
        grid.append(lblTrainer, inpTrainer);

        // Datas (Início/Fim)
        ['start', 'end'].forEach(key => {
          const lblDate = document.createElement('label');
          lblDate.textContent = `${key === 'start' ? 'Início' : 'Fim'} :`;
          const inpDate = document.createElement('input');
          inpDate.type = 'month';
          inpDate.value = ((f => f[`${key}s`] || {})(filter))[program] || '';
          inpDate.addEventListener('change', () => {
            const s = getStorage();
            s[`${key}s`] = s[`${key}s`] || {};
            s[`${key}s`][program] = inpDate.value;
            localStorage.setItem('filters', JSON.stringify(s));
          });
          grid.append(lblDate, inpDate);
        });

        // Turmas
        const turmaWrapperId = `turmaWrapper_${program}`;
        const turmaBoxId = `turmaBox_${program}`;
        const turmaChecksId = `turmaChecks_${program}`;
        grid.append( createDropdownField('Turmas', program, turmaWrapperId, turmaBoxId, turmaChecksId, 'Selecionar turma(s)', () => {
          const turmas = [...new Set(
            rawData
              .filter(d =>
                d.program === program &&
                selectedClients.includes(d.client) &&
                selectedInfos.includes(d.client_info)
              )
              .map(d => d.turma)
          )].sort();
          populateCheckboxes({
            containerId: turmaChecksId,
            boxId: turmaBoxId,
            items: turmas,
            storageKey: `turmas_${program}`,
            placeholder: 'Selecionar turma(s)',
            onChange: () => updateBox(turmaBoxId, getChecked(turmaChecksId), 'Selecionar turma(s)')
          });
          updateBox(turmaBoxId, load(`turmas_${program}`), 'Selecionar turma(s)');
        }));

        // Perguntas Abertas
        const textWrapperId = `textWrapper_${program}`;
        const textBoxId = `textBox_${program}`;
        const textChecksId = `textChecks_${program}`;
        grid.append( createDropdownField('Perguntas Abertas', program, textWrapperId, textBoxId, textChecksId, 'Selecionar perguntas', () => {
          const questions = getTextQuestionsFor(program);
          populateCheckboxes({
            containerId: textChecksId,
            boxId: textBoxId,
            items: questions,
            storageKey: `textQuestions_${program}`,
            placeholder: 'Selecionar perguntas',
            onChange: () => updateBox(textBoxId, getChecked(textChecksId), 'Selecionar perguntas')
          });
          updateBox(textBoxId, load(`textQuestions_${program}`), 'Selecionar perguntas');
        }));

        block.appendChild(grid);
        container.appendChild(block);
      });
    }

    // ===== Função Auxiliar para Dropdown Dinâmico =====
    function createDropdownField(labelText, program, wrapperId, boxId, checksId, placeholder, setupCallback) {
      // Label
      const label = document.createElement('label');
      label.textContent = `${labelText}:`;

      // Wrapper
      const wrapper = document.createElement('div');
      wrapper.className = 'dropdown-multiselect';
      wrapper.id = wrapperId;

      // Box
      const box = document.createElement('div');
      box.className = 'select-box';
      box.id = boxId;
      box.dataset.placeholder = placeholder;
      box.textContent = placeholder;
      box.addEventListener('click', e => {
        e.stopPropagation();
        toggleDropdown(wrapperId);
        setupCallback();
      });

      // Checkboxes container
      const checks = document.createElement('div');
      checks.className = 'checkboxes';
      checks.id = checksId;

      wrapper.append(box, checks);
      return [label, wrapper];
    }

    // ===== Atualização Completa =====
    function refreshAll() {
      populatePrograms();
      populateClientInfos();
      renderProgramBlocks();
    }

    // ===== Navegação =====
    function navigateToReport(download) {
      localStorage.setItem('reportFilters', JSON.stringify(getStorage()));
      window.location.href = `report.html${download ? '?download=true' : ''}`;
    }

    // ===== Inicialização =====
    function init() {
      attachDropdownListeners(['client', 'program', 'clientInfo']);
      fetch('data.json')
        .then(res => res.json())
        .then(data => {
          rawData = data;
          populateClients();
          refreshAll();
          document.getElementById('viewReport').addEventListener('click', () => navigateToReport(false));
          document.getElementById('downloadReport').addEventListener('click', () => navigateToReport(true));
        })
        .catch(err => console.error('Erro ao carregar data.json:', err));
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
