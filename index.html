<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Relatório Multi-Programa</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 30px;
      color: #333;
    }
    .program-section {
      page-break-after: always;
      border-bottom: 2px solid #ccc;
      margin-bottom: 60px;
    }
    .executive-summary {
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #aaa;
    }
    .chart-container {
      width: 100%;
      height: 400px;
      margin-bottom: 40px;
    }
    .turma-title {
      font-weight: bold;
      color: #007c91;
      margin-top: 20px;
      margin-bottom: 10px;
    }
    .text-question {
      border: 1px solid #007c91;
      border-left: 6px solid #007c91;
      padding: 16px;
      margin-bottom: 20px;
      background: #f9f9f9;
    }
    .text-question-title {
      font-weight: bold;
      margin-bottom: 8px;
      font-size: 16px;
      color: #007c91;
    }
    .dropdown-multiselect {
      position: relative;
      display: inline-block;
      width: 300px;
      margin: 10px 0;
    }
    .dropdown-multiselect .select-box {
      border: 1px solid #ccc;
      padding: 5px;
      cursor: pointer;
      background: #fff;
    }
    .dropdown-multiselect .checkboxes {
      display: none;
      border: 1px solid #ccc;
      position: absolute;
      background-color: white;
      z-index: 1;
      max-height: 200px;
      overflow-y: auto;
      width: 100%;
    }
    .dropdown-multiselect.open .checkboxes {
      display: block;
    }
  </style>
</head>
<body>
  <h1>Relatório Completo de Formação</h1>

  <label>Cliente:</label>
  <select id="clientSelect"></select>

  <label style="margin-left:20px;">Formador:</label>
  <input type="text" id="trainerInput" placeholder="Nome do formador" />

  <label style="margin-left:20px;">Perguntas Abertas:</label>
  <div class="dropdown-multiselect" id="textWrapper">
    <div class="select-box" onclick="toggleDropdown('textWrapper')">Selecionar perguntas</div>
    <div class="checkboxes" id="textQuestionSelect"></div>
  </div>

  <div id="reportContainer"></div>

  <script>
    let rawData = [];

    fetch('data.json')
      .then(res => res.json())
      .then(data => {
        rawData = data;
        populateClientFilter();
      });

    function populateClientFilter() {
      const clients = [...new Set(rawData.map(d => d.client))];
      const clientSelect = document.getElementById("clientSelect");
      clientSelect.innerHTML = clients.map(c => `<option value="${c}">${c}</option>`).join('');
      clientSelect.onchange = generateReports;
    }

    function toggleDropdown(wrapperId) {
      document.getElementById(wrapperId).classList.toggle('open');
    }

    function fillCheckboxes(id, values) {
      const container = document.getElementById(id);
      container.innerHTML = '';
      values.forEach(val => {
        const label = document.createElement('label');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = val;
        checkbox.checked = true;
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(' ' + val));
        container.appendChild(label);
        container.appendChild(document.createElement('br'));
      });
    }

    function getChecked(id) {
      return Array.from(document.querySelectorAll(`#${id} input:checked`)).map(c => c.value);
    }

    function generateReports() {
      const client = document.getElementById("clientSelect").value;
      const trainer = document.getElementById("trainerInput").value || "N/A";
      const container = document.getElementById("reportContainer");
      container.innerHTML = '';

      const clientData = rawData.filter(d => d.client === client);
      const programs = [...new Set(clientData.map(d => d.program))];
      const textQs = [...new Set(clientData.filter(d => typeof d.value !== 'number').map(d => d.question))];
      fillCheckboxes("textQuestionSelect", textQs);
      const selectedTextQs = getChecked("textQuestionSelect");

      programs.forEach((program, idx) => {
        const programData = clientData.filter(d => d.program === program);
        const section = document.createElement('div');
        section.className = 'program-section';

        // Executive Summary
        const dates = programData.map(d => new Date(d.date));
        const minDate = dates.length ? new Date(Math.min(...dates)) : null;
        const maxDate = dates.length ? new Date(Math.max(...dates)) : null;
        const scope = minDate ? `${minDate.toLocaleDateString()} - ${maxDate.toLocaleDateString()}` : 'N/A';

        const summary = document.createElement('div');
        summary.className = 'executive-summary';
        summary.innerHTML = `
          <h2>Programa: ${program}</h2>
          <p><strong>Formador:</strong> ${trainer}</p>
          <p><strong>Período:</strong> ${scope}</p>
        `;
        section.appendChild(summary);

        ['assessment', 'evaluation'].forEach((type) => {
          const sectionData = programData.filter(d => d.section === type);
          if (!sectionData.length) return;

          const numeric = sectionData.filter(d => typeof d.value === 'number');
          const text = sectionData.filter(d => typeof d.value !== 'number');
          const turmas = [...new Set(sectionData.map(d => d.turma))];

          const heading = document.createElement('h3');
          heading.textContent = type === 'assessment' ? 'Avaliação Inicial' : 'Avaliação Final';
          section.appendChild(heading);

          if (turmas.length > 1) {
            const globalChartDiv = document.createElement('div');
            globalChartDiv.className = 'chart-container';
            section.appendChild(globalChartDiv);

            const globalData = {};
            numeric.forEach(({ question, value }) => {
              if (!globalData[question]) globalData[question] = [];
              globalData[question].push(value);
            });

            const avgData = Object.entries(globalData).map(([q, vals]) => ({
              question: q,
              average: vals.reduce((a, b) => a + b, 0) / vals.length
            }));

            setTimeout(() => drawChart(globalChartDiv, avgData, type), 50);
          }

          turmas.forEach(turma => {
            const turmaTitle = document.createElement('div');
            turmaTitle.className = 'turma-title';
            turmaTitle.textContent = `Turma: ${turma}`;
            section.appendChild(turmaTitle);

            const turmaChartDiv = document.createElement('div');
            turmaChartDiv.className = 'chart-container';
            section.appendChild(turmaChartDiv);

            const turmaData = numeric.filter(d => d.turma === turma);
            const perQ = {};
            turmaData.forEach(({ question, value }) => {
              if (!perQ[question]) perQ[question] = [];
              perQ[question].push(value);
            });

            const chartData = Object.entries(perQ).map(([q, vals]) => ({
              question: q,
              average: vals.reduce((a, b) => a + b, 0) / vals.length
            }));

            setTimeout(() => drawChart(turmaChartDiv, chartData, type), 50);
          });

          const questions = {};
          text.forEach(({ question, value }) => {
            if (selectedTextQs.includes(question)) {
              if (!questions[question]) questions[question] = [];
              questions[question].push(value);
            }
          });

          Object.entries(questions).forEach(([q, answers]) => {
            const box = document.createElement('div');
            box.className = 'text-question';
            const title = document.createElement('div');
            title.className = 'text-question-title';
            title.textContent = q;
            const ul = document.createElement('ul');
            answers.forEach(a => {
              const li = document.createElement('li');
              li.textContent = a;
              ul.appendChild(li);
            });
            box.appendChild(title);
            box.appendChild(ul);
            section.appendChild(box);
          });

        });

        container.appendChild(section);
      });
    }

    function drawChart(container, data, type) {
      if (!container) return;
      const chart = echarts.init(container);
      data.sort((a, b) => a.question.localeCompare(b.question));
      const questions = data.map(d => d.question);
      const values = data.map(d => d.average);

      chart.setOption({
        tooltip: {},
        xAxis: {
          type: 'category',
          data: questions,
          axisLabel: { rotate: 30 }
        },
        yAxis: {
          type: 'value',
          min: 0,
          max: 5
        },
        series: [{
          type: 'bar',
          data: values,
          itemStyle: {
            color: type === 'assessment'
              ? val => val.value < 3 ? '#d94e5d' : val.value < 4 ? '#f2c037' : '#61c277'
              : '#61c277'
          },
          label: {
            show: true,
            position: 'top',
            formatter: '{c}'
          }
        }]
      });
    }
  </script>
</body>
</html>
