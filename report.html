<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8"/>
  <title>Training Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- Roboto & ECharts -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <!-- html2canvas & pdfMake -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

  <style>
    body { margin:0; padding:0; font-family:'Roboto',sans-serif; background:#f5f5f5; }
    button#gerar-pdf { position:fixed; top:10px; right:10px; z-index:1000; }

    /* each .page is one PDF page */
    .page {
      background:#fff;
      width:210mm;            /* A4 width */
      min-height:148.5mm;     /* half A4 height for landscape, but allows scroll */
      margin:20px auto;
      padding:20px;
      box-shadow:0 0 5px rgba(0,0,0,0.1);
      overflow:visible;
    }
    .header, .footer {
      display:flex; justify-content:space-between; align-items:center;
      background:#fff; padding:0 10px;
    }
    .header { height:20mm; border-bottom:1px solid #40a3a3; }
    .header img { height:18mm; }
    .footer { height:10mm; border-top:1px solid #40a3a3; font-size:10pt; color:#007c91; }

    .hero { margin:20px 0; background:#333; color:#fff; text-align:center; padding:20px; position:relative; }
    .banner { margin:20px 0; background:#f0f8f9; padding:20px; position:relative; }
    .chart-fullpage { margin:20px 0; height:200px; }
    .chart-full { width:100%; height:100%; }
    .chart-grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin:20px 0; }
    .chart-box { height:150px; }
    .text-question { margin:20px 0; padding:20px; border:1px solid #007c91; background:#f9f9f9; }
  </style>
</head>
<body>
  <button id="gerar-pdf">Gerar Relatório (PDF)</button>
  <div id="report"></div>

  <script>
    const currentYear = new Date().getFullYear();

    // Helpers (same as before)...
    const createLabelMap = labels => { const m={}; labels.forEach(l=>{const k=l.questionId||l['QUESTION ID']; m[k]=l.label||l['LABEL'];}); return m; };
    const createSortMap  = labels => { const m={}; labels.forEach(l=>{const k=l.questionId||l['QUESTION ID']; m[k]=+(l.sortOrder||l['SORT ORDER']||l.sort_order);}); return m; };
    const groupBy        = (arr,key) => arr.reduce((o,i)=>(o[i[key]]?o[i[key]].push(i):(o[i[key]]=[i]),o),{});
    const computeAverages= (rows,LM,OM) => Object.entries(rows.reduce((g,{question,value})=>(g[question]||(g[question]=[])).push(+value),g={}) )
      .map(([q,vals])=>({ question:q, label:LM[q]||q, avg:+(vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(1) }))
      .sort((a,b)=> (OM[a.question]||0)-(OM[b.question]||0));
    const countUnique    = (rows,sec) => new Set(rows.filter(d=>String(d.section||'').toLowerCase().includes(sec)).map(d=>d.respondent_id||d.id)).size;
    const formatMonthYear= val => { const n={'01':'janeiro','02':'fevereiro','03':'março','04':'abril','05':'maio','06':'junho','07':'julho','08':'agosto','09':'setembro','10':'outubro','11':'novembro','12':'dezembro'}; 
      if(/^\d{4}-\d{2}$/.test(val)){ const [y,m]=val.split('-'); return {month:n[m],year:y}; } 
      const [m,y]=val.split(' '); return {month:m,year:y}; 
    };
    function createBarChart(div,title,data,uniform){
      if(!div) return;
      const chart = echarts.init(div);
      chart.setOption({
        title:{text:title,left:'center',textStyle:{fontSize:14,color:'#333'}},
        grid:{top:40,left:30,right:30,bottom:30},
        tooltip:{}, xAxis:{type:'category',data:data.map(d=>d.label),axisLabel:{rotate:30}},
        yAxis:{type:'value',min:0,max:5},
        series:[{type:'bar',data:data.map(d=>d.avg),
          label:{show:true,position:'top',formatter:'{c}'},
          itemStyle: uniform
            ? {color:'#6A99D0'}
            : {color:p=>{const v=p.value;if(v<3) return'#EA3323';if(v<4) return'#6A99D0';return'#9FCE63';}}
        }]
      });
      chart.resize(); setTimeout(()=>chart.resize(),300);
      return chart;
    }

    // Build HTML report under #report, wrapping each chunk in its own .page
    async function build(){
      const f = JSON.parse(localStorage.getItem('reportFilters')||'{}');
      const [data,meta] = await Promise.all([fetch('data.json').then(r=>r.json()),fetch('meta.json').then(r=>r.json())]);
      const LM = createLabelMap(meta.labels), OM = createSortMap(meta.labels);
      const out = document.getElementById('report'); out.innerHTML='';

      let timeScope='';
      if(f.start&&f.end){ const s=formatMonthYear(f.start), e=formatMonthYear(f.end);
        timeScope=`${s.month} – ${e.month} ${e.year}`; }

      for(const prog of f.programs||[]){
        const all = data.filter(d=> (f.clients||[]).includes(d.client) && d.program===prog && (f.turmas||[]).includes(d.turma));
        const pm  = meta.titles.find(t=>t.program_id===prog)||{};

        // --- Hero page ---
        const heroPg = document.createElement('div'); heroPg.className='page';
        heroPg.innerHTML=`
          <div class="header"><img src="mind4time-logo.png"></div>
          <div class="hero">
            <div class="hero-content">
              <small>${pm.SUBTÍTULO||''}</small>
              <h1>${pm.TÍTULO||prog}</h1>
              <div class="subtitle">${pm.TAGLINE||''}</div>
              <div class="meta">
                <span>time scope:</span><strong>${timeScope}</strong>
                <span>trainers:</span><strong>${(f.trainers||{})[prog]||'N/A'}</strong>
              </div>
            </div>
          </div>
          <div class="footer">www.MIND4TIME.com<span>© MIND4TIME ${currentYear}</span></div>
        `;
        out.appendChild(heroPg);

        // for both Assessment & Evaluation
        for(const sec of ['assessment','evaluation']){
          const name = sec==='assessment'?'Assessment':'Avaliação do Programa';
          const uniq = countUnique(all,sec);
          const numeric = all.filter(d=>String(d.section||'').toLowerCase().includes(sec)&&/^\d+(\.\d+)?$/.test(String(d.value).trim()));
          const byTurma = Object.entries(groupBy(numeric,'turma'));

          // --- Banner page ---
          const banPg = document.createElement('div'); banPg.className='page';
          banPg.innerHTML=`
            <div class="header"><img src="mind4time-logo.png"></div>
            <div class="banner">
              <div class="banner-box">
                <h1>${name}</h1>
                <div class="meta"><span>Total respostas:</span><strong>${uniq}</strong></div>
              </div>
            </div>
            <div class="footer">www.MIND4TIME.com<span>© MIND4TIME ${currentYear}</span></div>
          `;
          out.appendChild(banPg);

          // --- Global chart page ---
          if(numeric.length){
            const cPg = document.createElement('div'); cPg.className='page';
            cPg.innerHTML = `
              <div class="header"><img src="mind4time-logo.png"></div>
              <div class="chart-fullpage"><div class="chart-full" id="chart-${prog}-${sec}-global"></div></div>
              <div class="footer">www.MIND4TIME.com<span>© MIND4TIME ${currentYear}</span></div>
            `;
            out.appendChild(cPg);
            createBarChart(document.getElementById(`chart-${prog}-${sec}-global`),`Global (${name})`,computeAverages(numeric,LM,OM),sec==='evaluation');
          }

          // --- Turma grid page ---
          if(byTurma.length>1){
            const gPg = document.createElement('div'); gPg.className='page';
            const gridWrap = document.createElement('div'); gridWrap.className='chart-grid';
            byTurma.forEach(([,vals],i)=>{
              const box = document.createElement('div'); box.className='chart-box'; box.id=`chart-${prog}-${sec}-${i}`;
              gridWrap.appendChild(box);
            });
            gPg.innerHTML = `<div class="header"><img src="mind4time-logo.png"></div></div>`;
            gPg.querySelector('.header').after(gridWrap);
            gPg.innerHTML += `<div class="footer">www.MIND4TIME.com<span>© MIND4TIME ${currentYear}</span></div>`;
            out.appendChild(gPg);
            byTurma.forEach(([,vals],i=>{
              createBarChart(document.getElementById(`chart-${prog}-${sec}-${i}`),byTurma[i][0],computeAverages(vals,LM,OM),sec==='evaluation');
            }));
          }

          // --- Text questions pages (one per question) ---
          const byQ = groupBy(all.filter(d=>String(d.section||'').toLowerCase().includes(sec)&&isNaN(parseFloat(d.value))&&(f.textQuestions||[]).includes(d.question)),'question');
          for(const [q,answers] of Object.entries(byQ)){
            const tPg = document.createElement('div'); tPg.className='page';
            tPg.innerHTML = `
              <div class="header"><img src="mind4time-logo.png"></div>
              <div class="text-question">
                <div class="text-question-title">${q}</div>
                <ul>${answers.map(a=>`<li>${a.value}</li>`).join('')}</ul>
              </div>
              <div class="footer">www.MIND4TIME.com<span>© MIND4TIME ${currentYear}</span></div>
            `;
            out.appendChild(tPg);
          }
        }
      }
    }

    // Generate PDF by screenshotting each .page in full
    async function generatePdf(){
      await build();
      const pages = Array.from(document.querySelectorAll('.page'));
      const images = [];
      for(const pg of pages){
        const canvas = await html2canvas(pg, { backgroundColor:'#fff', scale:2, width: pg.clientWidth, height: pg.scrollHeight });
        images.push(canvas.toDataURL());
      }
      const docDef = {
        pageSize:'A4',
        pageOrientation:'landscape',
        pageMargins:[0,0,0,0],
        content: images.map((img,i)=>({ image:img, width:842, pageBreak: i<images.length-1?'after':undefined }))
      };
      pdfMake.createPdf(docDef).download('report.pdf');
    }

    document.addEventListener('DOMContentLoaded', async ()=>{
      await build();
      document.getElementById('gerar-pdf').addEventListener('click', generatePdf);
    });
  </script>
</body>
</html>
