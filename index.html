<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Gerar Relatório Dinâmico</title>
  <style>
    :root {
      --primary: #007c91;
      --bg: #f5f5f5;
      --card: #fff;
      --border: #ccc;
      --radius: 6px;
      --gap: 12px;
    }
    *, *::before, *::after { box-sizing: border-box; }
    body {
      margin: 40px auto; padding:0 var(--gap);
      max-width: 900px;
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg);
      color: #333;
    }
    h2 { text-align:center; color:var(--primary); margin-bottom:24px; }
    form {
      display:grid;
      grid-template-columns:200px 1fr;
      gap:var(--gap);
      margin-bottom:var(--gap);
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:var(--gap);
    }
    label { font-weight:bold; display:block; margin-bottom:4px; }
    .checkbox-list {
      max-height:120px; overflow-y:auto;
      border:1px solid var(--border); background:#fafafa;
      border-radius:var(--radius); padding:var(--gap);
      margin-bottom:var(--gap);
    }
    .checkbox-list label { display:flex; align-items:center; margin-bottom:6px; }
    .checkbox-list input { margin-right:8px; }
    select, input[type="text"], input[type="month"], button {
      width:100%; padding:8px; border:1px solid var(--border);
      border-radius:var(--radius); font-size:1rem;
    }
    select:disabled { background:#eee; }
    .dynamic-block {
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:var(--gap);
      margin-bottom:var(--gap);
    }
    .dynamic-block + .dynamic-block { margin-top:var(--gap); }
    .actions { text-align:center; margin-top:var(--gap); }
    .actions button {
      padding:10px 24px; margin:0 8px; background:var(--primary);
      color:#fff; border:none; border-radius:var(--radius);
      cursor:pointer; font-size:1rem;
    }
    .actions button:disabled { background:#999; cursor:default; }
  </style>
</head>
<body>

  <h2>Gerar Relatório Dinâmico</h2>

  <form id="filtersForm" onsubmit="return false;">
    <div>
      <label for="clientSelect">Cliente</label>
      <select id="clientSelect" disabled>
        <option value="">– Selecione –</option>
      </select>
    </div>
    <div>
      <label>Programas</label>
      <div id="programList" class="checkbox-list"></div>
    </div>
    <div>
      <label>Cliente Info</label>
      <div id="infoList" class="checkbox-list"></div>
    </div>
    <div></div>
  </form>

  <div id="dynamicBlocks"></div>

  <div class="actions">
    <button id="viewReport" disabled>Ver Relatório</button>
  </div>

  <script>
    localStorage.removeItem('filters');
    localStorage.removeItem('reportFilters');
    
    let data = [];

    function loadFilters(){
      return JSON.parse(localStorage.getItem('filters')||'{}');
    }
    function saveFilters(f){ localStorage.setItem('filters', JSON.stringify(f)); }
    function updateFilter(key,val){ const f=loadFilters(); f[key]=val; saveFilters(f); }

    document.addEventListener('DOMContentLoaded', async()=>{
      data = await fetch('data.json').then(r=>r.json());
      const clients = [...new Set(data.map(d=>d.client))].sort();
      const csel = document.getElementById('clientSelect');
      clients.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; csel.appendChild(o); });
      csel.disabled=false;
    });

    const clientSelect  = document.getElementById('clientSelect');
    const programList   = document.getElementById('programList');
    const infoList      = document.getElementById('infoList');
    const dynamicBlocks = document.getElementById('dynamicBlocks');
    const viewBtn       = document.getElementById('viewReport');
    const downloadBtn   = document.getElementById('downloadReport');

    clientSelect.onchange = ()=>{
      const selC = clientSelect.value;
      programList.innerHTML = '';
      infoList.innerHTML = '';
      dynamicBlocks.innerHTML = '';
      viewBtn.disabled = downloadBtn.disabled = true;
      if(!selC){ updateFilter('clients',[]); return; }
      updateFilter('clients',[selC]);

      const progs = [...new Set(data.filter(d=>d.client===selC).map(d=>d.program))].sort();
      const infos = [...new Set(data.filter(d=>d.client===selC).map(d=>d.client_info))].sort();

      buildCheckboxList(programList, progs, 'programs', refreshDynamic);
      buildCheckboxList(infoList, infos, 'clientInfos', refreshDynamic);
    };

    function buildCheckboxList(container, options, storageKey, onChange){
      container.innerHTML = '';
      const stored = loadFilters()[storageKey] || [];
      options.forEach(opt => {
        const lbl = document.createElement('label');
        const cb = document.createElement('input'); cb.type = 'checkbox'; cb.value = opt;
        cb.checked = stored.includes(opt);
        cb.onchange = ()=>{
          const vals = Array.from(container.querySelectorAll('input:checked')).map(x=>x.value);
          updateFilter(storageKey, vals);
          if(onChange) onChange();
        };
        lbl.append(cb, opt);
        container.appendChild(lbl);
      });
    }

    function refreshDynamic(){
      dynamicBlocks.innerHTML = '';
      const f = loadFilters();
      const selC = (f.clients||[])[0];
      const selPs = f.programs || [];
      const selIs = f.clientInfos || [];
      if (!selC || !selPs.length || !selIs.length) {
        viewBtn.disabled = downloadBtn.disabled = true;
        return;
      }
      selPs.forEach(p => renderDynamic(selC, p, selIs));
      viewBtn.disabled = downloadBtn.disabled = false;
    }

    function renderDynamic(client, program, infos){
      updateFilter(`turmas_${program}`, []);
      updateFilter(`textQuestions_${program}`, []);

      const block = document.createElement('div');
      block.className = 'dynamic-block';
      const h = document.createElement('h3'); h.textContent = `Programa: ${program}`;
      block.appendChild(h);
      block.appendChild(createTextField('Formador', program, 'trainers'));
      block.appendChild(createMonthField('Início', program, 'starts'));
      block.appendChild(createMonthField('Fim', program, 'ends'));

      const turmas = [...new Set(data.filter(d=> d.client===client && d.program===program && infos.includes(d.client_info)).map(d=>d.turma))];
      const perguntas = [...new Set(data.filter(d=> d.client===client && d.program===program && infos.includes(d.client_info) && isNaN(+d.value)).map(d=>d.question))];

      block.appendChild(createCheckboxList('Turmas', turmas, `turmas_${program}`));
      block.appendChild(createCheckboxList('Perguntas Abertas', perguntas, `textQuestions_${program}`));

      dynamicBlocks.appendChild(block);
    }

    function createTextField(labelText, program, storageKey){
      const c=document.createElement('div');
      const lb=document.createElement('label'); lb.textContent=labelText;
      const inp=document.createElement('input'); inp.type='text';
      inp.value=(loadFilters()[storageKey]||{})[program]||'';
      inp.oninput=e=>{
        const obj=loadFilters()[storageKey]||{}; obj[program]=e.target.value;
        updateFilter(storageKey,obj);
      };
      c.append(lb,inp); return c;
    }

    function createMonthField(labelText, program, storageKey){
      const c=document.createElement('div');
      const lb=document.createElement('label'); lb.textContent=labelText;
      const inp=document.createElement('input'); inp.type='month';
      inp.value=((loadFilters()[storageKey]||{})[program]||'');
      inp.onchange=e=>{
        const obj=loadFilters()[storageKey]||{}; obj[program]=e.target.value;
        updateFilter(storageKey,obj);
      };
      c.append(lb,inp); return c;
    }

    function createCheckboxList(labelText, options, storageKey){
      const c=document.createElement('div');
      const lb=document.createElement('label'); lb.textContent=labelText;
      const list=document.createElement('div'); list.className='checkbox-list';
      const stored=loadFilters()[storageKey]||[];
      options.forEach(o=>{
        const lbl=document.createElement('label');
        const cb=document.createElement('input'); cb.type='checkbox'; cb.value=o;
        cb.checked=stored.includes(o);
        cb.onchange=()=>{
          const vals=Array.from(list.querySelectorAll('input:checked')).map(x=>x.value);
          updateFilter(storageKey,vals);
        };
        lbl.append(cb,o); list.append(lbl);
      });
      c.append(lb,list); return c;
    }

    function applyAndGo(download){
      localStorage.setItem('reportFilters', JSON.stringify(loadFilters()));
      window.location.href = 'report.html' + (download? '?download=true':'');
    }
    viewBtn.onclick     = ()=>applyAndGo(false);
    downloadBtn.onclick = ()=>applyAndGo(true);

  </script>

</body>
</html>
