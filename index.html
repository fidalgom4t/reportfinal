<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Selecionar Filtros</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f5f5f5;
      margin: 40px auto;
      max-width: 800px;
      padding: 0 20px;
    }
    h2 {
      text-align: center;
      color: #007c91;
      margin-bottom: 24px;
    }
    form {
      display: grid;
      grid-template-columns: 200px 1fr;
      gap: 16px;
      align-items: center;
      margin-bottom: 32px;
    }
    label {
      font-weight: bold;
    }
    select, button {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
    }
    select:disabled {
      background: #eee;
    }
    #dynamicBlocks > div {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .actions {
      text-align: center;
      margin-top: 16px;
    }
    .actions button {
      margin: 0 8px;
      background: #007c91;
      color: #fff;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2>Gerar Relat처rio Din창mico</h2>
  <form id="filtersForm" onsubmit="return false;">
    <label for="clientSelect">Cliente:</label>
    <select id="clientSelect"><option value="">-- Selecione Cliente --</option></select>

    <label for="programSelect">Programas:</label>
    <select id="programSelect" disabled><option value="">-- Selecione Programa --</option></select>

    <label for="infoSelect">Cliente Info:</label>
    <select id="infoSelect" disabled><option value="">-- Selecione Info --</option></select>
  </form>

  <div id="dynamicBlocks"></div>

  <div class="actions">
    <button id="viewReport" disabled>Ver Relat처rio</button>
    <button id="downloadReport" disabled>Download Relat처rio</button>
  </div>

  <script>
    let data = [];
    const clientSelect = document.getElementById('clientSelect');
    const programSelect = document.getElementById('programSelect');
    const infoSelect = document.getElementById('infoSelect');
    const dynamicBlocks = document.getElementById('dynamicBlocks');
    const viewBtn = document.getElementById('viewReport');
    const downloadBtn = document.getElementById('downloadReport');

    document.addEventListener('DOMContentLoaded', async () => {
      data = await fetch('data.json').then(r => r.json());
      populateClients();
    });

    function populateClients() {
      const clients = [...new Set(data.map(d => d.client))].sort();
      clientSelect.innerHTML = '<option value="">-- Selecione Cliente --</option>' +
        clients.map(c => `<option value="${c}">${c}</option>`).join('');
      clientSelect.disabled = false;
    }

    clientSelect.addEventListener('change', () => {
      programSelect.innerHTML = '<option value="">-- Selecione Programa --</option>';
      infoSelect.innerHTML = '<option value="">-- Selecione Info --</option>';
      dynamicBlocks.innerHTML = '';
      viewBtn.disabled = downloadBtn.disabled = true;

      const sel = clientSelect.value;
      if (!sel) {
        programSelect.disabled = true;
        infoSelect.disabled = true;
        return;
      }
      const programs = [...new Set(
        data.filter(d => d.client === sel).map(d => d.program)
      )].sort();
      programSelect.innerHTML += programs.map(p => `<option value="${p}">${p}</option>`).join('');
      programSelect.disabled = false;
    });

    programSelect.addEventListener('change', () => {
      infoSelect.innerHTML = '<option value="">-- Selecione Info --</option>';
      dynamicBlocks.innerHTML = '';
      viewBtn.disabled = downloadBtn.disabled = true;

      const selC = clientSelect.value;
      const selP = programSelect.value;
      if (!selP) {
        infoSelect.disabled = true;
        return;
      }
      const infos = [...new Set(
        data.filter(d => d.client === selC && d.program === selP).map(d => d.client_info)
      )].sort();
      infoSelect.innerHTML += infos.map(i => `<option value="${i}">${i}</option>`).join('');
      infoSelect.disabled = false;
    });

    infoSelect.addEventListener('change', () => {
      dynamicBlocks.innerHTML = '';
      const selC = clientSelect.value;
      const selP = programSelect.value;
      const selI = infoSelect.value;
      if (!selI) {
        viewBtn.disabled = downloadBtn.disabled = true;
        return;
      }
      renderDynamicBlock(selC, selP, selI);
      viewBtn.disabled = downloadBtn.disabled = false;
    });

    function renderDynamicBlock(client, program, info) {
      const block = document.createElement('div');
      const header = document.createElement('h3');
      header.textContent = `Programa: ${program}`;
      block.appendChild(header);

      // Turmas multi-select
      const turmas = [...new Set(
        data.filter(d => d.client === client && d.program === program && d.client_info === info)
            .map(d => d.turma)
      )];
      block.appendChild(createMultiSelect('Turmas', turmas));

      // Perguntas Abertas multi-select
      const perguntas = [...new Set(
        data.filter(d => d.client === client && d.program === program && d.client_info === info && isNaN(+d.value))
            .map(d => d.question)
      )];
      block.appendChild(createMultiSelect('Perguntas Abertas', perguntas));

      dynamicBlocks.appendChild(block);
    }

    function createMultiSelect(labelText, options) {
      const container = document.createElement('div');
      const label = document.createElement('label');
      label.textContent = labelText + ':';
      const select = document.createElement('select');
      select.multiple = true;
      select.innerHTML = options.map(o => `<option value="${o}">${o}</option>`).join('');
      select.style.width = '100%';
      select.style.marginBottom = '16px';
      container.append(label, select);
      return container;
    }
  </script>
</body>
</html>
