<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Training Report</title>
  <!-- Prevent caching -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>
  <style>
    body { margin:0; padding:0; font-family:'Segoe UI',sans-serif; background:#fff; color:#333; }
    /* Page header */
    .page-header {
      display: flex; align-items: center; padding:20px 30px;
    }
    .page-header img { height:40px }
    .page-header .line { flex:1; height:1px; background:#40a3a3; margin-left:20px }

    /* Program hero banner */
    .program-hero {
      padding: 40px 30px;
      border-top: 1px solid #eee;
    }
    .program-hero:first-child { border-top: none; }
    .program-hero .hero-main {
      display: flex; align-items: center; justify-content: center;
      margin-bottom: 30px;
    }
    .program-hero .hero-image {
      flex:0 0 200px; text-align:center;
    }
    .program-hero .hero-image img {
      max-width:100%; height:auto;
    }
    .program-hero .hero-text {
      flex:1; text-align:center;
    }
    .program-hero .hero-text .tagline {
      font-style:italic; color:#555; margin-bottom:8px;
    }
    .program-hero .hero-text .title {
      font-size:48px; color:#007c91; margin:0 0 8px; font-weight:600;
    }
    .program-hero .hero-text .subtitle {
      font-size:20px; color:#007c91;
    }
    .program-hero .hero-meta {
      display:flex; justify-content:center; gap:80px;
      font-size:16px; color:#555;
    }
    .program-hero .hero-meta .meta-block {
      text-align:left;
    }
    .program-hero .hero-meta .meta-block .label {
      font-style:italic; display:block; margin-bottom:4px;
    }
    .program-hero .hero-meta .meta-block .value {
      font-weight:bold;
    }

    /* Report content */
    #reportContent { padding:0 30px 30px; }
    .section-title {
      font-size:32px; color:#337d88;
      margin:60px 0 20px; border-bottom:2px solid #ccc;
      padding-bottom:10px;
    }
    .chart-container { height:400px; margin-bottom:60px; }
    .turma-title {
      font-size:22px; font-weight:bold;
      margin:20px 0 10px; color:#007c91;
    }
    .text-question {
      border:1px solid #007c91; border-left:6px solid #007c91;
      padding:16px; margin-bottom:30px; background:#f9f9f9;
    }
    .text-question-title {
      font-weight:bold; margin-bottom:8px;
      font-size:16px; color:#007c91;
    }
    ul { padding-left:20px; }
  </style>
</head>
<body>

  <!-- Top header -->
  <div class="page-header">
    <img src="mind4time-logo.png" alt="MIND4TIME" />
    <div class="line"></div>
  </div>

  <!-- Report container -->
  <div id="reportContent"></div>

  <script>
    //
    // 1) Helper functions
    //

    function createLabelMap(labels) {
      const m = {};
      labels.forEach(l => {
        const q = l.questionId || l["QUESTION ID"];
        m[q] = l.label || l["LABEL"];
      });
      return m;
    }

    function createSortMap(labels) {
      const m = {};
      labels.forEach(l => {
        const q = l.questionId || l["QUESTION ID"];
        m[q] = +(l.sortOrder || l["SORT ORDER"] || l.sort_order);
      });
      return m;
    }

    function groupBy(arr, key) {
      return arr.reduce((acc, item) => {
        (acc[item[key]] ||= []).push(item);
        return acc;
      }, {});
    }

    function computeAverages(rows, labelMap, orderMap) {
      const groups = {};
      rows.forEach(({question, value}) => {
        (groups[question] ||= []).push(+value);
      });
      const out = Object.entries(groups).map(([q, vals]) => {
        const avg = vals.reduce((a,b)=>a+b,0) / vals.length;
        return { question: q, label: labelMap[q]||q, avg: +avg.toFixed(1) };
      });
      out.sort((a,b)=>(orderMap[a.question]||0) - (orderMap[b.question]||0));
      return out;
    }

    function createBarChart(title, data, container) {
      const div = document.createElement('div');
      div.className = 'chart-container';
      container.appendChild(div);
      echarts.init(div).setOption({
        title:{ text:title, left:'center', textStyle:{ fontSize:18 } },
        tooltip:{},
        xAxis:{ type:'category', data:data.map(d=>d.label), axisLabel:{ rotate:30 } },
        yAxis:{ type:'value', min:0, max:5 },
        series:[{
          type:'bar',
          data:data.map(d=>d.avg),
          label:{ show:true, position:'top', formatter:'{c}' },
          itemStyle:{ color(params) {
            const v = params.value;
            if (v < 3) return '#d94e5d';
            if (v < 4) return '#f2c037';
            return '#61c277';
          }}
        }]
      });
    }

    function renderTextQuestions(rows, container) {
      const byQ = groupBy(rows, 'question');
      Object.entries(byQ).forEach(([q, answers]) => {
        const box = document.createElement('div');
        box.className = 'text-question';
        const title = document.createElement('div');
        title.className = 'text-question-title';
        title.textContent = q;
        box.appendChild(title);
        const ul = document.createElement('ul');
        answers.forEach(a => {
          const li = document.createElement('li');
          li.textContent = a.value;
          ul.appendChild(li);
        });
        box.appendChild(ul);
        container.appendChild(box);
      });
    }

    function getExtremeDate(rows, sectionKey, mode) {
      const dates = rows
        .filter(d => String(d.section||'').toLowerCase().includes(sectionKey))
        .map(d => new Date(d.date || d.submitted_at));
      if (!dates.length) return null;
      return mode==='min'
        ? new Date(Math.min(...dates))
        : new Date(Math.max(...dates));
    }

    function formatMonthYear(dt) {
      if (!dt) return 'N/A';
      return dt.toLocaleDateString('pt-PT',{ month:'long', year:'numeric' });
    }

    function formatMonthYearString(s) {
      const [y,m] = s.split('-').map(Number);
      return new Date(y, m-1, 1)
        .toLocaleDateString('pt-PT',{ month:'long', year:'numeric' });
    }

    //
    // 2) loadReport definition
    //

    async function loadReport() {
      const filters = JSON.parse(localStorage.getItem('reportFilters')||'{}');
      const [data, meta] = await Promise.all([
        fetch('https://fidalgom4t.github.io/reportfinal/data.json').then(r=>r.json()),
        fetch('https://fidalgom4t.github.io/reportfinal/meta.json').then(r=>r.json())
      ]);

      const labelMap = createLabelMap(meta.labels);
      const sortMap  = createSortMap(meta.labels);
      const container = document.getElementById('reportContent');
      container.innerHTML = '';

      (filters.programs||[]).forEach(prog => {
        // Program metadata
        const progMeta = meta.titles.find(t=>t.program_id===prog) || {};
        const rowsAll = data.filter(d =>
          d.client === filters.client &&
          d.program === prog &&
          (filters.turmas||[]).includes(d.turma)
        );

        // Compute scope & trainer
        const start = filters.start
          ? formatMonthYearString(filters.start)
          : formatMonthYear(getExtremeDate(rowsAll,'assessment','min'));
        const end   = filters.end
          ? formatMonthYearString(filters.end)
          : formatMonthYear(getExtremeDate(rowsAll,'evaluation','max'));
        const trainer = filters.trainer || 'N/A';

        // Hero banner
        const hero = document.createElement('div');
        hero.className = 'program-hero';
        hero.innerHTML = `
          <div class="hero-main">
            <div class="hero-image">
              <img src="program-icon.png" alt="${progMeta["TÍTULO"]||prog}" />
            </div>
            <div class="hero-text">
              <div class="tagline">${progMeta["SUBTÍTULO"]||''}</div>
              <h1 class="title">${progMeta["TÍTULO"]||prog}</h1>
              <div class="subtitle">${progMeta["TAGLINE"]||''}</div>
            </div>
          </div>
          <div class="hero-meta">
            <div class="meta-block">
              <span class="label">scope temporal</span>
              <span class="value">${start} – ${end}</span>
            </div>
            <div class="meta-block">
              <span class="label">formadora</span>
              <span class="value">${trainer}</span>
            </div>
            <div class="meta-block">
              <span class="label">total respostas</span>
              <span class="value">${rowsAll.length}</span>
            </div>
          </div>
        `;
        container.appendChild(hero);

        // Sections
        ['assessment','evaluation'].forEach(key => {
          const secName = key==='assessment' ? 'Assessment' : 'Avaliação do Programa';
          const hdr = document.createElement('div');
          hdr.className = 'section-title';
          hdr.textContent = secName;
          container.appendChild(hdr);

          // Numeric rows
          const rows = rowsAll.filter(d =>
            String(d.section||'').toLowerCase().includes(key) &&
            /^-?\d+(\.\d+)?$/.test(String(d.value||'').trim())
          );

          // Global chart
          if ((filters.turmas||[]).length>1 && rows.length) {
            createBarChart(`Global (${secName})`, computeAverages(rows,labelMap,sortMap), container);
          }

          // Per-turma
          const byTurma = groupBy(rows,'turma');
          Object.entries(byTurma).forEach(([turma, vals]) => {
            const tdiv = document.createElement('div');
            tdiv.className = 'turma-title';
            tdiv.textContent = `Turma: ${turma}`;
            container.appendChild(tdiv);
            createBarChart(turma, computeAverages(vals,labelMap,sortMap), container);
          });

          // Open-ended
          const textRows = rowsAll.filter(d =>
            String(d.section||'').toLowerCase().includes(key) &&
            !/^-?\d+(\.\d+)?$/.test(String(d.value||'').trim()) &&
            (filters.textQuestions||[]).includes(d.question)
          );
          renderTextQuestions(textRows, container);
        });
      });
    }

    //
    // 3) Kick off on DOMContentLoaded
    //

    document.addEventListener('DOMContentLoaded', loadReport);
  </script>
</body>
</html>
