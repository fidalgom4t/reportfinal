<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Relatório de Formação</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 30px;
      background-color: #fff;
      color: #333;
    }
    header {
      display: flex;
      align-items: center;
      border-bottom: 2px solid #007c91;
      padding-bottom: 10px;
      margin-bottom: 30px;
    }
    .logo-text {
      font-size: 20px;
      font-weight: bold;
      color: #007c91;
      margin-left: 15px;
    }
    .program-buttons button {
      margin: 5px;
      padding: 8px 16px;
      border: none;
      background-color: #007c91;
      color: #fff;
      cursor: pointer;
    }
    .program-section {
      display: none;
      border: 2px solid #007c91;
      margin-top: 30px;
      padding: 20px;
    }
    .program-section.active {
      display: block;
    }
    .chart-container {
      width: 100%;
      height: 400px;
      margin-bottom: 40px;
    }
    .text-question {
      border: 1px solid #007c91;
      border-left: 6px solid #007c91;
      padding: 16px;
      margin-bottom: 30px;
      background: #f9f9f9;
    }
    .text-question-title {
      font-weight: bold;
      margin-bottom: 8px;
      font-size: 16px;
      color: #007c91;
    }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Logo" height="50">
    <div class="logo-text">MIND4TIME<br><span style="font-weight: normal; font-size: 14px;">Productivity Consulting</span></div>
  </header>

  <h1>Relatório de Formação</h1>

  <label>Cliente:</label>
  <select id="clientSelect"></select>

  <div id="programButtons" class="program-buttons"></div>

  <div id="programSections"></div>

  <script>
    let rawData = [];
    let programMeta = {};
    let currentClient = '';

    Promise.all([
      fetch('data.json').then(res => res.json()),
      fetch('meta.json').then(res => res.json())
    ]).then(([data, meta]) => {
      rawData = data;
      programMeta = meta;
      populateClients();
    });

    function populateClients() {
      const clients = [...new Set(rawData.map(d => d.client))].sort();
      const clientSelect = document.getElementById("clientSelect");
      clients.forEach(client => {
        const opt = document.createElement("option");
        opt.value = client;
        opt.textContent = client;
        clientSelect.appendChild(opt);
      });
      clientSelect.onchange = () => {
        currentClient = clientSelect.value;
        renderProgramButtons();
      };
    }

    function renderProgramButtons() {
      const container = document.getElementById("programButtons");
      const sections = document.getElementById("programSections");
      container.innerHTML = '';
      sections.innerHTML = '';

      const clientPrograms = [...new Set(rawData.filter(d => d.client === currentClient).map(d => d.program))];
      clientPrograms.forEach(program => {
        const btn = document.createElement("button");
        btn.textContent = program;
        btn.onclick = () => showProgramSection(program);
        container.appendChild(btn);

        const section = document.createElement("div");
        section.className = "program-section";
        section.id = `section-${program}`;

        const meta = programMeta.find(p => p.program_id === program) || {};
        section.innerHTML = `
          <h2>${meta.TÍTULO || program}</h2>
          <p><em>${meta.SUBTÍTULO || ''}</em></p>
          <div><strong>Scope Temporal:</strong> <span id="scope-${program}"></span></div>
          <div><strong>Respostas Assessment:</strong> <span id="count-assessment-${program}"></span></div>
          <div><strong>Respostas Avaliação:</strong> <span id="count-evaluation-${program}"></span></div>
          <label>Formador:</label>
          <select id="trainer-${program}"><option value="">Selecionar</option></select>
          <div id="charts-${program}"></div>
          <div id="texts-${program}"></div>
        `;
        sections.appendChild(section);
      });
    }

    function showProgramSection(program) {
      document.querySelectorAll(".program-section").forEach(sec => sec.classList.remove("active"));
      document.getElementById(`section-${program}`).classList.add("active");
      renderProgramData(program);
    }

    function renderProgramData(program) {
      const data = rawData.filter(d => d.client === currentClient && d.program === program);
      const trainers = [...new Set(data.map(d => d.trainer).filter(Boolean))];
      const trainerSelect = document.getElementById(`trainer-${program}`);
      trainerSelect.innerHTML = '<option value="">Selecionar</option>';
      trainers.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        trainerSelect.appendChild(opt);
      });

      const section = document.getElementById(`section-${program}`);
      const scopeSpan = section.querySelector(`#scope-${program}`);
      const dateAssessment = data.filter(d => d.section === 'assessment').map(d => new Date(d.submitted_at)).sort();
      const dateEvaluation = data.filter(d => d.section === 'evaluation').map(d => new Date(d.submitted_at)).sort();
      if (dateAssessment.length && dateEvaluation.length) {
        const options = { month: 'long', year: 'numeric' };
        const start = dateAssessment[0].toLocaleDateString('pt-PT', options);
        const end = dateEvaluation[0].toLocaleDateString('pt-PT', options);
        scopeSpan.textContent = `${start} - ${end}`;
      } else {
        scopeSpan.textContent = 'Sem dados';
      }

      section.querySelector(`#count-assessment-${program}`).textContent = new Set(data.filter(d => d.section === 'assessment').map(d => d.id)).size;
      section.querySelector(`#count-evaluation-${program}`).textContent = new Set(data.filter(d => d.section === 'evaluation').map(d => d.id)).size;

      renderChartsAndTexts(data, program);
    }

    function renderChartsAndTexts(data, program) {
      const chartDiv = document.getElementById(`charts-${program}`);
      const textDiv = document.getElementById(`texts-${program}`);
      chartDiv.innerHTML = '';
      textDiv.innerHTML = '';

      ['assessment', 'evaluation'].forEach(section => {
        const numeric = data.filter(d => d.section === section && typeof d.value === 'number');
        if (numeric.length > 0) {
          const chartEl = document.createElement('div');
          chartEl.className = 'chart-container';
          chartDiv.appendChild(chartEl);

          const grouped = {};
          numeric.forEach(d => {
            if (!grouped[d.question]) grouped[d.question] = [];
            grouped[d.question].push(d.value);
          });

          const chartData = Object.entries(grouped).map(([q, values]) => ({
            question: q,
            average: values.reduce((a, b) => a + b, 0) / values.length
          }));

          const chart = echarts.init(chartEl);
          chart.setOption({
            tooltip: {},
            xAxis: { type: 'category', data: chartData.map(d => d.question), axisLabel: { rotate: 30 } },
            yAxis: { type: 'value', min: 0, max: 5 },
            series: [{
              type: 'bar',
              data: chartData.map(d => d.average),
              itemStyle: {
                color: val => val.value < 3 ? '#d94e5d' : val.value < 4 ? '#f2c037' : '#61c277'
              },
              label: {
                show: true,
                position: 'top',
                formatter: '{c}'
              }
            }]
          });
        }

        const texts = data.filter(d => d.section === section && typeof d.value !== 'number');
        const groupedTexts = {};
        texts.forEach(d => {
          if (!groupedTexts[d.question]) groupedTexts[d.question] = [];
          groupedTexts[d.question].push(d.value);
        });
        Object.entries(groupedTexts).forEach(([q, vals]) => {
          const box = document.createElement('div');
          box.className = 'text-question';
          box.innerHTML = `<div class="text-question-title">${q}</div><ul>${vals.map(v => `<li>${v}</li>`).join('')}</ul>`;
          textDiv.appendChild(box);
        });
      });
    }
  </script>
</body>
</html>
