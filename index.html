<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Selecionar Filtros</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; padding:40px; background:#f5f5f5 }
    h2 { margin-bottom:20px }
    .filter-group { margin-bottom:30px }
    .filter-group label { font-weight:bold; display:block; margin-bottom:5px }
    .checkbox-list { display:grid; grid-template-columns: repeat(auto-fill,minmax(200px,1fr)); gap:5px }
    .checkbox-list label { font-weight: normal; }
    select,input { padding:5px; margin-top:5px; width:300px }
    .dropdown-multiselect { margin-top:15px }
    .link-button {
      display:inline-block; margin-top:20px; padding:10px 20px;
      background:#007c91; color:#fff; text-decoration:none;
      font-weight:bold; border-radius:5px; cursor:pointer;
    }
  </style>
</head>
<body>

  <h2>Gerar Relatório Dinâmico</h2>

  <!-- Cliente -->
  <div class="filter-group">
    <label>Cliente:</label>
    <div id="clientWrapper" class="checkbox-list"></div>
  </div>

  <!-- Programas -->
  <div class="filter-group">
    <label>Programas:</label>
    <div id="programWrapper" class="checkbox-list"></div>
  </div>

  <!-- Turmas -->
  <div class="filter-group">
    <label>Turmas:</label>
    <div id="turmaWrapper" class="checkbox-list"></div>
  </div>

  <!-- Formador -->
  <div class="filter-group">
    <label>Formador:</label>
    <input type="text" id="trainerInput" placeholder="Nome do formador" />
  </div>

  <!-- Perguntas Abertas -->
  <div class="filter-group">
    <label>Perguntas Abertas:</label>
    <div class="dropdown-multiselect" id="textWrapper">
      <div class="select-box" onclick="toggleDropdown()">Selecionar perguntas</div>
      <div class="checkboxes" id="textQuestionSelect"></div>
    </div>
  </div>

  <!-- Scope temporal -->
  <div class="filter-group">
    <label>Scope temporal - Início:</label>
    <input type="month" id="startMonthInput" />
    <label style="margin-top:10px">Scope temporal - Fim:</label>
    <input type="month" id="endMonthInput" />
  </div>

  <a class="link-button" onclick="goToReport()">Ver Relatório</a>

  <script>
    let rawData = [];

    fetch('data.json')
      .then(r => r.json())
      .then(data => {
        rawData = data;
        initFilters();
      });

    function initFilters() {
      populateClients();
      syncTrainer();
      syncScope();
    }

    function toggleDropdown() {
      document.getElementById("textWrapper").classList.toggle("open");
    }

    // Utility to fill a set of checkboxes
    function fillCheckboxes(containerId, items, stored, onChange) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      items.forEach(val => {
        const lbl = document.createElement('label');
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.value = val;
        cb.checked = stored.includes(val);
        cb.onchange = onChange;
        lbl.appendChild(cb);
        lbl.appendChild(document.createTextNode(' ' + val));
        container.appendChild(lbl);
      });
    }

    // CLIENTE
    function populateClients() {
      const clients = [...new Set(rawData.map(d => d.client))].sort();
      const stored = get('clients') || [];
      fillCheckboxes('clientWrapper', clients, stored, () => {
        const sel = getChecked('clientWrapper');
        set('clients', sel);
        populatePrograms();
      });
      // initial
      populatePrograms();
    }

    // PROGRAMAS
    function populatePrograms() {
      const clients = get('clients') || [];
      const filtered = rawData.filter(d => clients.includes(d.client));
      const programs = [...new Set(filtered.map(d => d.program))].sort();
      const stored = get('programs') || [];
      fillCheckboxes('programWrapper', programs, stored, () => {
        const sel = getChecked('programWrapper');
        set('programs', sel);
        populateTurmas();
      });
      populateTurmas();
    }

    // TURMAS
    function populateTurmas() {
      const clients = get('clients') || [];
      const programs = get('programs') || [];
      const filtered = rawData.filter(d =>
        clients.includes(d.client) && programs.includes(d.program)
      );
      const turmas = [...new Set(filtered.map(d => d.turma))].sort();
      const stored = get('turmas') || [];
      fillCheckboxes('turmaWrapper', turmas, stored, () => {
        set('turmas', getChecked('turmaWrapper'));
      });
      populateTextQuestions(filtered);
    }

    // PERGUNTAS ABERTAS
    function populateTextQuestions(filtered) {
      const textQs = [...new Set(filtered.filter(d=>isNaN(+d.value)).map(d=>d.question))].sort();
      const stored = get('textQuestions') || [];
      fillCheckboxes('textQuestionSelect', textQs, stored, () => {
        set('textQuestions', getChecked('textQuestionSelect'));
      });
    }

    // SYNC trainer
    function syncTrainer() {
      const inp = document.getElementById('trainerInput');
      inp.value = get('trainer') || '';
      inp.oninput = () => set('trainer', inp.value);
    }

    // SYNC scope
    function syncScope() {
      const s = get('start');
      const e = get('end');
      if (s) document.getElementById('startMonthInput').value = s;
      if (e) document.getElementById('endMonthInput').value   = e;
      document.getElementById('startMonthInput').onchange = ev => set('start', ev.target.value);
      document.getElementById('endMonthInput').onchange   = ev => set('end',   ev.target.value);
    }

    // Helpers
    function get(key) {
      return JSON.parse(localStorage.getItem('filters')||'{}')[key]||[];
    }
    function set(key,val) {
      const f = JSON.parse(localStorage.getItem('filters')||'{}');
      f[key] = val;
      localStorage.setItem('filters', JSON.stringify(f));
    }
    function getChecked(wrapperId) {
      return Array.from(document.getElementById(wrapperId).querySelectorAll('input:checked'))
        .map(i => i.value);
    }

    function goToReport() {
      localStorage.setItem('reportFilters', localStorage.getItem('filters'));
      window.location.href = 'report.html';
    }
  </script>
</body>
</html>
