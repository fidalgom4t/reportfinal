<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Gerar Relatório Dinâmico</title>
  <style>
    :root {
      --primary: #007c91;
      --bg: #f5f5f5;
      --card: #fff;
      --border: #ccc;
      --radius: 6px;
      --gap: 12px;
    }
    *, *::before, *::after { box-sizing: border-box; }
    body {
      margin: 40px auto; padding:0 var(--gap);
      max-width: 900px;
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg); color: #333;
    }
    h2 { text-align:center; color:var(--primary); margin-bottom:24px; }
    form {
      display:grid; grid-template-columns:200px 1fr; gap:var(--gap);
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); padding:var(--gap);
      margin-bottom:var(--gap);
    }
    label { font-weight:bold; display:block; margin-bottom:4px; }
    select, input[type="text"], input[type="month"], button {
      width:100%; padding:8px; border:1px solid var(--border);
      border-radius:var(--radius); font-size:1rem;
    }
    select[multiple] { height: 120px; }
    select:disabled { background:#eee; }
    .dynamic-block {
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); padding:var(--gap);
      margin-bottom:var(--gap);
    }
    .checkbox-list {
      max-height:120px; overflow-y:auto;
      border:1px solid var(--border); background:#fafafa;
      border-radius:var(--radius); padding:var(--gap);
      margin-bottom:var(--gap);
    }
    .checkbox-list label { display:flex; align-items:center; margin-bottom:6px; }
    .checkbox-list input { margin-right:8px; }
    .actions { text-align:center; margin-top:var(--gap); }
    .actions button {
      padding:10px 24px; margin:0 8px; background:var(--primary);
      color:#fff; border:none; border-radius:var(--radius);
      cursor:pointer; font-size:1rem;
    }
    .actions button:disabled { background:#999; cursor:default; }
  </style>
</head>
<body>

  <h2>Gerar Relatório Dinâmico</h2>

  <form id="filtersForm" onsubmit="return false;">
    <div>
      <label for="clientSelect">Cliente</label>
      <select id="clientSelect" disabled>
        <option value="">– Selecione –</option>
      </select>
    </div>
    <div>
      <label for="programSelect">Programas</label>
      <select id="programSelect" multiple disabled>
        <option value="">– Selecione –</option>
      </select>
    </div>
    <div>
      <label for="infoSelect">Cliente Info</label>
      <select id="infoSelect" disabled>
        <option value="">– Selecione –</option>
      </select>
    </div>
    <div></div>
  </form>

  <div id="dynamicBlocks"></div>

  <div class="actions">
    <button id="viewReport" disabled>Ver Relatório</button>
    <button id="downloadReport" disabled>Download Relatório</button>
  </div>

  <script>
    let data = [];

    // --- Storage Helpers ---
    function loadFilters() {
      return JSON.parse(localStorage.getItem('filters') || '{}');
    }
    function saveFilters(f) {
      localStorage.setItem('filters', JSON.stringify(f));
    }
    function updateFilter(key, val) {
      const f = loadFilters();
      f[key] = val;
      saveFilters(f);
    }

    // --- init ---
    document.addEventListener('DOMContentLoaded', async () => {
      data = await fetch('data.json').then(r => r.json());

      // Populate cliente
      const clients = [...new Set(data.map(d => d.client))].sort();
      const csel = document.getElementById('clientSelect');
      clients.forEach(c => {
        const o = document.createElement('option');
        o.value = c; o.textContent = c;
        csel.appendChild(o);
      });
      csel.disabled = false;
    });

    // --- Refs ---
    const clientSelect  = document.getElementById('clientSelect');
    const programSelect = document.getElementById('programSelect');
    const infoSelect    = document.getElementById('infoSelect');
    const dynamicBlocks = document.getElementById('dynamicBlocks');
    const viewBtn       = document.getElementById('viewReport');
    const downloadBtn   = document.getElementById('downloadReport');

    // --- Handlers ---
    clientSelect.onchange = () => {
      const selC = clientSelect.value;
      // reset downstream
      programSelect.innerHTML = '';
      infoSelect.innerHTML    = '';
      dynamicBlocks.innerHTML = '';
      viewBtn.disabled = downloadBtn.disabled = true;

      if (!selC) {
        programSelect.disabled = true;
        infoSelect.disabled    = true;
        return;
      }

      updateFilter('clients', [selC]);

      // populate multi-select programs
      const progs = [...new Set(
        data.filter(d => d.client === selC).map(d => d.program)
      )].sort();
      programSelect.innerHTML = progs.map(p =>
        `<option value="${p}">${p}</option>`).join('');
      programSelect.disabled = false;
    };

    programSelect.onchange = () => {
      const selC = clientSelect.value;
      const selPs= Array.from(programSelect.selectedOptions).map(o=>o.value);
      infoSelect.innerHTML    = '';
      dynamicBlocks.innerHTML = '';
      viewBtn.disabled = downloadBtn.disabled = true;

      if (!selPs.length) {
        infoSelect.disabled = true;
        updateFilter('programs', []);
        return;
      }

      updateFilter('programs', selPs);

      // populate infoSelect
      const infos = [...new Set(
        data.filter(d =>
          d.client===selC && selPs.includes(d.program)
        ).map(d=>d.client_info)
      )].sort();
      infoSelect.innerHTML = infos.map(i =>
        `<option value="${i}">${i}</option>`).join('');
      infoSelect.disabled = false;
    };

    infoSelect.onchange = () => {
      const selI = infoSelect.value;
      dynamicBlocks.innerHTML = '';
      viewBtn.disabled = downloadBtn.disabled = true;

      if (!selI) {
        updateFilter('clientInfos', []);
        return;
      }
      updateFilter('clientInfos', [selI]);

      // render a block for each selected program
      const selC = clientSelect.value;
      const selPs= loadFilters().programs;
      selPs.forEach(prog => renderDynamic(selC, prog, selI));

      viewBtn.disabled = downloadBtn.disabled = false;
    };

    // --- Render one dynamic-block per program ---
    function renderDynamic(client, program, info) {
      const block = document.createElement('div');
      block.className = 'dynamic-block';

      // header
      const h = document.createElement('h3');
      h.textContent = `Programa: ${program}`;
      block.appendChild(h);

      // Trainer
      block.appendChild(createTextField('Formador', program, 'trainers'));

      // Dates
      block.appendChild(createMonthField('Início', program, 'starts'));
      block.appendChild(createMonthField('Fim',    program, 'ends'));

      // Turmas checkboxes
      const turmas = [...new Set(
        data.filter(d =>
          d.client===client &&
          d.program===program &&
          d.client_info===info
        ).map(d=>d.turma)
      )];
      block.appendChild(createCheckboxList('Turmas', turmas, `turmas_${program}`));

      // Perguntas Abertas checkboxes
      const perguntas = [...new Set(
        data.filter(d =>
          d.client===client &&
          d.program===program &&
          d.client_info===info &&
          isNaN(+d.value)
        ).map(d=>d.question)
      )];
      block.appendChild(createCheckboxList('Perguntas Abertas', perguntas, `textQuestions_${program}`));

      dynamicBlocks.appendChild(block);
    }

    function createTextField(labelText, program, storageKey) {
      const container = document.createElement('div');
      const lb = document.createElement('label'); lb.textContent = labelText;
      const inp = document.createElement('input'); inp.type = 'text';
      inp.value = (loadFilters()[storageKey]||{})[program] || '';
      inp.oninput = e => {
        const obj = loadFilters()[storageKey]||{};
        obj[program] = e.target.value;
        updateFilter(storageKey, obj);
      };
      container.append(lb, inp);
      return container;
    }

    function createMonthField(labelText, program, storageKey) {
      const container = document.createElement('div');
      const lb = document.createElement('label'); lb.textContent = labelText;
      const inp = document.createElement('input'); inp.type = 'month';
      inp.value = ((loadFilters()[storageKey]||{})[program] || '');
      inp.onchange = e => {
        const obj = loadFilters()[storageKey]||{};
        obj[program] = e.target.value;
        updateFilter(storageKey, obj);
      };
      container.append(lb, inp);
      return container;
    }

    function createCheckboxList(labelText, options, storageKey) {
      const c = document.createElement('div');
      const lb = document.createElement('label'); lb.textContent = labelText;
      const list = document.createElement('div'); list.className = 'checkbox-list';
      const stored = loadFilters()[storageKey] || [];
      options.forEach(o => {
        const lbl = document.createElement('label');
        const cb = document.createElement('input');
        cb.type = 'checkbox'; cb.value = o;
        cb.checked = stored.includes(o);
        cb.onchange = () => {
          const vals = Array.from(
            list.querySelectorAll('input:checked')
          ).map(x=>x.value);
          updateFilter(storageKey, vals);
        };
        lbl.append(cb, o);
        list.append(lbl);
      });
      c.append(lb, list);
      return c;
    }

    // --- Apply & Redirect ---
    function applyAndGo(download) {
      const all = loadFilters();
      localStorage.setItem('reportFilters', JSON.stringify(all));
      window.location.href = 'report.html' + (download? '?download=true':'' );
    }
    viewBtn.onclick     = () => applyAndGo(false);
    downloadBtn.onclick = () => applyAndGo(true);

  </script>

</body>
</html>
