<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Training Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <style>
    /* Print = landscape pages */
    @page { size: landscape; margin: 0; }
    @media print {
      .page-break { page-break-after: always; }
    }

    /* Grid for per‑turma (screen+print) */
    .chart-grid-page {
      display: grid;
      grid-template: 1fr 1fr / 1fr 1fr;
      gap: 20px;
      padding: 20px;
      box-sizing: border-box;
    }

    /* Screen styling */
    body {
      margin: 0; padding: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #fff; color: #333;
    }
    .page-header {
      display: flex; align-items: center;
      padding: 20px 30px;
    }
    .page-header img { height: 40px }
    .page-header .line {
      flex: 1; height: 1px; background: #40a3a3; margin-left: 20px;
    }

    /* Program hero */
    .program-hero {
      padding: 40px 30px; border-top: 1px solid #eee;
    }
    .program-hero:first-child { border-top: none; }
    .hero-main {
      display: flex; align-items: center; margin-bottom: 30px;
    }
    .hero-image { flex: 0 0 200px; text-align: center; }
    .hero-image img { max-width: 100%; height: auto; }
    .hero-text { flex: 1; text-align: center; }
    .hero-text .tagline { font-style: italic; color: #555; margin-bottom: 8px; }
    .hero-text .title {
      font-size: 48px; color: #007c91;
      margin: 0 0 8px; font-weight: 600;
    }
    .hero-text .subtitle { font-size: 20px; color: #007c91; }
    .hero-meta {
      display: flex; justify-content: center;
      gap: 80px; font-size: 16px; color: #555;
    }
    .hero-meta .label { font-style: italic; }
    .hero-meta .value { font-weight: bold; }

    /* Section banner */
    .section-banner {
      background: #f0f8f9;
      padding: 40px 24px;
      margin: 40px 30px 20px;
      border-left: 6px solid #007c91;
    }
    .section-banner h1 {
      margin: 0 0 16px; font-size: 48px; color: #007c91;
    }
    .section-banner .section-meta {
      display: flex; gap: 40px; font-size: 18px; color: #555;
    }

    /* Charts & text */
    #reportContent { padding-bottom: 30px; }
    .overall-chart {
      width: 90vw; margin: auto; height: 400px;
    }
    .chart-container {
      width: 100%; height: 300px;
    }
    .text-question {
      border: 1px solid #007c91; border-left: 6px solid #007c91;
      padding: 16px; margin: 20px auto 40px;
      background: #f9f9f9; width: 90vw; box-sizing: border-box;
    }
    .text-question-title {
      font-weight: bold; margin-bottom: 8px;
      font-size: 18px; color: #007c91;
    }
    ul { padding-left: 20px; font-size: 16px; }
  </style>
</head>
<body>
  <div class="page-header">
    <img src="mind4time-logo.png" alt="MIND4TIME" />
    <div class="line"></div>
  </div>

  <div id="reportContent"></div>

  <script>
    // — Helpers —
    function createLabelMap(labels) {
      const m = {};
      labels.forEach(l => {
        const q = l.questionId || l["QUESTION ID"];
        m[q] = l.label || l["LABEL"];
      });
      return m;
    }
    function createSortMap(labels) {
      const m = {};
      labels.forEach(l => {
        const q = l.questionId || l["QUESTION ID"];
        m[q] = +(l.sortOrder || l["SORT ORDER"] || l.sort_order);
      });
      return m;
    }
    function groupBy(arr, key) {
      return arr.reduce((acc, it) => {
        (acc[it[key]] ||= []).push(it);
        return acc;
      }, {});
    }
    function computeAverages(rows, labelMap, orderMap) {
      const groups = {};
      rows.forEach(({question, value}) => {
        (groups[question] ||= []).push(+value);
      });
      return Object.entries(groups)
        .map(([q, vals]) => {
          const avg = vals.reduce((a,b)=>a+b, 0) / vals.length;
          return { question: q, label: labelMap[q]||q, avg: +avg.toFixed(1) };
        })
        .sort((a,b)=>(orderMap[a.question]||0)-(orderMap[b.question]||0));
    }
    function createBarChartIn(div, title, data) {
      console.log("Drawing chart:", title, data);
      echarts.init(div).setOption({
        title: { text: title, left: 'center', textStyle: { fontSize: 18 } },
        tooltip: {},
        xAxis: { type: 'category', data: data.map(d=>d.label), axisLabel:{ rotate:30 } },
        yAxis: { type: 'value', min:0, max:5 },
        series:[{
          type: 'bar', data: data.map(d=>d.avg),
          label: { show:true, position:'top', formatter:'{c}' },
          itemStyle:{ color(p){ const v=p.value; if(v<3)return'#d94e5d'; if(v<4)return'#f2c037'; return'#61c277'; }}
        }]
      });
    }
    function renderTextQuestions(rows, container) {
      const byQ = groupBy(rows, 'question');
      Object.entries(byQ).forEach(([q, answers]) => {
        const box = document.createElement('div');
        box.className = 'text-question';
        const h = document.createElement('div');
        h.className = 'text-question-title';
        h.textContent = q;
        box.appendChild(h);
        const ul = document.createElement('ul');
        answers.forEach(a=>{
          const li = document.createElement('li');
          li.textContent = a.value;
          ul.appendChild(li);
        });
        box.appendChild(ul);
        container.appendChild(box);
      });
    }
    function countUnique(rows, section) {
      return new Set(
        rows
          .filter(d=>String(d.section||'').toLowerCase().includes(section))
          .map(d=>d.respondent_id||d.id)
      ).size;
    }

    // — Main —
    async function loadReport() {
      console.log("Loading report…");
      const f = JSON.parse(localStorage.getItem('reportFilters')||'{}');
      const [data, meta] = await Promise.all([
        fetch('data.json').then(r=>r.json()),
        fetch('meta.json').then(r=>r.json())
      ]);
      console.log("Data:", data.length, "rows; Labels:", meta.labels.length);

      const labelMap = createLabelMap(meta.labels),
            orderMap = createSortMap(meta.labels),
            out = document.getElementById('reportContent');

      out.innerHTML = '';

      for (const prog of f.programs||[]) {
        const rowsAll = data.filter(d=>
          (f.clients||[]).includes(d.client) &&
          d.program === prog &&
          (f.turmas||[]).includes(d.turma)
        );
        console.log("Program", prog, "rows:", rowsAll.length);

        // Program hero
        const pm = meta.titles.find(t=>t.program_id===prog)||{};
        const hero = document.createElement('div');
        hero.className = 'program-hero';
        hero.innerHTML = `
          <div class="hero-main">
            <div class="hero-image">
              <img src="program-icon.png" alt="${pm.TÍTULO||prog}">
            </div>
            <div class="hero-text">
              <div class="tagline">${pm.SUBTÍTULO||''}</div>
              <h1 class="title">${pm.TÍTULO||prog}</h1>
              <div class="subtitle">${pm.TAGLINE||''}</div>
            </div>
          </div>
          <div class="hero-meta">
            <div><span class="label">Formadora:</span>
                 <span class="value">${(f.trainers||{})[prog]||'N/A'}</span></div>
          </div>`;
        out.appendChild(hero);

        // Sections
        for (const sec of ['assessment','evaluation']) {
          const secName = sec==='assessment' ? 'Assessment' : 'Avaliação do Programa';
          const uniq = countUnique(rowsAll, sec);
          console.log(" Section", secName, "unique respondents:", uniq);

          // Banner
          const sb = document.createElement('div');
          sb.className = 'section-banner';
          sb.innerHTML = `
            <h1>${secName}</h1>
            <div class="section-meta">
              <div><span class="label">Total de respostas:</span>
                   <span class="value">${uniq}</span></div>
            </div>`;
          out.appendChild(sb);

          // Numeric rows by typeof
          const numeric = rowsAll.filter(d=> d.value !== null && typeof d.value === 'number' && String(d.section||'').toLowerCase().includes(sec));
          console.log("  Numeric rows:", numeric.length);

          // Overall
          if (numeric.length) {
            const pg = document.createElement('div'); pg.className = 'page-break';
            const cdiv = document.createElement('div'); cdiv.className = 'overall-chart chart-container';
            pg.appendChild(cdiv); out.appendChild(pg);
            const avgData = computeAverages(numeric, labelMap, orderMap);
            createBarChartIn(cdiv, `Global (${secName})`, avgData);
          }

          // Per-turma
          const byT = Object.entries(groupBy(numeric,'turma'));
          console.log("  Turmas with numeric:", byT.map(t=>t[0]));
          for (let i=0; i<byT.length; i+=4) {
            const slice = byT.slice(i,i+4);
            const grid = document.createElement('div'); grid.className='chart-grid-page';
            slice.forEach(([tm, vals])=>{
              const cc = document.createElement('div'); cc.className='chart-container';
              grid.appendChild(cc);
              createBarChartIn(cc, tm, computeAverages(vals, labelMap, orderMap));
            });
            out.appendChild(grid);
          }

          // Open-ended
          const textRows = rowsAll.filter(d=>
            String(d.section||'').toLowerCase().includes(sec) &&
            (typeof d.value !== 'number') &&
            (f.textQuestions||[]).includes(d.question)
          );
          console.log("  Open-ended answers:", textRows.length);
          renderTextQuestions(textRows,out);
        }
      }

      // Auto-print if ?download=true
      if (new URLSearchParams(location.search).get('download')==='true') {
        console.log("Auto-printing…");
        setTimeout(()=>window.print(),500);
      }
    }

    document.addEventListener('DOMContentLoaded', loadReport);
  </script>
</body>
</html>
