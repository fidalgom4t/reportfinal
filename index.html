<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Selecionar Filtros</title>
  <style>/* ... existing CSS ... */</style>
</head>
<body>
  <h2>Gerar Relatório Dinâmico</h2>
  <form id="filtersForm" onsubmit="return false;">
    <!-- Filters markup ... -->
  </form>
  <script>
    let rawData = [];
    function getStorageFilters() { return JSON.parse(localStorage.getItem('filters')||'{}'); }
    function saveFilter(k,v){ const f=getStorageFilters(); f[k]=v; localStorage.setItem('filters',JSON.stringify(f)); }
    function loadFilter(k){ return getStorageFilters()[k]||[]; }
    function getCheckedValues(c){ return Array.from(document.querySelectorAll(`#${c} input:checked`)).map(i=>i.value); }
    function updateSelectBox(id,vals,ph){ document.getElementById(id).textContent = vals.length? vals.join(', '):ph; }
    function populateCheckboxes({containerId,boxId,dataList,filterKey,placeholder,onChange}){
      const cont=document.getElementById(containerId); cont.innerHTML='';
      const btn=document.createElement('button'); btn.type='button'; btn.className='select-all'; btn.textContent='Selecionar tudo';
      btn.onclick=e=>{e.stopPropagation(); saveFilter(filterKey,dataList.slice()); onChange();}; cont.appendChild(btn);
      const stored=loadFilter(filterKey);
      dataList.forEach(item=>{
        const lbl=document.createElement('label');
        const cb=document.createElement('input'); cb.type='checkbox'; cb.value=item; cb.checked=stored.includes(item);
        cb.onchange=()=>{ const sel=getCheckedValues(containerId); saveFilter(filterKey,sel); onChange(); };
        lbl.append(cb, ' '+item); cont.appendChild(lbl);
      });
      updateSelectBox(boxId,stored,placeholder);
    }
    function toggleDropdown(id){ document.querySelectorAll('.dropdown-multiselect').forEach(el=>el.id!==id&&el.classList.remove('open')); document.getElementById(id).classList.toggle('open'); }
    function attachDropdownEvents(){ ['client','clientInfo','program','turma','text'].forEach(k=>{
      const w=document.getElementById(k+'Wrapper'); w.querySelector('.select-box').onclick=()=>toggleDropdown(k+'Wrapper');
    }); document.addEventListener('click',e=>{ if(!e.target.closest('.dropdown-multiselect')) document.querySelectorAll('.dropdown-multiselect').forEach(el=>el.classList.remove('open')); }); }
    function populateClients(){ const arr=[...new Set(rawData.map(d=>d.client))].sort(); populateCheckboxes({containerId:'clientChecks',boxId:'clientBox',dataList:arr,filterKey:'clients',placeholder:'Selecionar cliente(s)',onChange:refreshAll}); }
    function populateClientInfos(){ const sel=loadFilter('clients'); const arr=[...new Set(rawData.filter(d=>sel.includes(d.client)).map(d=>d.client_info))].sort(); populateCheckboxes({containerId:'clientInfoChecks',boxId:'clientInfoBox',dataList:arr,filterKey:'clientInfos',placeholder:'Selecionar info(s)',onChange:refreshAll}); }
    function populatePrograms(){ const sel=loadFilter('clients'); const arr=[...new Set(rawData.filter(d=>sel.includes(d.client)).map(d=>d.program))].sort(); populateCheckboxes({containerId:'programChecks',boxId:'programBox',dataList:arr,filterKey:'programs',placeholder:'Selecionar programa(s)',onChange:refreshAll}); }
    function populateTurmas(){ const {clients=[],clientInfos=[],programs=[]}=getStorageFilters(); const arr=[...new Set(rawData.filter(d=>clients.includes(d.client)&&clientInfos.includes(d.client_info)&&programs.includes(d.program)).map(d=>d.turma))].sort(); populateCheckboxes({containerId:'turmaChecks',boxId:'turmaBox',dataList:arr,filterKey:'turmas',placeholder:'Selecionar turma(s)',onChange:refreshAll}); }
    function populateTextQuestions(){ const {clients=[],programs=[],turmas=[]}=getStorageFilters(); const arr=[...new Set(rawData.filter(d=>clients.includes(d.client)&&programs.includes(d.program)&&turmas.includes(d.turma)&&isNaN(+d.value)).map(d=>d.question))].sort(); populateCheckboxes({containerId:'textChecks',boxId:'textBox',dataList:arr,filterKey:'textQuestions',placeholder:'Selecionar perguntas',onChange:refreshAll}); }
    function renderTrainerInputs(){ const cont=document.getElementById('trainersContainer'); cont.innerHTML=''; const programs=loadFilter('programs'); const saved=getStorageFilters().trainers||{}; programs.forEach(p=>{ const w=document.createElement('div'); w.className='program-trainer'; const lbl=document.createElement('label'); lbl.textContent=`Formador (${p}):`; const inp=document.createElement('input'); inp.type='text'; inp.placeholder=`Nome do formador para ${p}`; inp.value=saved[p]||''; inp.oninput=()=>{ saved[p]=inp.value; localStorage.setItem('filters',JSON.stringify({...getStorageFilters(),trainers:saved})); }; w.append(lbl,inp); cont.appendChild(w); }); }
    function refreshAll(){ populateClientInfos(); populatePrograms(); populateTurmas(); populateTextQuestions(); renderTrainerInputs(); }
    function initFilters(){ fetch('data.json').then(r=>r.json()).then(data=>{ rawData=data; populateClients(); attachDropdownEvents(); refreshAll(); const {start,end}=getStorageFilters(); if(start)document.getElementById('startMonth').value=start; if(end)document.getElementById('endMonth').value=end; document.getElementById('startMonth').onchange=e=>saveFilter('start',e.target.value); document.getElementById('endMonth').onchange=e=>saveFilter('end',e.target.value); document.getElementById('viewReport').onclick=()=>navigateToReport(false); document.getElementById('downloadReport').onclick=()=>navigateToReport(true); }); }
    function navigateToReport(download){ const f={...getStorageFilters(),trainers:getStorageFilters().trainers||{}}; localStorage.setItem('reportFilters',JSON.stringify(f)); window.location.href=`report.html${download?'?download=true':''}`; }
    document.addEventListener('DOMContentLoaded',initFilters);
  </script>
</body>
</html>
