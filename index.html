<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Selecionar Filtros</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; padding:40px; background:#f5f5f5 }
    h2 { margin-bottom:20px }
    .filter-group { margin-bottom:30px }
    .filter-group label { font-weight:bold; display:block; margin-bottom:5px }

    /* Dropdown‑multiselect styles */
    .dropdown-multiselect {
      position: relative;
      display: inline-block;
      width: 320px;
    }
    .dropdown-multiselect .select-box {
      border: 1px solid #ccc;
      background: #fff;
      padding: 8px;
      cursor: pointer;
      user-select: none;
      position: relative;
    }
    .dropdown-multiselect .select-box::after {
      content: '▾';
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 12px;
      color: #666;
    }
    .dropdown-multiselect .checkboxes {
      display: none;
      position: absolute;
      background-color: #fff;
      border: 1px solid #ccc;
      z-index: 10;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      padding: 8px;
      box-sizing: border-box;
    }
    .dropdown-multiselect.open .checkboxes {
      display: block;
    }
    .dropdown-multiselect .checkboxes label {
      display: block;
      margin-bottom: 4px;
      font-weight: normal;
      cursor: pointer;
    }

    select,input { padding:5px; margin-top:5px; width:320px }
    .link-button {
      display:inline-block; margin-top:20px; padding:10px 20px;
      background:#007c91; color:#fff; text-decoration:none;
      font-weight:bold; border-radius:5px; cursor:pointer;
    }
  </style>
</head>
<body>

  <h2>Gerar Relatório Dinâmico</h2>

  <!-- CLIENTE -->
  <div class="filter-group">
    <label>Cliente:</label>
    <div class="dropdown-multiselect" id="clientWrapper">
      <div class="select-box" data-placeholder="Selecionar cliente(s)" onclick="toggleDropdown('clientWrapper')">Selecionar cliente(s)</div>
      <div class="checkboxes" id="clientChecks"></div>
    </div>
  </div>

  <!-- PROGRAMAS -->
  <div class="filter-group">
    <label>Programas:</label>
    <div class="dropdown-multiselect" id="programWrapper">
      <div class="select-box" data-placeholder="Selecionar programa(s)" onclick="toggleDropdown('programWrapper')">Selecionar programa(s)</div>
      <div class="checkboxes" id="programChecks"></div>
    </div>
  </div>

  <!-- TURMAS -->
  <div class="filter-group">
    <label>Turmas:</label>
    <div class="dropdown-multiselect" id="turmaWrapper">
      <div class="select-box" data-placeholder="Selecionar turma(s)" onclick="toggleDropdown('turmaWrapper')">Selecionar turma(s)</div>
      <div class="checkboxes" id="turmaChecks"></div>
    </div>
  </div>

  <!-- FORMADOR -->
  <div class="filter-group">
    <label>Formador:</label>
    <input type="text" id="trainerInput" placeholder="Nome do formador" />
  </div>

  <!-- PERGUNTAS ABERTAS -->
  <div class="filter-group">
    <label>Perguntas Abertas:</label>
    <div class="dropdown-multiselect" id="textWrapper">
      <div class="select-box" data-placeholder="Selecionar perguntas" onclick="toggleDropdown('textWrapper')">Selecionar perguntas</div>
      <div class="checkboxes" id="textQuestionSelect"></div>
    </div>
  </div>

  <!-- SCOPE TEMPORAL -->
  <div class="filter-group">
    <label>Scope temporal - Início:</label>
    <input type="month" id="startMonthInput" />
    <label style="margin-top:10px;">Scope temporal - Fim:</label>
    <input type="month" id="endMonthInput" />
  </div>

  <a class="link-button" onclick="goToReport()">Ver Relatório</a>

  <script>
    let rawData = [];

    fetch('data.json')
      .then(r => r.json())
      .then(data => {
        rawData = data;
        initFilters();
      });

    function toggleDropdown(wrapperId) {
      document.getElementById(wrapperId).classList.toggle('open');
    }

    function fillChecks(containerId, items, stored, onChange) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      items.forEach(val => {
        const lbl = document.createElement('label');
        const cb  = document.createElement('input');
        cb.type    = 'checkbox';
        cb.value   = val;
        cb.checked = stored.includes(val);
        cb.onchange = () => {
          onChange();
          updateSelectBoxText(containerId);
        };
        lbl.appendChild(cb);
        lbl.appendChild(document.createTextNode(' ' + val));
        container.appendChild(lbl);
      });
      updateSelectBoxText(containerId);
    }

    function updateSelectBoxText(containerId) {
      const map = {
        clientChecks: 'clientWrapper',
        programChecks: 'programWrapper',
        turmaChecks: 'turmaWrapper',
        textQuestionSelect: 'textWrapper'
      };
      const wrapper = map[containerId];
      const box = document.querySelector(`#${wrapper} .select-box`);
      const checked = Array.from(document.getElementById(containerId).querySelectorAll('input:checked'))
        .map(i => i.value);
      box.textContent = checked.length
        ? checked.join(', ')
        : box.getAttribute('data-placeholder');
    }

    function getChecked(containerId) {
      return Array.from(document.getElementById(containerId).querySelectorAll('input:checked'))
        .map(i => i.value);
    }

    function setFilter(key, val) {
      const s = JSON.parse(localStorage.getItem('filters')||'{}');
      s[key] = val;
      localStorage.setItem('filters', JSON.stringify(s));
    }
    function getFilter(key) {
      return JSON.parse(localStorage.getItem('filters')||'{}')[key] || [];
    }

    function initFilters() {
      // CLIENTES
      const clients = [...new Set(rawData.map(d=>d.client))].sort();
      const storedClients = getFilter('clients');
      fillChecks('clientChecks', clients, storedClients, () => {
        setFilter('clients', getChecked('clientChecks'));
        populatePrograms();
      });

      // then programs, turmas, questions
      populatePrograms();
      syncTrainer();
      syncScope();
    }

    function populatePrograms() {
      const clients = getFilter('clients');
      const progs = [...new Set(rawData.filter(d=>clients.includes(d.client)).map(d=>d.program))].sort();
      const storedProgs = getFilter('programs');
      fillChecks('programChecks', progs, storedProgs, () => {
        setFilter('programs', getChecked('programChecks'));
        populateTurmas();
      });
      populateTurmas();
    }

    function populateTurmas() {
      const clients = getFilter('clients');
      const progs   = getFilter('programs');
      const turmas = [...new Set(rawData
        .filter(d=>clients.includes(d.client)&&progs.includes(d.program))
        .map(d=>d.turma)
      )].sort();
      const storedTurmas = getFilter('turmas');
      fillChecks('turmaChecks', turmas, storedTurmas, () => {
        setFilter('turmas', getChecked('turmaChecks'));
      });
      populateTextQs();
    }

    function populateTextQs() {
      const clients  = getFilter('clients');
      const progs    = getFilter('programs');
      const turmas   = getFilter('turmas');
      const qs = [...new Set(rawData
        .filter(d=>clients.includes(d.client)&&progs.includes(d.program)&&turmas.includes(d.turma)&&isNaN(+d.value))
        .map(d=>d.question)
      )].sort();
      const storedQs = getFilter('textQuestions');
      fillChecks('textQuestionSelect', qs, storedQs, () => {
        setFilter('textQuestions', getChecked('textQuestionSelect'));
      });
    }

    function syncTrainer() {
      const inp = document.getElementById('trainerInput');
      inp.value = JSON.parse(localStorage.getItem('filters')||'{}').trainer || '';
      inp.oninput = () => setFilter('trainer', inp.value);
    }

    function syncScope() {
      const sVal = JSON.parse(localStorage.getItem('filters')||'{}').start;
      const eVal = JSON.parse(localStorage.getItem('filters')||'{}').end;
      if (sVal) document.getElementById('startMonthInput').value = sVal;
      if (eVal) document.getElementById('endMonthInput').value   = eVal;
      document.getElementById('startMonthInput').onchange = ev => setFilter('start', ev.target.value);
      document.getElementById('endMonthInput').onchange   = ev => setFilter('end',   ev.target.value);
    }

    function goToReport() {
      localStorage.setItem('reportFilters', localStorage.getItem('filters'));
      window.location.href = 'report.html';
    }
  </script>
</body>
</html>
