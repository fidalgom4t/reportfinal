<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8"/>
  <title>Training Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <style>
    @page { size: 11in 8.5in; margin: 0; }
    @media print { .page { page-break-after: always; } }

    .page {
      position: relative;
      width: 100vw; height: 100vh;
      box-sizing: border-box;
      padding-top: 80px;
      padding-bottom: 60px;
      overflow: visible;
    }
    .header, .footer {
      position: absolute; left:0; right:0;
      display: flex; justify-content: space-between; align-items: center;
      background: #fff; padding: 0 30px; box-sizing: border-box; z-index:2;
    }
    .header { top:0; height:80px; border-bottom:1px solid #40a3a3; }
    .header img { height:60px; }
    .footer { bottom:0; height:60px; font-size:14px; color:#007c91; border-top:1px solid #40a3a3; }

    .hero {
      position: relative; display:flex; align-items:center; justify-content:center; text-align:center; color:#fff;
    }
    .hero .bg {
      position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; z-index:0;
    }
    .hero-content {
      position:relative; z-index:1;
      max-width:80%;
      display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%;
    }
    .hero-content small { font-style:italic; color:#e0f2f3; margin-bottom:8px; font-size:1.2rem; }
    .hero-content h1 { font-size:4rem; margin:0; font-weight:600; }
    .hero-content .subtitle { font-size:1.8rem; margin-top:12px; }
    .hero-content .meta { margin-top:24px; display:flex; gap:40px; justify-content:center; font-size:1.2rem; }
    .hero-content .meta span { display:block; font-style:italic; color:#e0f2f3; }
    .hero-content .meta strong { color:#fff; font-weight:600; }

    .banner { display:flex; align-items:center; justify-content:center; background:#fff; }
    .banner-box {
      background:#f0f8f9; padding:40px 60px; border-left:6px solid #007c91;
      box-shadow:0 2px 6px rgba(0,0,0,0.1); width:70%;
    }
    .banner-box h1 { margin:0 0 16px; font-size:48px; color:#007c91; }
    .banner-box .meta { display:flex; gap:40px; font-size:18px; color:#555; }

    .chart-fullpage { display:flex; align-items:center; justify-content:center; background:#fff; }
    .chart-full { width:90vw; height:80vh; }

    .chart-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows:
        calc((100vh - 80px - 60px - 40px) / 2)
        calc((100vh - 80px - 60px - 40px) / 2);
      gap: 20px;
      padding: 20px;
      box-sizing: border-box;
    }
    .chart-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      box-sizing: border-box;
    }
    .chart-container h2 {
      margin: 0 0 8px;
      font-size: 20px;
      color: #444;
    }
    .chart-box {
      width: 100%;
      height: calc(100% - 32px); /* leave room for the H2 */
    }

    .text-page {
      overflow: visible;
      background: #fff;
      box-sizing: border-box;
    }
    .text-question {
      border:1px solid #007c91; border-left:6px solid #007c91;
      width: 80vw;
      margin: 80px auto;
      padding: 24px 32px;
      background:#f9f9f9;
      box-sizing:border-box;
      page-break-inside: avoid;
      break-inside: avoid;
    }
    .text-question-title { font-size:18px; font-weight:bold; margin-bottom:12px; color:#007c91; }
    .text-question ul { padding-left:20px; font-size:16px; }
  </style>
</head>
<body>
  <div id="report"></div>
  <script>
    // all helper functions remain the same…

    function createLabelMap(labels){ /* … */ }
    function createSortMap(labels){ /* … */ }
    function groupBy(arr, k){ /* … */ }
    function computeAverages(rows, LM, OM){ /* … */ }
    function createBarChart(div, title, data, uniform){ /* … */ }
    function countUnique(rows, sec){ /* … */ }
    function formatMonthYear(val){ /* … */ }

    async function build(){
      const f = JSON.parse(localStorage.getItem('reportFilters')||'{}'),
            [data, meta] = await Promise.all([
              fetch('data.json').then(r=>r.json()),
              fetch('meta.json').then(r=>r.json())
            ]),
            LM = createLabelMap(meta.labels),
            OM = createSortMap(meta.labels),
            container = document.getElementById('report');

      container.innerHTML = '';

      // compute timeScope
      let timeScope = '';
      if(f.start && f.end){
        const s = formatMonthYear(f.start),
              e = formatMonthYear(f.end);
        timeScope = `${s.month} – ${e.month} ${e.year}`;
      }

      for(const prog of f.programs||[]){
        const all = data.filter(d=>
          (f.clients||[]).includes(d.client) &&
          d.program===prog &&
          (f.turmas||[]).includes(d.turma)
        );

        // … build the hero & section banners as before …

        for(const sec of ['assessment','evaluation']){
          const name = sec==='assessment' ? 'Assessment' : 'Avaliação do Programa',
                uniq = countUnique(all,sec),
                numeric = all.filter(d=>
                  String(d.section||'').toLowerCase().includes(sec) &&
                  !isNaN(parseFloat(d.value))
                ),
                byTurma = Object.entries(groupBy(numeric,'turma'));

          // … banner code …

          // GLOBAL chart (only if >1 turma)
          if(numeric.length && byTurma.length>1){
            const gl = document.createElement('div');
            gl.className = 'page chart-fullpage';
            gl.innerHTML=`
              <div class="header"><img src="mind4time-logo.png"><div></div></div>
              <div class="chart-full" id="chart-global-${prog}-${sec}"></div>
              <div class="footer"><div>www.MIND4TIME.com</div><div>© MIND4TIME 2024</div></div>`;
            container.appendChild(gl);
            createBarChart(
              gl.querySelector('.chart-full'),
              `Global (${name})`,
              computeAverages(numeric,LM,OM),
              sec==='evaluation'
            );
          }

          // PER‑TURMA grid: wrap each chart in a .chart-container + <h2>
          for(let i=0; i<byTurma.length; i+=4){
            const grid = document.createElement('div');
            grid.className='page chart-grid';
            grid.innerHTML=`<div class="header"><img src="mind4time-logo.png"><div></div></div>`;
            byTurma.slice(i,i+4).forEach(([tm],idx)=>{
              grid.innerHTML += `
                <div class="chart-container">
                  <h2>${tm}</h2>
                  <div class="chart-box" id="chart-${prog}-${sec}-${i+idx}"></div>
                </div>`;
            });
            grid.innerHTML+=`<div class="footer"><div>www.MIND4TIME.com</div><div>© MIND4TIME 2024</div></div>`;
            container.appendChild(grid);

            byTurma.slice(i,i+4).forEach(([,vals],idx)=>{
              createBarChart(
                document.getElementById(`chart-${prog}-${sec}-${i+idx}`),
                '', // title is now the <h2>, so leave ECharts title blank
                computeAverages(vals,LM,OM),
                sec==='evaluation'
              );
            });
          }

          // … open‑ended questions …
        }
      }
    }

    document.addEventListener('DOMContentLoaded', build);
  </script>
</body>
</html>
