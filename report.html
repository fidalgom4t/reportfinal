<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <!-- Prevent caching -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Relatório Gerado</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>
  <style>
    body { font-family:'Segoe UI',sans-serif; margin:0; padding:0; background:#fff; color:#333; }

    /* Hero banner */
    .hero-banner {
      position: relative;
      display: flex;
      align-items: center;
      height: 300px;
      background: linear-gradient(to right, #e6f2f3 40%, #40a3a3);
      overflow: hidden;
    }
    .hero-banner img.hourglass {
      height: 100%;
      object-fit: cover;
    }
    .hero-text {
      position: absolute;
      left: 50%;
      top: 40%;
      transform: translate(-50%, -40%);
      text-align: center;
      color: #fff;
    }
    .hero-text h1 {
      margin: 0;
      font-size: 48px;
      font-weight: 600;
    }
    .hero-text p {
      margin: 8px 0 0;
      font-size: 24px;
    }
    .hero-banner img.logo-left,
    .hero-banner img.logo-right {
      position: absolute;
      bottom: 20px;
      height: 60px;
    }
    .hero-banner img.logo-left {
      left: 20px;
    }
    .hero-banner img.logo-right {
      right: 20px;
    }

    /* Rest of report */
    #reportContent { padding: 30px; }
    .section-title { font-size:32px; color:#337d88; margin:60px 0 20px;
      border-bottom:2px solid #ccc; padding-bottom:10px; }
    .chart-container { height:400px; margin-bottom:60px; }
    .turma-title { font-size:22px; font-weight:bold; margin:20px 0 10px;
      color:#007c91; }
    .text-question { border:1px solid #007c91; border-left:6px solid #007c91;
      padding:16px; margin-bottom:30px; background:#f9f9f9; }
    .text-question-title { font-weight:bold; margin-bottom:8px; font-size:16px;
      color:#007c91; }
    ul { padding-left:20px; }
  </style>
</head>
<body>

  <!-- Hero Banner -->
  <div class="hero-banner">
    <!-- Left image: hourglass (replace URL with your actual image path) -->
    <img class="hourglass" src="hourglass.jpg" alt="Hourglass" />

    <!-- Centered text -->
    <div class="hero-text">
      <h1>INTERIM REPORT</h1>
      <p>JANUARY – JULY 2024</p>
    </div>

    <!-- Logos -->
    <img class="logo-left" src="ctw-logo.png" alt="Critical TechWorks" />
    <img class="logo-right" src="mind4time-logo.png" alt="MIND4TIME" />
  </div>

  <!-- Report Content -->
  <div id="reportContent"></div>

  <script>
    async function loadReport() {
      const filters = JSON.parse(localStorage.getItem('reportFilters') || '{}');
      const [data, meta] = await Promise.all([
        fetch('https://fidalgom4t.github.io/reportfinal/data.json').then(r=>r.json()),
        fetch('https://fidalgom4t.github.io/reportfinal/meta.json').then(r=>r.json())
      ]);

      const container = document.getElementById('reportContent');
      container.innerHTML = '';

      // Label & sort maps
      const labelMap = createLabelMap(meta.labels);
      const sortMap  = createSortMap(meta.labels);

      // Sections
      ['assessment','evaluation'].forEach(key => {
        const sectionTitle = key==='assessment'
          ? 'Assessment'
          : 'Avaliação do Programa';

        // Section header
        const hdr = document.createElement('div');
        hdr.className = 'section-title';
        hdr.textContent = sectionTitle;
        container.appendChild(hdr);

        // Numeric rows only
        const rows = data.filter(d =>
          d.client === filters.client &&
          d.program === filters.program &&
          (filters.turmas||[]).includes(d.turma) &&
          String(d.section||'').toLowerCase().includes(key) &&
          /^-?\d+(\.\d+)?$/.test(String(d.value||'').trim())
        );

        // Global chart
        if ((filters.turmas||[]).length > 1 && rows.length) {
          createBarChart(`Global (${sectionTitle})`, computeAverages(rows,labelMap,sortMap), container);
        }

        // Per‐turma charts
        const byTurma = groupBy(rows,'turma');
        Object.entries(byTurma).forEach(([turma, vals]) => {
          const tdiv = document.createElement('div');
          tdiv.className = 'turma-title';
          tdiv.textContent = `Turma: ${turma}`;
          container.appendChild(tdiv);
          createBarChart(turma, computeAverages(vals,labelMap,sortMap), container);
        });

        // Open‐ended
        const textRows = data.filter(d =>
          d.client === filters.client &&
          d.program === filters.program &&
          (filters.turmas||[]).includes(d.turma) &&
          String(d.section||'').toLowerCase().includes(key) &&
          !/^-?\d+(\.\d+)?$/.test(String(d.value||'').trim()) &&
          (filters.textQuestions||[]).includes(d.question)
        );
        renderTextQuestions(textRows, container);
      });
    }

    // -- Helpers (same as before) --
    function createLabelMap(labels) {
      const m = {};
      labels.forEach(l => {
        const q = l.questionId||l["QUESTION ID"];
        m[q] = l.label||l["LABEL"];
      });
      return m;
    }
    function createSortMap(labels) {
      const m = {};
      labels.forEach(l => {
        const q = l.questionId||l["QUESTION ID"];
        m[q] = +(l.sortOrder||l["SORT ORDER"]||l.sort_order);
      });
      return m;
    }
    function groupBy(arr,key) {
      return arr.reduce((acc,i)=>{
        (acc[i[key]]||(acc[i[key]]=[])).push(i);
        return acc;
      },{});
    }
    function computeAverages(rows,labelMap,orderMap) {
      const groups = {};
      rows.forEach(({question,value})=>{
        (groups[question]||(groups[question]=[])).push(+value);
      });
      const out = Object.entries(groups).map(([q,vals])=>{
        const avg = vals.reduce((a,b)=>a+b,0)/vals.length;
        return { question:q, label:labelMap[q]||q, avg:+avg.toFixed(1) };
      });
      out.sort((a,b)=>(orderMap[a.question]||0)-(orderMap[b.question]||0));
      return out;
    }
    function createBarChart(title,data,container) {
      const d = document.createElement('div');
      d.className = 'chart-container';
      container.appendChild(d);
      echarts.init(d).setOption({
        title:{text:title,left:'center',textStyle:{fontSize:18}},
        tooltip:{},
        xAxis:{type:'category',data:data.map(d=>d.label),axisLabel:{rotate:30}},
        yAxis:{type:'value',min:0,max:5},
        series:[{type:'bar',data:data.map(d=>d.avg),
          label:{show:true,position:'top',formatter:'{c}'},
          itemStyle:{color(p){const v=p.value;if(v<3)return'#d94e5d';if(v<4)return'#f2c037';return'#61c277'}}
        }]
      });
    }
    function renderTextQuestions(rows,container){
      const byQ=groupBy(rows,'question');
      Object.entries(byQ).forEach(([q,answers])=>{
        const box=document.createElement('div');
        box.className='text-question';
        const t=document.createElement('div');
        t.className='text-question-title';
        t.textContent=q;
        box.appendChild(t);
        const ul=document.createElement('ul');
        answers.forEach(a=>{const li=document.createElement('li');li.textContent=a.value;ul.appendChild(li)});
        box.appendChild(ul);
        container.appendChild(box);
      });
    }

    loadReport();
  </script>
</body>
</html>
