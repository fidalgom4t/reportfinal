<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Selecionar Filtros</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f5f5f5;
      padding: 40px;
      max-width: 800px;
      margin: auto;
    }
    h2 { margin-bottom: 24px; color: #007c91; }
    form {
      display: grid;
      grid-template-columns: 200px 1fr;
      row-gap: 20px;
      column-gap: 20px;
      align-items: start;
    }
    label { font-weight: bold; align-self: center; }

    /* Dropdown‑multiselect */
    .dropdown-multiselect { position: relative; width: 100%; }
    .select-box {
      border: 1px solid #ccc;
      background: #fff;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      user-select: none;
      position: relative;
    }
    .select-box::after {
      content: '▾';
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 12px;
      color: #666;
    }
    .checkboxes {
      display: none;
      position: absolute;
      top: calc(100% + 4px);
      width: 100%;
      max-height: 180px;
      overflow-y: auto;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      z-index: 10;
    }
    .dropdown-multiselect.open .checkboxes { display: block; }
    .checkboxes label {
      display: flex; align-items:center;
      margin-bottom:6px; font-weight:normal;
      cursor: pointer;
    }
    .checkboxes label input { margin-right:8px; }

    input[type="month"], input[type="text"] {
      padding:8px; border:1px solid #ccc; border-radius:4px;
      width:100%; box-sizing:border-box;
    }

    .program-trainer {
      grid-column: span 2;
      display: grid;
      grid-template-columns: 200px 1fr;
      column-gap: 20px;
      margin-top: 10px;
    }

    .submit-row {
      grid-column: span 2;
      text-align: center;
      margin-top: 30px;
    }
    .link-button {
      display: inline-block;
      padding: 10px 30px;
      background: #007c91;
      color: #fff;
      text-decoration: none;
      font-weight: bold;
      border-radius: 4px;
      margin: 0 10px;
    }
  </style>
</head>
<body>
  <h2>Gerar Relatório Dinâmico</h2>
  <form id="filtersForm" onsubmit="return false;">
    <!-- Cliente -->
    <label>Cliente:</label>
    <div class="dropdown-multiselect" id="clientWrapper">
      <div class="select-box" data-placeholder="Selecionar cliente(s)"
           onclick="toggleDropdown('clientWrapper')">Selecionar cliente(s)</div>
      <div class="checkboxes" id="clientChecks"></div>
    </div>

    <!-- Programas -->
    <label>Programas:</label>
    <div class="dropdown-multiselect" id="programWrapper">
      <div class="select-box" data-placeholder="Selecionar programa(s)"
           onclick="toggleDropdown('programWrapper')">Selecionar programa(s)</div>
      <div class="checkboxes" id="programChecks"></div>
    </div>

    <!-- Turmas -->
    <label>Turmas:</label>
    <div class="dropdown-multiselect" id="turmaWrapper">
      <div class="select-box" data-placeholder="Selecionar turma(s)"
           onclick="toggleDropdown('turmaWrapper')">Selecionar turma(s)</div>
      <div class="checkboxes" id="turmaChecks"></div>
    </div>

    <!-- Perguntas Abertas -->
    <label>Perguntas Abertas:</label>
    <div class="dropdown-multiselect" id="textWrapper">
      <div class="select-box" data-placeholder="Selecionar perguntas"
           onclick="toggleDropdown('textWrapper')">Selecionar perguntas</div>
      <div class="checkboxes" id="textQuestionSelect"></div>
    </div>

    <!-- Scope temporal -->
    <label>Scope temporal - Início:</label>
    <input type="month" id="startMonth" />
    <label>Scope temporal - Fim:</label>
    <input type="month" id="endMonth" />

    <!-- Formador per program -->
    <div id="trainersContainer" class="program-trainer"></div>

    <!-- Buttons -->
    <div class="submit-row">
      <a class="link-button" onclick="goToReport(false)">Ver Relatório</a>
      <a class="link-button" onclick="goToReport(true)">Download Relatório</a>
    </div>
  </form>

  <script>
    let rawData = [];

    fetch('data.json')
      .then(r => r.json())
      .then(data => {
        rawData = data;
        initFilters();
      });

    function toggleDropdown(id) {
      document.querySelectorAll('.dropdown-multiselect').forEach(el => {
        if (el.id !== id) el.classList.remove('open');
      });
      document.getElementById(id).classList.toggle('open');
    }

    function fillChecks(id, items, stored, onChange) {
      const cnt = document.getElementById(id);
      cnt.innerHTML = '';
      items.forEach(v => {
        const lbl = document.createElement('label');
        const cb  = document.createElement('input');
        cb.type    = 'checkbox';
        cb.value   = v;
        cb.checked = stored.includes(v);
        cb.onchange = () => {
          onChange();
          updateSelectText(id);
          if (id === 'programChecks') renderTrainerInputs();
        };
        lbl.appendChild(cb);
        lbl.appendChild(document.createTextNode(v));
        cnt.appendChild(lbl);
      });
      updateSelectText(id);
    }

    function updateSelectText(id) {
      const map = {
        clientChecks: 'clientWrapper',
        programChecks: 'programWrapper',
        turmaChecks: 'turmaWrapper',
        textQuestionSelect: 'textWrapper'
      };
      const wrapper = map[id];
      const box = document.querySelector(`#${wrapper} .select-box`);
      const vals = Array.from(document.getElementById(id)
        .querySelectorAll('input:checked'))
        .map(i => i.value);
      box.textContent = vals.length ? vals.join(', ') : box.getAttribute('data-placeholder');
    }

    function getChecked(id) {
      return Array.from(document.getElementById(id)
        .querySelectorAll('input:checked'))
        .map(i => i.value);
    }

    function setFilter(k, v) {
      const s = JSON.parse(localStorage.getItem('filters') || '{}');
      s[k] = v;
      localStorage.setItem('filters', JSON.stringify(s));
    }
    function getFilter(k) {
      return JSON.parse(localStorage.getItem('filters') || '{}')[k] || [];
    }

    function initFilters() {
      // CLIENTES
      const clients = [...new Set(rawData.map(d => d.client))].sort();
      fillChecks('clientChecks', clients, getFilter('clients'), () => {
        setFilter('clients', getChecked('clientChecks'));
        populatePrograms();
      });

      // PROGRAMAS / TURMAS / PERGUNTAS
      populatePrograms();
      populateTurmas();
      populateQuestions();

      // SCOPE
      const f = JSON.parse(localStorage.getItem('filters') || '{}');
      if (f.start) document.getElementById('startMonth').value = f.start;
      if (f.end)   document.getElementById('endMonth').value   = f.end;
      document.getElementById('startMonth').onchange = e => setFilter('start', e.target.value);
      document.getElementById('endMonth').onchange   = e => setFilter('end',   e.target.value);

      // TRAINERS
      renderTrainerInputs();
    }

    function populatePrograms() {
      const cl = getFilter('clients');
      const progs = [...new Set(rawData
        .filter(d => cl.includes(d.client))
        .map(d => d.program)
      )].sort();
      fillChecks('programChecks', progs, getFilter('programs'), () => {
        setFilter('programs', getChecked('programChecks'));
        populateTurmas();
      });
    }

    function populateTurmas() {
      const cl = getFilter('clients'), pr = getFilter('programs');
      const ts = [...new Set(rawData
        .filter(d => cl.includes(d.client) && pr.includes(d.program))
        .map(d => d.turma)
      )].sort();
      fillChecks('turmaChecks', ts, getFilter('turmas'), () => {
        setFilter('turmas', getChecked('turmaChecks'));
      });
    }

    function populateQuestions() {
      const cl = getFilter('clients'), pr = getFilter('programs'), ts = getFilter('turmas');
      const qs = [...new Set(rawData
        .filter(d => cl.includes(d.client) && pr.includes(d.program) && ts.includes(d.turma) && isNaN(+d.value))
        .map(d => d.question)
      )].sort();
      fillChecks('textQuestionSelect', qs, getFilter('textQuestions'), () => {
        setFilter('textQuestions', getChecked('textQuestionSelect'));
      });
    }

    function renderTrainerInputs() {
      const cont = document.getElementById('trainersContainer');
      cont.innerHTML = '';
      const pr = getFilter('programs');
      const saved = (JSON.parse(localStorage.getItem('filters') || '{}').trainers) || {};
      pr.forEach(p => {
        const div = document.createElement('div');
        div.className = 'program-trainer';
        const lbl = document.createElement('label');
        lbl.textContent = `Formador (${p}):`;
        const inp = document.createElement('input');
        inp.type = 'text';
        inp.value = saved[p] || '';
        inp.placeholder = `Nome do formador para ${p}`;
        inp.oninput = () => {
          saved[p] = inp.value;
          const f = JSON.parse(localStorage.getItem('filters') || '{}');
          f.trainers = saved;
          localStorage.setItem('filters', JSON.stringify(f));
        };
        div.appendChild(lbl);
        div.appendChild(inp);
        cont.appendChild(div);
      });
    }

    function goToReport(download) {
      const f = {
        clients: getChecked('clientChecks'),
        programs: getChecked('programChecks'),
        turmas: getChecked('turmaChecks'),
        textQuestions: getChecked('textQuestionSelect'),
        start: document.getElementById('startMonth').value,
        end:   document.getElementById('endMonth').value,
        trainers: (JSON.parse(localStorage.getItem('filters') || '{}').trainers) || {}
      };
      localStorage.setItem('reportFilters', JSON.stringify(f));
      const url = 'report.html' + (download ? '?download=true' : '');
      window.location.href = url;
    }
  </script>
</body>
</html>
