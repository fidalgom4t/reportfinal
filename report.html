<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8"/>
  <title>Training Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- Roboto & ECharts -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

  <!-- html2canvas & pdfMake -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<style>
  /* Reset & background behind pages */
  html, body {
    margin: 0;
    padding: 0;
    font-family: 'Roboto', sans-serif;
    background: #333;
  }

  /* PDF page size */
  @page { size: 960px 540px; margin: 0; }
  @media print { .page { page-break-after: always; } }

  /* The page container */
  .page {
    position: relative;
    width: 960px;
    aspect-ratio: 16/9;       /* 960×540 */
    margin: 20px auto;
    background: #fff;
    overflow: hidden;         /* no bleed outside */
  }

  /* Header & footer bars */
  .header,
  .footer {
    position: absolute;
    left: 0; right: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #fff;
    padding: 0 30px;
    z-index: 10;
  }
  .header {
    top: 0;
    height: 80px;
    border-bottom: 1px solid #40a3a3;
  }
  .header img {
    height: 60px;
  }
  .footer {
    bottom: 0;
    height: 60px;
    border-top: 1px solid #40a3a3;
    color: #007c91;
    font-size: 14px;
  }

  /* All inner sections sit between header (80px) & footer (60px) */
  .page > .hero,
  .page > .banner,
  .page > .chart-fullpage,
  .page > .chart-grid,
  .page > .text-page {
    margin: 80px 0 60px;
    width: 960px;
    box-sizing: border-box;
  }

  /* Hero */
  .hero {
    height: 400px;            /* 540 - 80 - 60 */
    position: relative;
    overflow: hidden;
  }
  .hero .bg {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    object-fit: cover;
  }
  .hero-content {
    position: relative; z-index: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: #fff;
    text-align: center;
    height: 100%;
    padding: 0 30px;
    box-sizing: border-box;
  }

  /* Banner */
  .banner {
    height: 400px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .banner-box {
    background: #f0f8f9;
    padding: 40px 60px;
    border-left: 6px solid #007c91;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    width: 70%;
    box-sizing: border-box;
  }

  /* Single (global) chart */
  .chart-fullpage {
    height: 400px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .chart-full {
    width: 100%;
    height: 100%;
  }

  /* 2‑chart grid */
  .chart-grid {
    height: 400px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr;
    gap: 20px;
    padding: 0 20px;
    box-sizing: border-box;
  }
  .chart-box {
    width: 100%;
    height: 100%;
  }

  /* Text answer pages */
  .text-page {
    height: 400px;
    overflow-y: auto;
    padding: 0 30px;
    box-sizing: border-box;
  }
  .text-question {
    border: 1px solid #007c91;
    border-left: 6px solid #007c91;
    background: #f9f9f9;
    padding: 24px 32px;
    width: 80%;
    margin: 0 auto 40px;
    box-sizing: border-box;
    page-break-inside: avoid;
    break-inside: avoid;
  }
  .text-question-title {
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 12px;
    color: #007c91;
  }
  .text-question ul {
    padding-left: 20px;
    font-size: 16px;
    line-height: 1.8;
  }
  .text-question li {
    margin-bottom: 12px;
  }

  /* PDF button */
  #gerar-pdf {
    position: fixed;
    top: 10px; right: 10px;
    z-index: 1000;
    padding: 10px 20px;
    background: #007c91;
    color: #fff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
</style>

</head>
<body>
  <button id="gerar-pdf">Gerar Relatório (PDF)</button>
  <div id="report"></div>

  <script>
    const currentYear = new Date().getFullYear();

    // Data helpers
    function createLabelMap(labels) {
      const m = {};
      labels.forEach(l => {
        const k = l.questionId || l['QUESTION ID'];
        m[k] = l.label || l['LABEL'];
      });
      return m;
    }
    function createSortMap(labels) {
      const m = {};
      labels.forEach(l => {
        const k = l.questionId || l['QUESTION ID'];
        m[k] = +(l.sortOrder || l['SORT ORDER'] || l.sort_order);
      });
      return m;
    }
    function groupBy(arr, k) {
      return arr.reduce((o,i)=>((o[i[k]]||(o[i[k]]=[])).push(i),o),{});
    }
    function computeAverages(rows, LM, OM) {
      const g = {};
      rows.forEach(({question,value}) => {
        (g[question]||(g[question]=[])).push(+value);
      });
      return Object.entries(g).map(([q,vals])=>({
        question:q,
        label:LM[q]||q,
        avg:+(vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(1)
      })).sort((a,b)=>(OM[a.question]||0)-(OM[b.question]||0));
    }
    function countUnique(rows, sec) {
      return new Set(rows.filter(d=>String(d.section||'').toLowerCase().includes(sec))
                         .map(d=>d.respondent_id||d.id)).size;
    }
    function formatMonthYear(val) {
      const names={'01':'janeiro','02':'fevereiro','03':'março','04':'abril','05':'maio','06':'junho','07':'julho','08':'agosto','09':'setembro','10':'outubro','11':'novembro','12':'dezembro'};
      const [y,m]=val.split('-'); return {month:names[m],year:y};
    }

    // Chart builder
    function createBarChart(container,title,data,uniform){
      const chart=echarts.init(container);
      chart.setOption({
        title:{text:title,left:'center',textStyle:{fontSize:20}},
        grid:{top:80,left:'10%',right:'10%',bottom:100},
        tooltip:{}, xAxis:{type:'category',data:data.map(d=>d.label),axisLabel:{rotate:30,interval:0}},
        yAxis:{type:'value',min:0,max:5,splitLine:{show:false},axisLine:{show:false},axisTick:{show:false},axisLabel:{show:false}},
        series:[{type:'bar',data:data.map(d=>d.avg),label:{show:true,position:'top',formatter:'{c}'},itemStyle:uniform?{color:'#6A99D0'}:{color:p=>{const v=p.value;return v<3?'#EA3323':v<4?'#6A99D0':'#9FCE63';}}}]
      });
      chart.resize(); setTimeout(()=>chart.resize(),300);
    }

    // Build report
    async function build(){
      const f=JSON.parse(localStorage.getItem('reportFilters')||'{}');
      const [data,meta]=await Promise.all([fetch('data.json').then(r=>r.json()),fetch('meta.json').then(r=>r.json())]);
      const LM=createLabelMap(meta.labels), OM=createSortMap(meta.labels);
      const root=document.getElementById('report');root.innerHTML='';
      let timeScope='';
      if(f.start&&f.end){const s=formatMonthYear(f.start),e=formatMonthYear(f.end);timeScope=`${s.month} – ${e.month} ${e.year}`;}
      for(const prog of f.programs||[]){
        const turKey=`turmas_${prog}`, selTur=f[turKey]||[];
        const rows=data.filter(d=>(f.clients||[]).includes(d.client)&&d.program===prog&&selTur.includes(d.turma));
        const pm=meta.titles.find(t=>t.program_id===prog)||{};
        // Hero
        const hero=document.createElement('div');hero.className='page hero';
        hero.innerHTML=`
          <div class="header"><img src="mind4time-logo.png"><div></div></div>
          <img class="bg" src="hourglass-bg.jpg">
          <div class="hero-content">
            <small>${pm.SUBTÍTULO||''}</small>
            <h1>${pm.TÍTULO||prog}</h1>
            <div class="subtitle">${pm.TAGLINE||''}</div>
            <div class="meta">
              <div><span>time scope</span><strong>${timeScope}</strong></div>
              <div><span>trainers</span><strong>${(f.trainers||{})[prog]||'N/A'}</strong></div>
            </div>
          </div>
          <div class="footer"><div>www.MIND4TIME.com</div><div>© MIND4TIME ${currentYear}</div></div>`;
        root.appendChild(hero);

        // Sections
        for(const sec of['assessment','evaluation']){
          const name=sec==='assessment'?'Assessment':'Avaliação do Programa';
          const total=countUnique(rows,sec);
          const numeric=rows.filter(d=>String(d.section||'').toLowerCase().includes(sec)&&/^\d+(\.\d+)?$/.test(String(d.value).trim()));
          const byT=Object.entries(groupBy(numeric,'turma'));

          // Banner
          const ban=document.createElement('div');ban.className='page banner';
          ban.innerHTML=`
            <div class="header"><img src="mind4time-logo.png"><div></div></div>
            <div class="banner-box"><h1>${name}</h1><div class="meta"><div><span>Total de respostas:</span><strong>${total}</strong></div></div></div>
            <div class="footer"><div>www.MIND4TIME.com</div><div>© MIND4TIME ${currentYear}</div></div>`;
          root.appendChild(ban);

          // Global
          if(numeric.length){
            const gp=document.createElement('div');gp.className='page chart-fullpage';
            gp.innerHTML=`
              <div class="header"><img src="mind4time-logo.png"><div></div></div>
              <div class="chart-full" id="chart-global-${prog}-${sec}"></div>
              <div class="footer"><div>www.MIND4TIME.com</div><div>© MIND4TIME ${currentYear}</div></div>`;
            root.appendChild(gp);
            createBarChart(gp.querySelector('.chart-full'),`Global (${name})`,computeAverages(numeric,LM,OM),sec==='evaluation');
          }

          // 2‑chart grid
          if(byT.length>1){
            for(let i=0;i<byT.length;i+=2){
              const gp2=document.createElement('div');gp2.className='page chart-grid';
              gp2.innerHTML=`<div class="header"><img src="mind4time-logo.png"><div></div></div>`;
              byT.slice(i,i+2).forEach(([,vals],j)=>gp2.innerHTML+=`<div class="chart-box" id="chart-${prog}-grid-${i+j}"></div>`);
              gp2.innerHTML+=`<div class="footer"><div>www.MIND4TIME.com</div><div>© MIND4TIME ${currentYear}</div></div>`;
              root.appendChild(gp2);
              byT.slice(i,i+2).forEach(([,vals],j)=>{
                createBarChart(
                  document.getElementById(`chart-${prog}-grid-${i+j}`),
                  byT[i+j][0],
                  computeAverages(vals,LM,OM),
                  sec==='evaluation'
                );
              });
            }
          }

          // Text answers (12/page)
          const selQs=f.textQuestions||[];
          selQs.forEach(q=>{
            const ans=rows.filter(d=>String(d.section||'').toLowerCase().includes(sec)&&d.question===q&&isNaN(+d.value));
            if(!ans.length) return;
            for(let i=0;i<ans.length;i+=12){
              const chunk=ans.slice(i,i+12);
              const tp=document.createElement('div');tp.className='page text-page';
              tp.innerHTML=`
                <div class="header"><img src="mind4time-logo.png"><div></div></div>
                <div class="text-question">
                  ${i===0?`<div class="text-question-title">${q}</div>`:``}
                  <ul>${chunk.map(a=>`<li>${a.value.replace(/\\n/g,'</li><li>')}</li>`).join('')}</ul>
                </div>
                <div class="footer"><div>www.MIND4TIME.com</div><div>© MIND4TIME ${currentYear}</div></div>`;
              root.appendChild(tp);
            }
          });
        }
      }
    }

    // PDF
    async function generatePdf(){
      await build();
      const pages=Array.from(document.querySelectorAll('.page')), images=[];
      for(const pg of pages){
        const c=await html2canvas(pg,{backgroundColor:'#fff',scale:2});
        images.push(c.toDataURL());
      }
      pdfMake.createPdf({
        pageSize:'A4', pageOrientation:'landscape', pageMargins:[0,0,0,0],
        content: images.map((img,i)=>({ image:img, width:842, pageBreak: i<images.length-1?'after':undefined }))
      }).download('report.pdf');
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      build();
      document.getElementById('gerar-pdf').addEventListener('click', generatePdf);
    });
  </script>
</body>
</html>
