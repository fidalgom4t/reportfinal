<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8"/>
  <title>Training Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- Roboto font -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap" rel="stylesheet">

  <!-- ECharts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <!-- pdfMake -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

  <style>
    /* ============================
       Global & Page-frame Styles
       ============================ */
    body, .page, .header, .footer,
    .hero-content, .banner-box,
    .chart-fullpage, .chart-grid,
    .text-page, .text-question {
      font-family: 'Roboto', sans-serif;
    }
    @page { size: 11in 8.5in; margin: 0; }
    @media print {
      .page { page-break-after: always; }
      .chart-full, .chart-box {
        height: calc(100% - 35mm);
      }
    }
    .page {
      position: relative;
      width: 100vw; height: 100vh;
      box-sizing: border-box;
      padding: 80px 0 60px;
      overflow: visible;
    }

    /* =================
       Header & Footer
       ================= */
    .header, .footer {
      position: absolute; left:0; right:0;
      display: flex; justify-content: space-between; align-items: center;
      background: #fff; padding: 0 30px; z-index: 2;
    }
    .header { top:0; height: 80px; border-bottom: 1px solid #40a3a3; }
    .header img { height: 60px; }
    .footer { bottom:0; height: 60px; font-size: 14px; color: #007c91; border-top: 1px solid #40a3a3; }

    /* ==============
       Hero & Banner
       ============== */
    .hero, .banner {
      position: absolute;
      top: 80px; bottom: 60px; left:0; right:0;
      display: flex; align-items: center; justify-content: center;
      text-align: center;
      background-size: cover; background-position: center;
      color: #fff;
    }
    .hero .bg {
      position: absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; z-index:0;
    }
    .hero-content, .banner-box {
      position: relative; z-index:1;
      width: 80%; display: flex; flex-direction: column;
      align-items: center; justify-content: center; height: 100%;
    }
    .hero-content small,
    .banner-box .meta span {
      font-style: italic;
    }

    .banner-box {
      background: rgba(240,248,249,0.9);
      padding: 5mm 8mm; border-left: 3mm solid #007c91;
      box-shadow: 0 1mm 2mm rgba(0,0,0,0.1);
    }

    /* =================
       Chart Containers
       ================= */
    .chart-fullpage {
      position:absolute; top:80px; bottom:60px; left:0; right:0;
      display:flex; align-items:center; justify-content:center;
      background:#fff;
    }
    .chart-full { width:90%; height:90%; }

    .chart-grid {
      position:absolute; top:80px; bottom:60px; left:0; right:0;
      display:grid; grid-template-columns:1fr 1fr; gap:5mm;
      padding:5mm; box-sizing:border-box;
    }
    .chart-box { width:100%; height:100%; }

    /* ================
       Text Question
       ================ */
    .text-page {
      position: relative; width:100%; height:100%; background:#fff;
    }
    .text-question {
      position:absolute; top:80px; left:10mm; right:10mm; bottom:60px;
      padding:4mm; background:#f9f9f9;
      border:1mm solid #007c91; border-left:3mm solid #007c91;
      overflow:auto; box-sizing:border-box;
    }
    .text-question-title {
      font-size:5mm; font-weight:bold; color:#007c91;
      margin-bottom:2mm;
    }
    .text-question ul { padding-left:5mm; font-size:4mm; line-height:1.4; }
    .text-question li { margin-bottom:2mm; }

    /* PDF button (fixed) */
    #gerar-pdf {
      position:fixed; top:20px; right:20px; z-index:1000;
      padding:10px 20px; background:#007c91; color:#fff;
      border:none; border-radius:4px; cursor:pointer;
    }
  </style>
</head>

<body>
  <!-- PDF Generation Trigger -->
  <button id="gerar-pdf">Gerar Relatório (PDF)</button>

  <!-- Dynamic Report Container -->
  <div id="report"></div>

  <script>
    // ====================
    // Section: Utilities
    // ====================
    const currentYear = new Date().getFullYear();

    function createLabelMap(labels) {
      const m = {};
      labels.forEach(l => {
        const k = l.questionId || l['QUESTION ID'];
        m[k] = l.label || l['LABEL'];
      });
      return m;
    }

    function createSortMap(labels) {
      const m = {};
      labels.forEach(l => {
        const k = l.questionId || l['QUESTION ID'];
        m[k] = +(l.sortOrder || l['SORT ORDER'] || l.sort_order);
      });
      return m;
    }

    function groupBy(arr, key) {
      return arr.reduce((o, i) => {
        (o[i[key]] ||= []).push(i);
        return o;
      }, {});
    }

    function formatMonthYear(val) {
      const names = {
        '01':'janeiro','02':'fevereiro','03':'março','04':'abril',
        '05':'maio','06':'junho','07':'julho','08':'agosto',
        '09':'setembro','10':'outubro','11':'novembro','12':'dezembro'
      };
      if (/^\d{4}-\d{2}$/.test(val)) {
        const [y,m] = val.split('-');
        return { month: names[m], year: y };
      }
      const [m,y] = val.split(' ');
      return { month: m, year: y };
    }

    // ======================
    // Section: Chart Builder
    // ======================
    function computeAverages(rows, LM, OM) {
      const groups = {};
      rows.forEach(({question,value}) => {
        (groups[question] ||= []).push(+value);
      });
      return Object.entries(groups)
        .map(([q, vals]) => ({
          question: q,
          label: LM[q] || q,
          avg: +(vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(1)
        }))
        .sort((a,b) => (OM[a.question]||0) - (OM[b.question]||0));
    }

    function createBarChart(div, title, data, uniform) {
      const chart = echarts.init(div);
      chart.setOption({
        title: { text: title, left: 'center', textStyle: { fontSize: 12 } },
        grid: { top:20, left:20, right:20, bottom:20 },
        tooltip: {},
        xAxis: {
          type: 'category',
          data: data.map(d => d.label),
          axisLabel: { rotate:30, interval:0 }
        },
        yAxis: {
          type: 'value',
          min: 0, max: 5,
          axisLine:{show:false}, axisTick:{show:false}, splitLine:{show:false}
        },
        series: [{
          type: 'bar',
          data: data.map(d => d.avg),
          label: { show:true, position:'top', formatter:'{c}' },
          itemStyle: uniform
            ? { color: '#6A99D0' }
            : { color(p){ const v=p.value; return v<3? '#EA3323' : v<4? '#6A99D0' : '#9FCE63'; }}
        }]
      });
      chart.resize();
      setTimeout(()=>chart.resize(), 300);
      return chart;
    }

    function countUnique(rows, sec) {
      return new Set(
        rows.filter(d => String(d.section||'').toLowerCase().includes(sec))
            .map(d => d.respondent_id || d.id)
      ).size;
    }

    // ========================
    // Section: Report Builder
    // ========================
    async function buildReport() {
      const filters = JSON.parse(localStorage.getItem('reportFilters') || '{}');
      const [data, meta] = await Promise.all([
        fetch('data.json').then(r=>r.json()),
        fetch('meta.json').then(r=>r.json())
      ]);

      const LM = createLabelMap(meta.labels);
      const OM = createSortMap(meta.labels);
      const container = document.getElementById('report');
      container.innerHTML = '';

      let timeScope = '';
      if (filters.start && filters.end) {
        const s = formatMonthYear(filters.start),
              e = formatMonthYear(filters.end);
        timeScope = `${s.month} – ${e.month} ${e.year}`;
      }

      for (const prog of filters.programs || []) {
        const all = data.filter(d =>
          (filters.clients||[]).includes(d.client) &&
          d.program === prog &&
          (filters.turmas||[]).includes(d.turma)
        );
        const pm = meta.titles.find(t => t.program_id===prog) || {};

        // Hero Page
        const hero = document.createElement('div');
        hero.className = 'page hero';
        hero.style.backgroundImage = "url('hourglass-bg.jpg')";
        hero.innerHTML = `
          <div class="header"><img src="mind4time-logo.png"></div>
          <div class="hero-content">
            <small>${pm.SUBTÍTULO || ''}</small>
            <h1>${pm.TÍTULO || prog}</h1>
            <div class="subtitle">${pm.TAGLINE || ''}</div>
            <div class="meta">
              <span>time scope:</span> <strong>${timeScope}</strong>
              <span>trainers:</span> <strong>${filters.trainers?.[prog] || 'N/A'}</strong>
            </div>
          </div>
          <div class="footer">© MIND4TIME ${currentYear}</div>
        `;
        container.appendChild(hero);

        // Assessment & Evaluation
        for (const sec of ['assessment','evaluation']) {
          const name = sec==='assessment' ? 'Assessment' : 'Avaliação do Programa';
          const uniq = countUnique(all, sec);
          const numeric = all.filter(d =>
            String(d.section||'').toLowerCase().includes(sec) &&
            /^\d+(\.\d+)?$/.test(String(d.value).trim())
          );
          const byTurma = Object.entries(groupBy(numeric,'turma'));

          // Banner
          const ban = document.createElement('div');
          ban.className = 'page banner';
          ban.style.backgroundImage = `url('${sec}-bg.jpg')`;
          ban.innerHTML = `
            <div class="header"><img src="mind4time-logo.png"></div>
            <div class="banner-box">
              <h1>${name}</h1>
              <div class="meta">
                <span>Total de respostas:</span> <strong>${uniq}</strong>
                ${sec==='assessment' ? `<span>time scope:</span> <strong>${timeScope}</strong>
                                        <span>trainers:</span> <strong>${filters.trainers?.[prog] || 'N/A'}</strong>` : ''}
              </div>
            </div>
            <div class="footer">© MIND4TIME ${currentYear}</div>
          `;
          container.appendChild(ban);

          // Global Chart
          if (numeric.length) {
            const pg = document.createElement('div');
            pg.className = 'page chart-fullpage';
            pg.innerHTML = `
              <div class="header"><img src="mind4time-logo.png"></div>
              <div class="chart-full" id="chart-global-${prog}-${sec}"></div>
              <div class="footer">© MIND4TIME ${currentYear}</div>
            `;
            container.appendChild(pg);
            createBarChart(
              pg.querySelector('.chart-full'),
              `Global (${name})`,
              computeAverages(numeric, LM, OM),
              sec==='evaluation'
            );
          }

          // By-turma Grid
          if (byTurma.length > 1) {
            for (let i = 0; i < byTurma.length; i += 4) {
              const grid = document.createElement('div');
              grid.className = 'page chart-grid';
              const header = `<div class="header"><img src="mind4time-logo.png"></div>`;
              grid.innerHTML = header;
              byTurma.slice(i,i+4).forEach(([, vals], idx) => {
                grid.innerHTML += `<div class="chart-box" id="chart-${prog}-${sec}-${i+idx}"></div>`;
              });
              grid.innerHTML += `<div class="footer">© MIND4TIME ${currentYear}</div>`;
              container.appendChild(grid);
              byTurma.slice(i,i+4).forEach(([, vals], idx) => {
                createBarChart(
                  document.getElementById(`chart-${prog}-${sec}-${i+idx}`),
                  byTurma[i+idx][0],
                  computeAverages(vals, LM, OM),
                  sec==='evaluation'
                );
              });
            }
          }

          // Text Questions
          const byQ = groupBy(
            all.filter(d =>
              String(d.section||'').toLowerCase().includes(sec) &&
              isNaN(parseFloat(d.value)) &&
              (filters.textQuestions||[]).includes(d.question)
            ), 'question'
          );
          Object.entries(byQ).forEach(([q, answers]) => {
            const txt = document.createElement('div');
            txt.className = 'page text-page';
            txt.innerHTML = `
              <div class="header"><img src="mind4time-logo.png"></div>
              <div class="text-question">
                <div class="text-question-title">${q}</div>
                <ul>${answers.map(a => `<li>${a.value.replace(/\n/g,'</li><li>')}</li>`).join('')}</ul>
              </div>
              <div class="footer">© MIND4TIME ${currentYear}</div>
            `;
            container.appendChild(txt);
          });
        }
      }
    }

    // =====================
    // Section: PDF Creator
    // =====================
    async function generatePdf() {
      // Pause for chart resize
      await new Promise(r => setTimeout(r, 200));

      // Snapshot each chart container
      const chartEls = document.querySelectorAll('.chart-full, .chart-box');
      const images = Array.from(chartEls).map(el => {
        const c = echarts.getInstanceByDom(el);
        return c.getDataURL({ pixelRatio: 2, backgroundColor: '#ffffff' });
      });

      // Build pdfMake definition
      const doc = {
        pageSize: 'A4',
        pageOrientation: 'landscape',
        pageMargins: [40, 60, 40, 60],
        footer: (cp, pc) => ({
          columns: [
            { text: `© MIND4TIME ${currentYear}`, alignment: 'left', fontSize: 8 },
            { text: `Página ${cp}/${pc}`, alignment: 'right', fontSize: 8 }
          ],
          margin: [40, 0, 40, 20]
        }),
        content: [],
        styles: {
          subheader: { fontSize: 14, bold: true, margin: [0, 10, 0, 5] }
        }
      };

      let imgIndex = 0;
      document.querySelectorAll('#report .page').forEach((pg, i, all) => {
        if (pg.querySelector('.chart-full')) {
          doc.content.push({ image: images[imgIndex++], width: 740 });
        } else if (pg.querySelectorAll('.chart-box').length) {
          const cols = [];
          pg.querySelectorAll('.chart-box').forEach(() => {
            cols.push({ image: images[imgIndex++], width: 360, margin: [0,0,10,10] });
          });
          doc.content.push({ columns: cols, columnGap: 10 });
        } else if (pg.querySelector('.text-question-title')) {
          const title = pg.querySelector('.text-question-title').innerText;
          const items = Array.from(pg.querySelectorAll('.text-question ul li')).map(li => li.innerText);
          doc.content.push({ text: title, style: 'subheader' });
          doc.content.push({ ul: items });
        }
        if (i < all.length - 1) doc.content.push({ text: '', pageBreak: 'after' });
      });

      pdfMake.createPdf(doc).download('report.pdf');
    }

    // ================
    // Initialization
    // ================
    document.addEventListener('DOMContentLoaded', async () => {
      await buildReport();
      document.getElementById('gerar-pdf').addEventListener('click', generatePdf);
    });
  </script>
</body>
</html>
