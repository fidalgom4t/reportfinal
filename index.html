<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Gerar Relatório Dinâmico</title>
  <style>
    :root {
      --primary: #007c91;
      --bg: #f5f5f5;
      --card: #fff;
      --border: #ccc;
      --radius: 6px;
      --gap: 12px;
    }
    *, *::before, *::after { box-sizing: border-box; }
    body {
      margin: 40px auto;
      padding: 0 var(--gap);
      max-width: 900px;
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg);
      color: #333;
    }
    h2 {
      text-align: center;
      color: var(--primary);
      margin-bottom: var(--gap);
    }
    form {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--gap);
      margin-bottom: var(--gap);
    }
    .checkbox-list {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: var(--gap);
    }
    .checkbox-list label {
      font-weight: bold;
      color: var(--primary);
      margin-bottom: 8px;
      display: block;
    }
    .styled-checkbox-list {
      list-style: none;
      margin: 0;
      padding: 0;
      max-height: 160px;
      overflow-y: auto;
    }
    .styled-checkbox-list li {
      margin-bottom: 6px;
    }
    .styled-checkbox-list input[type="checkbox"] {
      margin-right: 8px;
    }
    .toggle-container,
    .actions {
      text-align: center;
      margin-top: var(--gap);
    }
    button {
      padding: 10px 24px;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 1rem;
    }
    button:disabled {
      background: #999;
      cursor: not-allowed;
    }
    .dynamic-block {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: var(--gap);
      margin-bottom: var(--gap);
    }
    .dynamic-block h3,
    .dynamic-block h4 {
      color: var(--primary);
      margin: 0 0 var(--gap) 0;
      font-weight: bold;
    }
    .dynamic-block label {
      display: block;
      margin-bottom: 6px;
      font-weight: normal;
      color: #333;
    }
    .dynamic-block input[type="text"],
    .dynamic-block input[type="month"] {
      width: calc(100% - 12px);
      padding: 6px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 1rem;
      margin-bottom: var(--gap);
    }
    .dynamic-block .styled-checkbox-list,
    .dynamic-block ol {
      list-style: none;
      margin: 0;
      padding: 0 0 0 20px;
    }
    .dynamic-block .styled-checkbox-list li,
    .dynamic-block ol li {
      margin-bottom: 8px;
      line-height: 1.5;
    }
    .dynamic-block input[type="checkbox"] {
      margin-right: 8px;
    }
    /* botão selec all styling */
    .select-all-btn {
      display: inline-block;
      margin-bottom: 8px;
      background: transparent;
      color: var(--primary);
      border: 1px solid var(--primary);
      padding: 4px 8px;
      border-radius: var(--radius);
      font-size: 0.9rem;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2>Gerar Relatório Dinâmico</h2>

  <form id="filtersForm" onsubmit="return false;">
    <div class="checkbox-list">
      <label>Cliente</label>
      <ul id="clientList" class="styled-checkbox-list"></ul>
    </div>
    <div class="checkbox-list">
      <label>Programas</label>
      <button id="selectAllPrograms" class="select-all-btn" type="button">Selecionar Todos</button>
      <ul id="programList" class="styled-checkbox-list"></ul>
    </div>
    <div class="checkbox-list">
      <label>Cliente Info</label>
      <button id="selectAllInfos" class="select-all-btn" type="button">Selecionar Todos</button>
      <ul id="infoList" class="styled-checkbox-list"></ul>
    </div>
  </form>

  <div id="dynamicBlocks"></div>

  <div class="actions">
    <button id="viewReport" disabled>Ver Relatório</button>
  </div>

  <div class="toggle-container">
    <button id="toggleQuestions" disabled>Mostrar / Esconder Perguntas Abertas</button>
  </div>
  <div id="textQuestionsBlock" style="display:none;"></div>

  <script>
    let data = [];

    function loadFilters() { return JSON.parse(localStorage.getItem('filters') || '{}'); }
    function saveFilters(f) { localStorage.setItem('filters', JSON.stringify(f)); }
    function updateFilter(key, val) { const f = loadFilters(); f[key] = val; saveFilters(f); }

    function init() {
      const f = loadFilters() || {};
      delete f.clients; delete f.programs; delete f.clientInfos;
      saveFilters(f);
      fetchDataAndInitUI();
    }

    async function fetchDataAndInitUI() {
      try { data = await fetch('data.json').then(r => r.json()); }
      catch { alert('Erro ao carregar dados.'); return; }
      populateClients(); initFilters(); attachSelectAll();
    }

    function attachSelectAll() {
      document.getElementById('selectAllPrograms').onclick = () => {
        const cbs = document.querySelectorAll('#programList input[type="checkbox"]');
        const vals = [];
        cbs.forEach(cb => { cb.checked = true; vals.push(cb.value); });
        updateFilter('programs', vals);
        initFilters();
      };
      document.getElementById('selectAllInfos').onclick = () => {
        const cbs = document.querySelectorAll('#infoList input[type="checkbox"]');
        const vals = [];
        cbs.forEach(cb => { cb.checked = true; vals.push(cb.value); });
        updateFilter('clientInfos', vals);
        refreshDynamic();
      };
    }

    function populateClients() {
      const clients = [...new Set(data.map(d => d.client))].sort();
      const list = document.getElementById('clientList'); list.innerHTML = '';
      clients.forEach(c => createListItem(list, c, 'clients', initFilters));
    }

    function createListItem(container, text, key, onChange) {
      const li = document.createElement('li');
      const lbl = document.createElement('label');
      const cb = document.createElement('input'); cb.type = 'checkbox'; cb.value = text;
      cb.checked = (loadFilters()[key] || []).includes(text);
      cb.onchange = () => { const vals = Array.from(container.querySelectorAll('input:checked')).map(i => i.value); updateFilter(key, vals); onChange(); };
      lbl.append(cb, text); li.appendChild(lbl); container.appendChild(li);
    }

    function initFilters() {
      const f = loadFilters(); const client = f.clients?.[0];
      populateList('programList', client ? [...new Set(data.filter(d => d.client===client).map(d => d.program))].sort() : [], 'programs', () => { updateInfoList(client); refreshDynamic(); });
      updateInfoList(client);
      refreshDynamic();
    }

    function updateInfoList(client) {
      const f = loadFilters(); const progs = f.programs || [];
      const infos = (client && progs.length)
        ? [...new Set(data.filter(d => d.client===client && progs.includes(d.program)).map(d => d.client_info))].sort()
        : [];
      populateList('infoList', infos, 'clientInfos', refreshDynamic);
    }

    function populateList(id, items, key, cb) {
      const list = document.getElementById(id); list.innerHTML = '';
      items.forEach(i => createListItem(list, i, key, cb));
      updateFilter(key, []);
    }

    function createInputField(label, prog, key) {
      const w = document.createElement('div'); const l = document.createElement('label'); l.textContent = label;
      const i = document.createElement('input'); i.type = 'text'; i.value = (loadFilters()[key]||{})[prog]||'';
      i.oninput = e => { const o=loadFilters()[key]||{}; o[prog]=e.target.value; updateFilter(key,o); };
      w.append(l,i); return w;
    }

    function createMonthField(label, prog, key) {
      const w = document.createElement('div'); const l=document.createElement('label'); l.textContent = label;
      const i=document.createElement('input'); i.type='month'; i.value=(loadFilters()[key]||{})[prog]||'';
      i.onchange=e=>{const o=loadFilters()[key]||{};o[prog]=e.target.value;updateFilter(key,o);}; w.append(l,i); return w;
    }

    function refreshDynamic() {
      const f = loadFilters(); const client = f.clients?.[0];
      const progs = f.programs||[]; const infos=f.clientInfos||[];
      const db=document.getElementById('dynamicBlocks'); db.innerHTML='';
      const vb=document.getElementById('viewReport'); const tb=document.getElementById('toggleQuestions');
      tb.disabled=false; vb.disabled=(!client||!progs.length||!infos.length);
      if(!client||!progs.length||!infos.length) return;
      progs.forEach(p=>db.appendChild(renderBlock(client,p,infos)));
      renderTextQuestions();
    }

    // renderBlock, renderTextQuestions, applyAndGo, buildCheckboxGroup same as before...

    document.addEventListener('DOMContentLoaded',()=>{
      init();
      document.getElementById('toggleQuestions').addEventListener('click',()=>{
        const b=document.getElementById('textQuestionsBlock');
        b.style.display=b.style.display==='none'?'block':'none';
      });
      document.getElementById('viewReport').addEventListener('click',()=>applyAndGo(false));
    });
  </script>
</body>
</html>
