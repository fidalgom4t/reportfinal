<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8"/>
  <title>Training Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- Roboto font -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap" rel="stylesheet">
  <!-- ECharts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <!-- pdfMake -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

  <style>
    body, .page, .header, .footer, .hero-content, .banner-box,
    .chart-fullpage, .chart-grid, .text-question {
      font-family: 'Roboto', sans-serif;
    }
    body { margin:0; padding:0; }
    #report { padding: 20px; }

    .page { margin-bottom: 20px; }
    .header, .footer { display:flex; justify-content:space-between; align-items:center; }
    .hero, .banner, .chart-fullpage, .text-question { margin: 20px 0; }
    .hero { background:#333; color:#fff; text-align:center; padding:20px; }
    .banner { background:#f0f8f9; padding:20px; }
    .chart-fullpage { height:300px; }
    .chart-full { width:100%; height:100%; }
    .chart-grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
    .chart-box { height:200px; }
    .text-question { border:1px solid #007c91; padding:20px; }
  </style>
</head>
<body>
  <button id="gerar-pdf">Gerar Relatório (PDF)</button>
  <div id="report"></div>

  <script>
    const currentYear = new Date().getFullYear();

    // ——— Helpers ———
    const createLabelMap = labels => {
      const m = {}; labels.forEach(l => {
        const k = l.questionId || l['QUESTION ID'];
        m[k] = l.label || l['LABEL'];
      });
      return m;
    };
    const createSortMap = labels => {
      const m = {}; labels.forEach(l => {
        const k = l.questionId || l['QUESTION ID'];
        m[k] = +(l.sortOrder || l['SORT ORDER'] || l.sort_order);
      });
      return m;
    };
    const groupBy = (arr,key) =>
      arr.reduce((o,i)=>(o[i[key]]?o[i[key]].push(i):o[i[key]]=[i],o),{});
    const computeAverages = (rows,LM,OM) => {
      const g = {};
      rows.forEach(({question,value})=>(g[question]||=[]).push(+value));
      return Object.entries(g).map(([q,vals])=>({
        question:q, label:LM[q]||q,
        avg:+(vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(1)
      })).sort((a,b)=> (OM[a.question]||0)-(OM[b.question]||0));
    };
    const countUnique = (rows,sec) =>
      new Set(rows.filter(d=>String(d.section||'').toLowerCase().includes(sec))
        .map(d=>d.respondent_id||d.id)).size;
    const formatMonthYear = val => {
      const names = {'01':'janeiro','02':'fevereiro','03':'março','04':'abril',
        '05':'maio','06':'junho','07':'julho','08':'agosto',
        '09':'setembro','10':'outubro','11':'novembro','12':'dezembro'};
      if(/^\d{4}-\d{2}$/.test(val)){ const [y,m]=val.split('-'); return {month:names[m],year:y}; }
      const [m,y] = val.split(' '); return {month:m,year:y};
    };
    const createBarChart = (div,title,data,uniform) => {
      if(!div) return;
      const chart = echarts.init(div);
      chart.setOption({
        title:{ text:title, left:'center', textStyle:{fontSize:16} },
        grid:{ top:50,left:50,right:50,bottom:50 },
        tooltip:{}, xAxis:{ type:'category', data:data.map(d=>d.label), axisLabel:{rotate:30} },
        yAxis:{ type:'value', min:0, max:5 },
        series:[{ type:'bar', data:data.map(d=>d.avg),
          label:{show:true,position:'top',formatter:'{c}'},
          itemStyle: uniform
            ? { color:'#6A99D0' }
            : { color: p=>{ const v=p.value; if(v<3)return'#EA3323'; if(v<4)return'#6A99D0'; return'#9FCE63'; } }
        }]
      });
      chart.resize(); setTimeout(()=>chart.resize(),300);
      return chart;
    };

    // ——— Build HTML report ———
    async function build() {
      const f = JSON.parse(localStorage.getItem('reportFilters')||'{}');
      const [data,meta] = await Promise.all([
        fetch('data.json').then(r=>r.json()),
        fetch('meta.json').then(r=>r.json())
      ]);
      const LM = createLabelMap(meta.labels), OM = createSortMap(meta.labels);
      const container = document.getElementById('report');
      container.innerHTML='';

      let timeScope = '';
      if(f.start && f.end){
        const s = formatMonthYear(f.start), e = formatMonthYear(f.end);
        timeScope = `${s.month} – ${e.month} ${e.year}`;
      }

      (f.programs||[]).forEach(prog=>{
        const all = data.filter(d=>
          (f.clients||[]).includes(d.client) &&
          d.program===prog &&
          (f.turmas||[]).includes(d.turma)
        );
        const pm = meta.titles.find(t=>t.program_id===prog)||{};

        // Hero
        const hero = document.createElement('div');
        hero.className='hero';
        hero.innerHTML = `
          <div class="hero-content">
            <small>${pm.SUBTÍTULO||''}</small>
            <h1>${pm.TÍTULO||prog}</h1>
            <div class="subtitle">${pm.TAGLINE||''}</div>
            <div class="meta">
              <span>time scope:</span><strong>${timeScope}</strong>
              <span>trainers:</span><strong>${(f.trainers||{})[prog]||'N/A'}</strong>
            </div>
          </div>
        `;
        container.appendChild(hero);

        ['assessment','evaluation'].forEach(sec=>{
          const name = sec==='assessment' ? 'Assessment' : 'Avaliação do Programa';
          const uniq = countUnique(all,sec);
          const numeric = all.filter(d=>
            String(d.section||'').toLowerCase().includes(sec) &&
            /^\d+(\.\d+)?$/.test(String(d.value).trim())
          );
          const byTurma = Object.entries(groupBy(numeric,'turma'));

          // Banner
          const ban = document.createElement('div');
          ban.className='banner';
          ban.innerHTML = `
            <div class="banner-box">
              <h1>${name}</h1>
              <div class="meta"><span>Total respostas:</span><strong>${uniq}</strong></div>
            </div>
          `;
          container.appendChild(ban);

          // Global chart
          if(numeric.length){
            const gf = document.createElement('div');
            gf.className='chart-fullpage';
            gf.innerHTML = `<div class="chart-full" id="chart-global-${prog}-${sec}"></div>`;
            container.appendChild(gf);
            createBarChart(
              gf.querySelector('.chart-full'),
              `Global (${name})`,
              computeAverages(numeric,LM,OM),
              sec==='evaluation'
            );
          }

          // By‐turma charts
          if(byTurma.length>1){
            const grid = document.createElement('div');
            grid.className='chart-grid';
            byTurma.forEach(([,vals],i)=>{
              const box = document.createElement('div');
              box.className='chart-box';
              box.id = `chart-${prog}-${sec}-${i}`;
              grid.appendChild(box);
            });
            container.appendChild(grid);
            byTurma.forEach(([,vals],i=>{
              createBarChart(
                document.getElementById(`chart-${prog}-${sec}-${i}`),
                byTurma[i][0],
                computeAverages(vals,LM,OM),
                sec==='evaluation'
              );
            }));
          }

          // Text questions
          const byQ = groupBy(
            all.filter(d=>
              String(d.section||'').toLowerCase().includes(sec) &&
              isNaN(parseFloat(d.value)) &&
              (f.textQuestions||[]).includes(d.question)),
            'question'
          );
          Object.entries(byQ).forEach(([q,answers])=>{
            const txt = document.createElement('div');
            txt.className='text-question';
            txt.innerHTML = `
              <div class="text-question-title">${q}</div>
              <ul>${answers.map(a=>`<li>${a.value}</li>`).join('')}</ul>
            `;
            container.appendChild(txt);
          });
        });
      });
    }

    // ——— Build PDF from content ———
    async function generatePdf(){
      await build(); // ensure charts exist
      // collect all chart images
      const charts = Array.from(document.querySelectorAll('.chart-full, .chart-box'));
      const images = charts.map(el=>{
        const c = echarts.getInstanceByDom(el);
        return c.getDataURL({ pixelRatio:2, backgroundColor:'#ffffff' });
      });

      // fetch logo for header
      const logoData = await fetch('mind4time-logo.png')
        .then(r=>r.blob())
        .then(blob=>new Promise(r=>{
          const fr = new FileReader();
          fr.onload = ()=>r(fr.result);
          fr.readAsDataURL(blob);
        }));

      // assemble PDF
      const doc = {
        pageSize: 'A4',
        pageOrientation: 'landscape',
        pageMargins: [40, 60, 40, 60],
        footer: (cp,pc)=>({
          columns:[
            { text:`© MIND4TIME ${currentYear}`, alignment:'left', fontSize:8 },
            { text:`Página ${cp}/${pc}`, alignment:'right', fontSize:8 }
          ], margin:[40,0,40,20]
        }),
        content: [],
        styles: {
          title: { fontSize:20, bold:true, margin:[0,0,0,10] },
          subtitle:{ fontSize:14, italics:true, margin:[0,0,0,10] },
          header: { fontSize:16, bold:true, margin:[0,10,0,5] }
        }
      };

      // re-iterate exactly as HTML build
      const f = JSON.parse(localStorage.getItem('reportFilters')||'{}');
      const [data,meta] = await Promise.all([
        fetch('data.json').then(r=>r.json()),
        fetch('meta.json').then(r=>r.json())
      ]);
      const LM = createLabelMap(meta.labels), OM = createSortMap(meta.labels);
      let imgIndex = 0;

      (f.programs||[]).forEach(prog=>{
        const all = data.filter(d=>(f.clients||[]).includes(d.client)&&d.program===prog&&(f.turmas||[]).includes(d.turma));
        const pm = meta.titles.find(t=>t.program_id===prog)||{};

        // cover page
        doc.content.push({ columns:[
          { image: logoData, width: 100 },
          { text: pm.TÍTULO||prog, style:'title', alignment:'right' }
        ]});
        doc.content.push({ text: pm.SUBTÍTULO||'', style:'subtitle' });
        doc.content.push({ text: pm.TAGLINE||'', margin:[0,0,0,20] });

        ['assessment','evaluation'].forEach(sec=>{
          const name = sec==='assessment'?'Assessment':'Avaliação do Programa';
          const uniq = countUnique(all,sec);
          const numeric = all.filter(d=>String(d.section||'').toLowerCase().includes(sec)&&/^\d+(\.\d+)?$/.test(String(d.value).trim()));
          const byTurma = Object.entries(groupBy(numeric,'turma'));

          // banner text
          doc.content.push({ text: name, style:'header' });
          doc.content.push({
            columns:[
              `Total respostas: ${uniq}`
            ], columnGap: 20
          });

          // global chart
          if(numeric.length){
            doc.content.push({
              image: images[imgIndex++],
              width: 500,
              margin:[0,10,0,20]
            });
          }

          // turma charts
          if(byTurma.length>1){
            const cols = byTurma.map(_=>({
              image: images[imgIndex++], width: (500/byTurma.length), margin:[0,0,10,10]
            }));
            doc.content.push({ columns: cols, columnGap:10, margin:[0,0,0,20] });
          }

          // text questions
          const byQ = groupBy(all.filter(d=>String(d.section||'').toLowerCase().includes(sec)&&isNaN(parseFloat(d.value))&&(f.textQuestions||[]).includes(d.question)),'question');
          Object.entries(byQ).forEach(([q,answers])=>{
            doc.content.push({ text: q, style:'header' });
            doc.content.push({ ul: answers.map(a=>a.value), margin:[0,0,0,20] });
          });
        });

        doc.content.push({ text:'', pageBreak:'after' });
      });

      pdfMake.createPdf(doc).download('report.pdf');
    }

    document.addEventListener('DOMContentLoaded',async()=>{
      await build();
      document.getElementById('gerar-pdf').addEventListener('click', generatePdf);
    });
  </script>
</body>
</html>
